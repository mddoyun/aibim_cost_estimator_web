<!--templates/ai_prediction/prediction.html-->

{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <title>AI ì˜ˆì¸¡ - {{ ai_model.name }}</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="{% static 'css/main.css'%}" />
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  </head>
  <body class="is-preload">
    <div id="page-wrapper">
      <!-- Header -->
      <div id="header">
        <!-- Logo -->
        <h1>
          <a href="/" id="logo">AIBIM <em>Cost Estimator</em></a>
        </h1>

        <!-- Nav -->
        <nav id="nav">
          <ul>
            <li><a href="/">í™ˆ</a></li>
            <li class="current">
              <a href="#">ê³„íšì„¤ê³„ë‹¨ê³„ ê²¬ì </a>
              <ul>
                <li>
                  <a href="/ai_prediction/">AI ê°œì‚°ê²¬ì </a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#">ì¤‘ê°„ì„¤ê³„ë‹¨ê³„ ê²¬ì </a>
              <ul>
                <li>
                  <a href="/ifc_ai_prediction/">AI+BIM ê°œì‚°ê²¬ì (IFCê¸°ë°˜)</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#">ì‹¤ì‹œì„¤ê³„ë‹¨ê³„ ê²¬ì </a>
              <ul>
                <li>
                  <a href="/dd_by_ifc/">AI+BIM ìƒì„¸ê²¬ì (IFCê¸°ë°˜)</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/ai_learning">AIëª¨ë¸ í•™ìŠµ</a>
            </li>
          </ul>
        </nav>
      </div>

      <!-- Main Content -->
      <div class="container mt-4">
        <div class="row">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">{{ ai_model.name }} - ì˜ˆì¸¡</h5>
                <small class="text-muted">{{ ai_model.description }}</small>
              </div>
              <div class="card-body">
                <!-- ëª¨ë¸ ë¡œë”© ìƒíƒœ -->
                <div id="modelLoadingStatus" class="text-center mb-3">
                  <div class="spinner-border text-primary" role="status"></div>
                  <div class="mt-2">AI ëª¨ë¸ì„ ë¡œë“œí•˜ëŠ” ì¤‘...</div>
                </div>

                <!-- ì…ë ¥ í¼ -->
                <div id="inputForm" style="display: none">
                  <h6>ì…ë ¥ ë°ì´í„°</h6>
                  <form id="predictionForm">
                    <div id="inputFields"></div>
                    <button type="submit" class="btn btn-primary mt-3">
                      ì˜ˆì¸¡ ì‹¤í–‰
                    </button>
                  </form>
                </div>

                <!-- ì˜ˆì¸¡ ê²°ê³¼ -->
                <!-- ê¸°ì¡´ ì˜ˆì¸¡ ê²°ê³¼ ì„¹ì…˜ì„ ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•˜ì„¸ìš” -->
                <!-- ê¸°ì¡´ ì½”ë“œ -->
                <div id="predictionResult" style="display: none">
                  <hr />
                  <h6>ì˜ˆì¸¡ ê²°ê³¼</h6>
                  <div id="resultContent"></div>
                  <div
                    id="resultChart"
                    style="height: 300px; margin-top: 20px"
                  ></div>

                  <!-- ì´ ë¶€ë¶„ ì¶”ê°€ -->
                  <div class="text-center mt-3">
                    <button
                      type="button"
                      class="btn btn-danger"
                      id="downloadPdfBtn"
                      onclick="downloadPDF()"
                    >
                      ğŸ“„ PDF ë³´ê³ ì„œ ë‹¤ìš´ë¡œë“œ
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <!-- ëª¨ë¸ ì •ë³´ -->
            <div class="card mb-3">
              <div class="card-header">
                <h6 class="mb-0">ëª¨ë¸ ì •ë³´</h6>
              </div>
              <div class="card-body">
                <div class="mb-2">
                  <strong>ì…ë ¥ ë³€ìˆ˜:</strong><br />
                  <span class="text-muted"
                    >{{ ai_model.input_columns|join:", " }}</span
                  >
                </div>
                <div class="mb-2">
                  <strong>ì¶œë ¥ ë³€ìˆ˜:</strong><br />
                  <span class="text-muted"
                    >{{ ai_model.output_columns|join:", " }}</span
                  >
                </div>
                <div class="mb-2">
                  <strong>ìƒì„±ì¼:</strong><br />
                  <span class="text-muted"
                    >{{ ai_model.created_at|date:"Y-m-d H:i" }}</span
                  >
                </div>
                <div id="modelMetrics" style="display: none">
                  <hr />
                  <h6>ëª¨ë¸ ì„±ëŠ¥</h6>
                  <div class="small">
                    <div>RMSE: <span id="rmseValue">-</span></div>
                    <div>MAE: <span id="maeValue">-</span></div>
                    <div>RÂ² Score: <span id="r2Value">-</span></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ìµœê·¼ ì˜ˆì¸¡ ì´ë ¥ -->
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">ìµœê·¼ ì˜ˆì¸¡ ì´ë ¥</h6>
              </div>
              <div class="card-body">
                {% if recent_predictions %}
                <div class="small">
                  {% for prediction in recent_predictions %}
                  <div class="mb-2 p-2 border rounded">
                    <div class="text-muted">
                      {{ prediction.created_at|date:"m/d H:i" }}
                    </div>
                    <div>
                      ê²°ê³¼: {{ prediction.prediction_result.value|floatformat:2
                      }}
                    </div>
                    <div class="text-muted">
                      ë²”ìœ„: {{ prediction.prediction_range.min|floatformat:2 }}
                      ~ {{ prediction.prediction_range.max|floatformat:2 }}
                    </div>
                  </div>
                  {% endfor %}
                </div>
                {% else %}
                <p class="text-muted small">ì˜ˆì¸¡ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let loadedModel = null;
      let modelMetadata = null;
      let resultChart = null;
      let lastPredictionData = null; // PDF ìƒì„±ìš© ë°ì´í„° ì €ì¥

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë¸ ë¡œë“œ
      window.addEventListener("load", async function () {
        try {
          await loadAIModel();
          document.getElementById("modelLoadingStatus").style.display = "none";
          document.getElementById("inputForm").style.display = "block";
          document.getElementById("modelMetrics").style.display = "block";
        } catch (error) {
          console.error("ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨:", error);
          document.getElementById("modelLoadingStatus").innerHTML =
            '<div class="alert alert-danger">ëª¨ë¸ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' +
            error.message +
            "</div>";
        }
      });

      async function loadAIModel() {
        // ëª¨ë¸ ë©”íƒ€ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await fetch(
          `/ai_prediction/api/model_metadata/{{ ai_model.id }}/`
        );
        modelMetadata = await response.json();

        // ëª¨ë¸ ì„±ëŠ¥ ë©”íŠ¸ë¦­ í‘œì‹œ
        if (modelMetadata.rmse) {
          document.getElementById("rmseValue").textContent =
            modelMetadata.rmse.toFixed(4);
          document.getElementById("maeValue").textContent =
            modelMetadata.mae.toFixed(4);
          document.getElementById("r2Value").textContent =
            modelMetadata.r2_score.toFixed(4);
        }

        // ZIP íŒŒì¼ì—ì„œ ëª¨ë¸ ë¡œë“œ
        const modelResponse = await fetch(modelMetadata.model_file_url);
        const zipBlob = await modelResponse.blob();

        const zip = new JSZip();
        const zipContent = await zip.loadAsync(zipBlob);

        // model.json ì½ê¸°
        const modelJson = await zipContent.file("model.json").async("string");
        const modelTopology = JSON.parse(modelJson);

        // weights.bin ì½ê¸°
        const weightsData = await zipContent
          .file("weights.bin")
          .async("uint8array");

        // TensorFlow.js ëª¨ë¸ ë¡œë“œ
        loadedModel = await tf.loadLayersModel(
          tf.io.fromMemory(modelTopology, weightsData)
        );

        // ì…ë ¥ í•„ë“œ ìƒì„±
        createInputFields();
      }

      function createInputFields() {
        const container = document.getElementById("inputFields");
        container.innerHTML = "";

        modelMetadata.input_columns.forEach((column) => {
          const div = document.createElement("div");
          div.className = "mb-3";
          div.innerHTML = `
                    <label for="input_${column}" class="form-label">${column}</label>
                    <input type="number" class="form-control" id="input_${column}" 
                           name="${column}" step="any" required>
                `;
          container.appendChild(div);
        });
      }

      document
        .getElementById("predictionForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // ì…ë ¥ ë°ì´í„° ìˆ˜ì§‘
          const inputData = {};
          modelMetadata.input_columns.forEach((column) => {
            const input = document.getElementById(`input_${column}`);
            inputData[column] = parseFloat(input.value);
          });

          // ì˜ˆì¸¡ ì‹¤í–‰
          const inputArray = modelMetadata.input_columns.map(
            (col) => inputData[col]
          );
          const inputTensor = tf.tensor2d([inputArray]);

          const prediction = await loadedModel.predict(inputTensor);
          const predictionArray = await prediction.data();
          const predictionValue = predictionArray[0];

          // ì˜¤ì°¨ ë²”ìœ„ ê³„ì‚°
          const errorRange = calculateErrorRange(predictionValue);

          // ê²°ê³¼ í‘œì‹œ
          displayResults(predictionValue, errorRange, inputData);

          // ì˜ˆì¸¡ ê²°ê³¼ ì €ì¥
          await savePrediction(inputData, predictionValue, errorRange);

          // ë©”ëª¨ë¦¬ ì •ë¦¬
          inputTensor.dispose();
          prediction.dispose();
        });

      function calculateErrorRange(prediction) {
        // RMSEì™€ MAEë¥¼ í™œìš©í•œ ì˜¤ì°¨ ë²”ìœ„ ê³„ì‚°
        const rmse = modelMetadata.rmse || 0;
        const mae = modelMetadata.mae || 0;

        // ë³´ìˆ˜ì ì¸ ì¶”ì •ì„ ìœ„í•´ RMSEì˜ 1.5ë°°ë¥¼ ì˜¤ì°¨ ë²”ìœ„ë¡œ ì‚¬ìš©
        const errorMargin = rmse * 1.5;

        return {
          min: Math.max(0, prediction - errorMargin),
          max: prediction + errorMargin,
          confidence: Math.max(0, Math.min(1, 1 - rmse / prediction)),
        };
      }

      function displayResults(prediction, errorRange, inputData) {
        const resultContent = document.getElementById("resultContent");
        const outputColumn = modelMetadata.output_columns[0];

        // PDF ìƒì„±ìš© ë°ì´í„° ì €ì¥
        lastPredictionData = {
          inputData: inputData,
          prediction: prediction,
          errorRange: errorRange,
          outputColumn: outputColumn,
        };

        resultContent.innerHTML = `
                <div class="alert alert-info">
                    <h5>ì˜ˆì¸¡ ê²°ê³¼</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <strong>ì˜ˆì¸¡ê°’</strong><br>
                            <span class="h4 text-primary">${prediction.toFixed(
                              2
                            )}</span>
                        </div>
                        <div class="col-md-4">
                            <strong>ìµœì†Œê°’</strong><br>
                            <span class="h5 text-secondary">${errorRange.min.toFixed(
                              2
                            )}</span>
                        </div>
                        <div class="col-md-4">
                            <strong>ìµœëŒ€ê°’</strong><br>
                            <span class="h5 text-secondary">${errorRange.max.toFixed(
                              2
                            )}</span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            ì‹ ë¢°ë„: ${(errorRange.confidence * 100).toFixed(1)}%
                            (RMSE: ${modelMetadata.rmse.toFixed(4)})
                        </small>
                    </div>
                </div>
            `;

        // ì°¨íŠ¸ í‘œì‹œ
        displayChart(prediction, errorRange);

        document.getElementById("predictionResult").style.display = "block";
      }

      function displayChart(prediction, errorRange) {
        const ctx = document.getElementById("resultChart");

        if (resultChart) {
          resultChart.destroy();
        }

        // Canvas ìš”ì†Œ ìƒì„±
        ctx.innerHTML = '<canvas id="chartCanvas"></canvas>';
        const canvas = document.getElementById("chartCanvas");

        resultChart = new Chart(canvas, {
          type: "bar",
          data: {
            labels: ["ì˜ˆì¸¡ ê²°ê³¼"],
            datasets: [
              {
                label: "ìµœì†Œê°’",
                data: [errorRange.min],
                backgroundColor: "rgba(255, 99, 132, 0.5)",
                borderColor: "rgba(255, 99, 132, 1)",
                borderWidth: 1,
              },
              {
                label: "ì˜ˆì¸¡ê°’",
                data: [prediction],
                backgroundColor: "rgba(54, 162, 235, 0.8)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 2,
              },
              {
                label: "ìµœëŒ€ê°’",
                data: [errorRange.max],
                backgroundColor: "rgba(255, 206, 86, 0.5)",
                borderColor: "rgba(255, 206, 86, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      async function savePrediction(inputData, prediction, errorRange) {
        const data = {
          input_data: inputData,
          prediction_result: { value: prediction },
          prediction_range: errorRange,
        };

        try {
          await fetch(`/ai_prediction/api/save_prediction/{{ ai_model.id }}/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });
        } catch (error) {
          console.error("ì˜ˆì¸¡ ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨:", error);
        }
      }

      // PDF ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
      async function downloadPDF() {
        if (!lastPredictionData) {
          alert("ì˜ˆì¸¡ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì˜ˆì¸¡ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.");
          return;
        }

        // ë²„íŠ¼ê³¼ ì›ë˜ HTMLì„ try ë°”ê¹¥ì—ì„œ ì¡ì•„ë‘ê¸°
        const btn = document.getElementById("downloadPdfBtn");
        const originalHtml = btn.innerHTML;

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        btn.innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status"></span> PDF ìƒì„± ì¤‘...';
        btn.disabled = true;

        try {
          // ì°¨íŠ¸ ì´ë¯¸ì§€ë¥¼ base64ë¡œ ì¶”ì¶œ
          const chartImage = await getChartAsImage();

          // ì„œë²„ì— PDF ìƒì„± ìš”ì²­
          const pdfData = {
            input_data: lastPredictionData.inputData,
            prediction_result: { value: lastPredictionData.prediction },
            prediction_range: lastPredictionData.errorRange,
            chart_image: chartImage,
          };

          const response = await fetch(
            `/ai_prediction/api/generate_pdf/{{ ai_model.id }}/`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(pdfData),
            }
          );

          if (!response.ok) {
            const error = await response.json();
            alert("PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.error);
            return; // ì‹¤íŒ¨ ì‹œ ì¡°ê¸° ì¢…ë£Œ
          }

          // ì„±ê³µ: PDF ë‹¤ìš´ë¡œë“œ
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `prediction_report_${new Date()
            .toISOString()
            .slice(0, 10)}.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (err) {
          console.error("PDF ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:", err);
          alert("PDF ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
          // ë²„íŠ¼ ìƒíƒœ ë³µì›
          btn.innerHTML = originalHtml;
          btn.disabled = false;
        }
      }

      // ì°¨íŠ¸ë¥¼ base64 ì´ë¯¸ì§€ë¡œ ë³€í™˜
      async function getChartAsImage() {
        return new Promise((resolve) => {
          if (!resultChart) {
            resolve("");
            return;
          }

          const canvas = document.getElementById("chartCanvas");
          if (!canvas) {
            resolve("");
            return;
          }

          // ì°¨íŠ¸ë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
          const imageData = canvas.toDataURL("image/png");
          resolve(imageData);
        });
      }
    </script>
    <!-- Scripts -->
    <script src="{% static 'js/jquery.min.js'%}"></script>
    <script src="{% static 'js/jquery.dropotron.min.js'%}"></script>
    <script src="{% static 'js/browser.min.js'%}"></script>
    <script src="{% static 'js/breakpoints.min.js'%}"></script>
    <script src="{% static 'js/util.js'%}"></script>
    <script src="{% static 'js/main.js'%}"></script>
  </body>
</html>
