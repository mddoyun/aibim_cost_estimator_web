<!--templates/dd_by_ifc/project_detail.html-->

{% load static %}
<!DOCTYPE html>
<!--  AIBIM Costâ€‘Estimator â€“ ìƒì„¸ê²¬ì (DD) ì‘ì—… í˜ì´ì§€  -->
<html>
  <head>
    <title>{{ project.name }} - ìƒì„¸ê²¬ì  ì‘ì—…</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />

    <!-- three.js / OrbitControls ES module importmap -->
    <script type="importmap">
      {
        "imports": {
          "three": "{% static 'js/three.module.js' %}",
          "three/examples/jsm/controls/OrbitControls.js": "{% static 'js/OrbitControls.js' %}"
        }
      }
    </script>
    <script
      async
      src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"
    ></script>

    <!-- Pyodide + IfcOpenShell WASM -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.22.0a1/full/pyodide.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/style_dd_by_ifc.css' %}" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />
  </head>

  <body class="is-preload" data-project-id="{{ project.id }}">
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ & ë©”ë‰´  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="page-wrapper">
      <!-- Header -->
      <div id="header">
        <!-- Logo -->
        <h1>
          <a href="/" id="logo">AIBIM <em>Cost Estimator</em></a>
        </h1>

        <!-- Nav -->
        <nav id="nav">
          <ul>
            <li><a href="/">í™ˆ</a></li>
            <li>
              <a href="#">ê³„íšì„¤ê³„ë‹¨ê³„ ê²¬ì </a>
              <ul>
                <li>
                  <a href="/ai_prediction/">AI ê°œì‚°ê²¬ì </a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#">ì¤‘ê°„ì„¤ê³„ë‹¨ê³„ ê²¬ì </a>
              <ul>
                <li>
                  <a href="/ifc_ai_prediction/">AI+BIM ê°œì‚°ê²¬ì (IFCê¸°ë°˜)</a>
                </li>
              </ul>
            </li>
            <li class="current">
              <a href="#">ì‹¤ì‹œì„¤ê³„ë‹¨ê³„ ê²¬ì </a>
              <ul>
                <li>
                  <a href="/dd_by_ifc/">AI+BIM ìƒì„¸ê²¬ì (IFCê¸°ë°˜)</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/ai_learning">AIëª¨ë¸ í•™ìŠµ</a>
            </li>
          </ul>
        </nav>
      </div>
      <div id="nav_sub">
        <h6 class="text-center">
          <b>{{ project.name }}</b> <span>- ìƒì„¸ê²¬ì  ì‘ì—…</span>
        </h6>
        <div class="text-center">
          <a
            href="{% url 'dd_by_ifc:project_list' %}"
            class="btn btn-sm btn-outline-light"
          >
            â† í”„ë¡œì íŠ¸ ëª©ë¡
          </a>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  3D Viewer  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="view-container"><div id="viewer"></div></div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  ì „ì²´ ì½”ë“œ ìš”ì•½ í…Œì´ë¸”  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="container" id="first_container">
      <div id="result_container">
        <div style="font-weight: bold">ì „ì²´ ì½”ë“œ ìš”ì•½</div>
        <table class="summary-table" id="summaryTable">
          <thead>
            <tr>
              <th>ê³µì‚¬ì½”ë“œ</th>
              <th>ê³µì¢…</th>
              <th>ëª…ì¹­</th>
              <th>ê·œê²©</th>
              <th>ë‹¨ìœ„</th>
              <th>ìˆ˜ëŸ‰</th>
              <th>ì¬ë£Œë¹„</th>
              <th>ë…¸ë¬´ë¹„</th>
              <th>ì´ê¸ˆì•¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="summary-total-label" id="summaryTotalLabel">
          ìš”ì•½ ì´ ê¸ˆì•¡: 0 ì›
        </div>
      </div>
    </div>

    <!-- í¼ì¹˜ê¸°/ì ‘ê¸° ë²„íŠ¼ -->
    <div>
      <button class="cnv_divide" id="folding_line" onclick="foldingAction()">
        í¼ì¹˜ê¸°
      </button>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  ìƒì„¸ íŒ¨ë„ (ì½”ë“œ ê²€ìƒ‰, ê·¸ë£¹í•‘, ìƒì„¸ í…Œì´ë¸”)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="container_detail_first" style="display: none">
      <div class="container_detail">
        <!-- ì¢Œì¸¡ íŒ¨ë„ -->
        <div class="left-panel">
          <ul class="search-results" id="searchResults"></ul>
          <input type="text" id="searchBox" placeholder="ê³µì‚¬ì½”ë“œ ê²€ìƒ‰" />
          <button class="btn" id="addCodeBtn">ê³µì‚¬ì½”ë“œ ì¶”ê°€</button>
          <button class="btn" id="removeCodeBtn">ê³µì‚¬ì½”ë“œ ì‚­ì œ</button>
          <button class="btn" id="loadCodeBtn">ì½”ë“œë¦¬ìŠ¤íŠ¸ ì—´ê¸°</button>

          <!-- ì»¬ëŸ¼ ì„ íƒ ì˜ì—­ -->
          <div class="column-selector">
            <h4>í‘œì‹œí•  í•„ë“œ ì„ íƒ</h4>
            <div class="column-checkboxes" id="columnCheckboxes"></div>
            <div class="column-buttons">
              <button class="btn-small" id="selectAllColumnsBtn">
                ëª¨ë‘ ì„ íƒ
              </button>
              <button class="btn-small" id="deselectAllColumnsBtn">
                ëª¨ë‘ í•´ì œ
              </button>
            </div>
          </div>
        </div>

        <!-- ìš°ì¸¡ íŒ¨ë„ -->
        <div class="right-panel">
          <div class="group-bar">
            <label
              >1ë‹¨ê³„ ê·¸ë£¹:
              <select id="groupBy1">
                <option>ì—†ìŒ</option>
              </select>
            </label>
            <label
              >2ë‹¨ê³„ ê·¸ë£¹:
              <select id="groupBy2">
                <option>ì—†ìŒ</option>
              </select>
            </label>
            <label
              >3ë‹¨ê³„ ê·¸ë£¹:
              <select id="groupBy3">
                <option>ì—†ìŒ</option>
              </select>
            </label>
          </div>
          <div
            class="ifc-table"
            id="ifcTablecontainer_"
            style="max-height: 400px; overflow-y: auto"
          ></div>
        </div>
      </div>

      <!-- ìƒì„¸ ì½”ë“œë³„ ìˆ˜ëŸ‰/ê¸ˆì•¡ -->
      <div class="container_detail">
        <table class="code-detail-table" id="codeDetailTable">
          <thead>
            <tr>
              <th>ê³µì‚¬ì½”ë“œ</th>
              <th>ëª…ì¹­</th>
              <th>ê·œê²©</th>
              <th>ë‹¨ìœ„</th>
              <th>ì‚°ì‹</th>
              <th>ìˆ˜ëŸ‰</th>
              <th>ë‹¨ê°€</th>
              <th>ê¸ˆì•¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="total-label" id="totalLabel">ì´ ê¸ˆì•¡: 0 ì›</div>
        <div style="height: 12px"></div>
      </div>

      <!-- ìˆ˜ì •ëœ IFC ë‹¤ìš´ë¡œë“œ -->
      <div>
        <button class="btn-block" id="saveIFCBtn">
          ìˆ˜ì •ëœ IFC íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        </button>
      </div>
    </div>

    <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ -->
    <div>
      <div class="container">
        <div class="top-bar"></div>
        <div class="container_"></div>
        <input type="file" id="codeFileInput" accept=".csv" class="hidden" />
        <input type="file" id="ifcFileInput" accept=".ifc" class="hidden" />
      </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  ê³µí†µ JS (jQuery ë“±)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <script src="{% static 'js/jquery.min.js'%}"></script>
    <script src="{% static 'js/jquery.dropotron.min.js'%}"></script>
    <script src="{% static 'js/browser.min.js'%}"></script>
    <script src="{% static 'js/breakpoints.min.js'%}"></script>
    <script src="{% static 'js/util.js'%}"></script>
    <script src="{% static 'js/main.js'%}"></script>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  í¼ì¹˜ê¸°/ì ‘ê¸° í•¨ìˆ˜  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <script>
      function foldingAction() {
        const el = document.getElementById("container_detail_first");
        if (el.style.display === "block" || el.style.display === "") {
          el.style.display = "none";
          document.getElementById("folding_line").innerText = "í¼ì¹˜ê¸°";
        } else {
          el.style.display = "block";
          document.getElementById("folding_line").innerText = "ì ‘ê¸°";
        }
      }
    </script>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  ê²¬ì /ì½”ë“œ UI ìŠ¤í¬ë¦½íŠ¸ (ìˆ˜ì •ëœ API ê²½ë¡œ)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <script>
      // ì „ì—­ ë³€ìˆ˜
      const PROJECT_ID = parseInt(document.body.dataset.projectId) || 0;
      let codeData = {};
      let objectData = [];
      let groupedObjects = [];
      let collapsedGroups = new Set();
      let selectedCode = null;
      let selectedObjectIds = [];
      let headers = [];
      let visibleHeaders = []; // í‘œì‹œí•  í—¤ë”ë“¤

      // í˜ì´ì§€ ë¡œë”© ì‹œ ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€
      document.addEventListener("DOMContentLoaded", function () {
        // ê¸°ì¡´ ì´ˆê¸°í™” í•¨ìˆ˜ë“¤
        loadDefaultCostCodes();
        loadIFCObjects();
        loadSummaryTable();
        setupEventHandlers();

        // ì‚¬ìš©ë²• ì•ˆë‚´ë¥¼ ìœ„í•œ íˆ´íŒ ì¶”ê°€
        const saveBtn = document.getElementById("saveIFCBtn");
        if (saveBtn) {
          saveBtn.title =
            "ê³µì‚¬ì½”ë“œê°€ ë°˜ì˜ëœ ìƒˆë¡œìš´ IFC íŒŒì¼ì„ ìƒì„±í•˜ì—¬ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤. ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";

          // ë²„íŠ¼ í…ìŠ¤íŠ¸ë„ ë” ëª…í™•í•˜ê²Œ ë³€ê²½
          saveBtn.textContent = "ê³µì‚¬ì½”ë“œ ë°˜ì˜ IFC íŒŒì¼ ë‹¤ìš´ë¡œë“œ";
        }
      });

      // ê¸°ë³¸ ì½”ë“œë¦¬ìŠ¤íŠ¸ ë¡œë“œ
      function loadDefaultCostCodes() {
        fetch("{% static 'references/CodeList.csv' %}")
          .then((res) => {
            if (!res.ok) {
              console.log("ê¸°ë³¸ CodeList.csv íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
              return;
            }
            return res.text();
          })
          .then((text) => {
            if (text) {
              parseCostCodesFromCSV(text);
              // ì„œë²„ì— ìë™ ì—…ë¡œë“œ
              uploadParsedCodesToServer();
              console.log(
                "ê¸°ë³¸ ì½”ë“œë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì™„ë£Œ:",
                Object.keys(codeData).length + "ê±´"
              );
            }
          })
          .catch((err) => console.error("ê¸°ë³¸ ì½”ë“œë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:", err));
      }

      // íŒŒì‹±ëœ ì½”ë“œë¥¼ ì„œë²„ì— ì—…ë¡œë“œ (API ê²½ë¡œ ìˆ˜ì •)
      function uploadParsedCodesToServer() {
        if (Object.keys(codeData).length === 0) return;

        console.log(
          "ğŸ“¤ ì„œë²„ì— ê³µì‚¬ì½”ë“œ ì—…ë¡œë“œ ì‹œë„ ì¤‘...",
          Object.keys(codeData).length + "ê±´"
        );

        // CSV í˜•íƒœë¡œ ë³€í™˜
        const csvLines = [
          "ì½”ë“œ,ê³µì¢…,ëª…ì¹­,ê·œê²©,ë‹¨ìœ„,ì‚°ì‹,ì¬ë£Œë¹„ë‹¨ê°€,ë…¸ë¬´ë¹„ë‹¨ê°€,ê²½ë¹„ë‹¨ê°€,í•©ê³„ë‹¨ê°€",
        ];
        Object.entries(codeData).forEach(([code, data]) => {
          const line = [
            code,
            data["ê³µì¢…"] || "",
            data["ëª…ì¹­"] || "",
            data["ê·œê²©"] || "",
            data["ë‹¨ìœ„"] || "",
            data["ì‚°ì‹"] || "",
            data["ì¬ë£Œë¹„ë‹¨ê°€"] || "0",
            data["ë…¸ë¬´ë¹„ë‹¨ê°€"] || "0",
            data["ê²½ë¹„ë‹¨ê°€"] || "0",
            data["í•©ê³„ë‹¨ê°€"] || "0",
          ].join(",");
          csvLines.push(line);
        });

        const csvContent = csvLines.join("\n");
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });

        const formData = new FormData();
        formData.append("csv_file", blob, "CodeList.csv");

        fetch("/dd_by_ifc/api/load_cost_codes/", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log("âœ… ì„œë²„ì— ê³µì‚¬ì½”ë“œ ì—…ë¡œë“œ ì™„ë£Œ:", data.message);
              console.log("ğŸ“Š ì „ì²´ ê³µì‚¬ì½”ë“œ ìˆ˜:", data.total_codes + "ê°œ");
            } else {
              console.warn("âš ï¸ ê³µì‚¬ì½”ë“œ ì—…ë¡œë“œ ì¤‘ ë¬¸ì œ:", data.error);
            }
          })
          .catch((error) => {
            console.error("âŒ ì„œë²„ ì—…ë¡œë“œ ì‹¤íŒ¨:", error);
          });
      }

      // CSV í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•˜ì—¬ codeData ê°ì²´ ìƒì„±
      function parseCostCodesFromCSV(csvText) {
        const lines = csvText.split(/\r?\n/).filter((x) => x.trim());
        if (lines.length < 2) return;

        const cols = lines[0].split(",").map((x) => x.trim());
        codeData = {};

        for (let i = 1; i < lines.length; i++) {
          const row = lines[i].split(",").map((x) => x.trim());
          const code = row[cols.indexOf("ì½”ë“œ")];
          if (!code) continue;

          codeData[code] = {};
          cols.forEach((col, j) => {
            codeData[code][col] = row[j] || "";
          });
        }
      }

      // IFC ê°ì²´ ë°ì´í„° ë¡œë“œ (API ê²½ë¡œ ìˆ˜ì •)
      function loadIFCObjects() {
        fetch(`/dd_by_ifc/api/ifc_objects/${PROJECT_ID}/`)
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            objectData = data.objects;
            headers = data.headers;
            updateGroupComboBoxes();
            updateColumnSelector();
            updateGroupedTable();
            console.log(`âœ… IFC ê°ì²´ ë¡œë“œ ì™„ë£Œ: ${data.total_count}ê°œ`);
          })
          .catch((error) => {
            console.error("âŒ IFC ê°ì²´ ë¡œë“œ ì‹¤íŒ¨:", error);
            alert("IFC ê°ì²´ë¥¼ ë¡œë“œí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
          });
      }

      // ìš”ì•½ í…Œì´ë¸” ë¡œë“œ (API ê²½ë¡œ ìˆ˜ì •)
      function loadSummaryTable() {
        fetch(`/dd_by_ifc/api/summary_table/${PROJECT_ID}/`)
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            updateSummaryTableDisplay(data.summary_data);
            document.getElementById("summaryTotalLabel").textContent =
              "ìš”ì•½ ì´ ê¸ˆì•¡: " + data.total_sum.toLocaleString("ko-KR") + " ì›";
            console.log(`âœ… ìš”ì•½ í…Œì´ë¸” ë¡œë“œ ì™„ë£Œ`);
          })
          .catch((error) => {
            console.error("âŒ ìš”ì•½ í…Œì´ë¸” ë¡œë“œ ì‹¤íŒ¨:", error);
            alert("ìš”ì•½ í…Œì´ë¸”ì„ ë¡œë“œí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
          });
      }

      // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
      function setupEventHandlers() {
        // ê²€ìƒ‰ ê¸°ëŠ¥
        document
          .getElementById("searchBox")
          .addEventListener("input", searchCostCodes);

        // ë²„íŠ¼ ì´ë²¤íŠ¸
        document
          .getElementById("addCodeBtn")
          .addEventListener("click", addCostCodeToObjects);
        document
          .getElementById("removeCodeBtn")
          .addEventListener("click", removeCostCodeFromObjects);
        document.getElementById("loadCodeBtn").addEventListener("click", () => {
          document.getElementById("codeFileInput").click();
        });

        // íŒŒì¼ ì—…ë¡œë“œ
        document
          .getElementById("codeFileInput")
          .addEventListener("change", handleCostCodeFileUpload);

        // ê·¸ë£¹ ì½¤ë³´ë°•ìŠ¤
        for (let i = 1; i <= 3; i++) {
          document
            .getElementById("groupBy" + i)
            .addEventListener("change", updateGroupedTable);
        }

        // ì»¬ëŸ¼ ì„ íƒ ë²„íŠ¼ë“¤
        document
          .getElementById("selectAllColumnsBtn")
          .addEventListener("click", () => selectAllColumns(true));
        document
          .getElementById("deselectAllColumnsBtn")
          .addEventListener("click", () => selectAllColumns(false));
      }

      // ê³µì‚¬ì½”ë“œ ê²€ìƒ‰
      function searchCostCodes() {
        const query = document
          .getElementById("searchBox")
          .value.trim()
          .toLowerCase();
        const resultsContainer = document.getElementById("searchResults");
        resultsContainer.innerHTML = "";

        if (!query || Object.keys(codeData).length === 0) return;

        Object.entries(codeData).forEach(([code, data]) => {
          if (
            code.toLowerCase().includes(query) ||
            (data["ëª…ì¹­"] || "").toLowerCase().includes(query)
          ) {
            const li = document.createElement("li");
            li.textContent = `${code} - ${data["ëª…ì¹­"]} (${data["ê·œê²©"]}, ${data["ë‹¨ìœ„"]})`;
            li.onclick = () => selectCostCode(code, li);
            resultsContainer.appendChild(li);
          }
        });
      }

      // ê³µì‚¬ì½”ë“œ ì„ íƒ
      function selectCostCode(code, element) {
        document
          .querySelectorAll("#searchResults li")
          .forEach((li) => li.classList.remove("selected"));
        element.classList.add("selected");
        selectedCode = code;
      }

      // ê·¸ë£¹ ì½¤ë³´ë°•ìŠ¤ ì—…ë°ì´íŠ¸
      function updateGroupComboBoxes() {
        for (let i = 1; i <= 3; i++) {
          const combo = document.getElementById("groupBy" + i);
          const currentValue = combo.value;
          combo.innerHTML = "<option>ì—†ìŒ</option>";

          // í—¤ë”ë“¤ì„ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
          const sortedHeaders = [...headers].sort((a, b) => a.localeCompare(b));

          sortedHeaders.forEach((header) => {
            const option = document.createElement("option");
            option.value = header;
            option.textContent = header;
            combo.appendChild(option);
          });

          if (currentValue && headers.includes(currentValue)) {
            combo.value = currentValue;
          }
        }
      }

      // ì»¬ëŸ¼ ì„ íƒ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
      function updateColumnSelector() {
        const container = document.getElementById("columnCheckboxes");
        container.innerHTML = "";

        // ê¸°ë³¸ì ìœ¼ë¡œ ì²˜ìŒ 6ê°œ ì»¬ëŸ¼ë§Œ ì„ íƒ
        const defaultVisibleColumns = [
          "GlobalId",
          "Name",
          "IfcClass",
          "CostItems",
          "ì´ê¸ˆì•¡",
          "SpatialContainer",
        ];

        if (visibleHeaders.length === 0) {
          visibleHeaders = headers.filter((h) =>
            defaultVisibleColumns.includes(h)
          );
        }

        headers.forEach((header) => {
          const div = document.createElement("div");
          div.className = "column-checkbox";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `col_${header}`;
          checkbox.value = header;
          checkbox.checked = visibleHeaders.includes(header);
          checkbox.addEventListener("change", handleColumnToggle);

          const label = document.createElement("label");
          label.htmlFor = `col_${header}`;
          label.textContent = header;

          div.appendChild(checkbox);
          div.appendChild(label);
          container.appendChild(div);
        });
      }

      // ì»¬ëŸ¼ í† ê¸€ ì²˜ë¦¬
      function handleColumnToggle() {
        const checkedBoxes = document.querySelectorAll(
          '#columnCheckboxes input[type="checkbox"]:checked'
        );
        visibleHeaders = Array.from(checkedBoxes).map((cb) => cb.value);
        updateGroupedTable();
      }

      // ëª¨ë“  ì»¬ëŸ¼ ì„ íƒ/í•´ì œ
      function selectAllColumns(select) {
        const checkboxes = document.querySelectorAll(
          '#columnCheckboxes input[type="checkbox"]'
        );
        checkboxes.forEach((cb) => (cb.checked = select));
        handleColumnToggle();
      }

      // ê·¸ë£¹í™”ëœ í…Œì´ë¸” ì—…ë°ì´íŠ¸
      function updateGroupedTable() {
        const container = document.getElementById("ifcTablecontainer_");
        container.innerHTML = "";

        // ê·¸ë£¹ ê¸°ì¤€ ìˆ˜ì§‘
        const groupKeys = [];
        for (let i = 1; i <= 3; i++) {
          const value = document.getElementById("groupBy" + i).value;
          if (value !== "ì—†ìŒ") groupKeys.push(value);
        }

        // í…Œì´ë¸” ìƒì„±
        const table = document.createElement("table");
        table.className = "ifc-objects-table";

        // í—¤ë”
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");

        // ì²´í¬ë°•ìŠ¤ í—¤ë”
        const checkboxHeader = document.createElement("th");
        checkboxHeader.innerHTML =
          '<input type="checkbox" id="selectAllCheckbox">';
        headerRow.appendChild(checkboxHeader);

        // ë³´ì´ëŠ” í—¤ë”ë“¤ë§Œ í‘œì‹œ
        visibleHeaders.forEach((header) => {
          const th = document.createElement("th");
          th.textContent = header.split(".").pop(); // ë§ˆì§€ë§‰ ë¶€ë¶„ë§Œ í‘œì‹œ
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        if (groupKeys.length === 0) {
          // ê·¸ë£¹í™” ì—†ìŒ - ì§ì ‘ í‘œì‹œ
          objectData.forEach((obj, index) => {
            const row = createObjectRow(obj, index);
            tbody.appendChild(row);
          });
        } else {
          // ê·¸ë£¹í™” ì ìš©
          const groupedData = groupObjectsByKeys(objectData, groupKeys);
          renderGroupedData(tbody, groupedData, 0, groupKeys);
        }

        table.appendChild(tbody);
        container.appendChild(table);

        // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
        document
          .getElementById("selectAllCheckbox")
          .addEventListener("change", toggleSelectAll);
      }

      // ê°ì²´ í–‰ ìƒì„±
      function createObjectRow(obj, index) {
        const row = document.createElement("tr");
        row.dataset.globalId = obj.GlobalId;
        row.className = "object-row";

        // ì²´í¬ë°•ìŠ¤
        const checkboxCell = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = obj.GlobalId;
        checkbox.className = "object-checkbox";
        checkbox.addEventListener("change", handleObjectSelection);
        checkboxCell.appendChild(checkbox);
        row.appendChild(checkboxCell);

        // í–‰ í´ë¦­ ì´ë²¤íŠ¸ (ì²´í¬ë°•ìŠ¤ í† ê¸€)
        row.addEventListener("click", function (e) {
          if (e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
            handleObjectSelection();
          }
        });

        // ë³´ì´ëŠ” í—¤ë”ë“¤ë§Œ ë°ì´í„° ì…€ ìƒì„±
        visibleHeaders.forEach((header) => {
          const cell = document.createElement("td");
          let value = obj[header];

          if (value === undefined && obj.Quantities && obj.Quantities[header]) {
            value = obj.Quantities[header];
          }
          if (value === undefined && obj.Properties && obj.Properties[header]) {
            value = obj.Properties[header];
          }

          if (typeof value === "number") {
            if (value % 1 === 0) {
              value = value.toLocaleString("ko-KR");
            } else {
              value = value.toLocaleString("ko-KR", {
                maximumFractionDigits: 3,
              });
            }
          }

          cell.textContent = value || "";
          cell.title = value || ""; // íˆ´íŒ
          row.appendChild(cell);
        });

        return row;
      }

      // ê°ì²´ë“¤ì„ í‚¤ë¡œ ê·¸ë£¹í™”
      function groupObjectsByKeys(objects, keys, depth = 0) {
        if (depth >= keys.length) return objects;

        const grouped = {};
        const key = keys[depth];

        objects.forEach((obj) => {
          let value = obj[key];
          if (value === undefined && obj.Quantities)
            value = obj.Quantities[key];
          if (value === undefined && obj.Properties)
            value = obj.Properties[key];
          if (value === undefined) value = "N/A";

          if (!grouped[value]) grouped[value] = [];
          grouped[value].push(obj);
        });

        Object.keys(grouped).forEach((key) => {
          grouped[key] = groupObjectsByKeys(grouped[key], keys, depth + 1);
        });

        return grouped;
      }

      // ê·¸ë£¹í™”ëœ ë°ì´í„° ë Œë”ë§
      function renderGroupedData(tbody, groupedData, depth, groupKeys) {
        Object.entries(groupedData).forEach(([groupValue, content]) => {
          const groupKey = `${groupKeys[depth]}:${groupValue}`;
          const isCollapsed = collapsedGroups.has(groupKey);
          const symbol = isCollapsed ? "â–¶" : "â–¼";

          // ê·¸ë£¹ í—¤ë” í–‰
          const groupRow = document.createElement("tr");
          groupRow.className = "group-header";
          groupRow.style.backgroundColor = "#f0f0f0";
          groupRow.style.fontWeight = "bold";
          groupRow.style.cursor = "pointer";

          const groupCell = document.createElement("td");
          groupCell.colSpan = visibleHeaders.length + 1; // ì²´í¬ë°•ìŠ¤ í¬í•¨
          groupCell.textContent = `${" ".repeat(depth * 2)}${symbol} ${
            groupKeys[depth]
          }: ${groupValue}`;
          groupRow.appendChild(groupCell);

          groupRow.addEventListener("click", () => toggleGroup(groupKey));
          tbody.appendChild(groupRow);

          if (!isCollapsed) {
            if (Array.isArray(content)) {
              content.forEach((obj, index) => {
                const row = createObjectRow(obj, index);
                tbody.appendChild(row);
              });
            } else {
              renderGroupedData(tbody, content, depth + 1, groupKeys);
            }
          }
        });
      }

      // ê·¸ë£¹ í† ê¸€
      function toggleGroup(groupKey) {
        if (collapsedGroups.has(groupKey)) {
          collapsedGroups.delete(groupKey);
        } else {
          collapsedGroups.add(groupKey);
        }
        updateGroupedTable();
      }

      // ê°ì²´ ì„ íƒ ì²˜ë¦¬ ê°œì„ 
      function handleObjectSelection() {
        const selectedCheckboxes = document.querySelectorAll(
          "input.object-checkbox:checked"
        );
        selectedObjectIds = Array.from(selectedCheckboxes).map(
          (cb) => cb.value
        );

        console.log(`ğŸ” ì„ íƒëœ ê°ì²´: ${selectedObjectIds.length}ê°œ`);

        // ì„ íƒëœ í–‰ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        document.querySelectorAll(".object-row").forEach((row) => {
          const checkbox = row.querySelector("input.object-checkbox");
          if (checkbox && checkbox.checked) {
            row.classList.add("selected");
          } else {
            row.classList.remove("selected");
          }
        });

        // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
        const allCheckboxes = document.querySelectorAll(
          "input.object-checkbox"
        );
        const allSelected =
          allCheckboxes.length > 0 &&
          selectedCheckboxes.length === allCheckboxes.length;
        const someSelected = selectedCheckboxes.length > 0;

        const selectAllCheckbox = document.getElementById("selectAllCheckbox");
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = allSelected;
          selectAllCheckbox.indeterminate = someSelected && !allSelected;
        }

        // ìƒì„¸ ì •ë³´ ë¡œë“œ (í•­ìƒ í˜¸ì¶œí•˜ì—¬ ì„ íƒ í•´ì œë„ ì²˜ë¦¬)
        loadObjectDetails();
      }
      // IFC ì €ì¥ (ë‹¤ìš´ë¡œë“œ) ê°œì„  - ìƒˆ íŒŒì¼ ìƒì„± ë°©ì‹
      document
        .getElementById("saveIFCBtn")
        .addEventListener("click", function () {
          if (
            confirm(
              "ê³µì‚¬ì½”ë“œê°€ ë°˜ì˜ëœ ìƒˆë¡œìš´ IFC íŒŒì¼ì„ ìƒì„±í•˜ì—¬ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(íŒŒì¼ ìƒì„±ì— ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)"
            )
          ) {
            const btn = this;
            const originalText = btn.textContent;

            btn.disabled = true;
            btn.innerHTML = `
      <div class="spinner-border spinner-border-sm" role="status"></div>
      ìƒˆ IFC íŒŒì¼ ìƒì„± ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”
    `;

            // ìƒˆë¡œìš´ API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
            const downloadUrl = `/dd_by_ifc/api/download_new_ifc/${PROJECT_ID}/`;

            // fetchë¡œ ë‹¤ìš´ë¡œë“œ ìƒíƒœ í™•ì¸
            fetch(downloadUrl)
              .then((response) => {
                if (!response.ok) {
                  return response.json().then((data) => {
                    throw new Error(data.error || "íŒŒì¼ ìƒì„± ì‹¤íŒ¨");
                  });
                }

                // ì„±ê³µì ìœ¼ë¡œ ë°›ìœ¼ë©´ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                return response.blob();
              })
              .then((blob) => {
                // Blobì„ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `${PROJECT_ID}_with_costcodes.ifc`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                // ì„±ê³µ ë©”ì‹œì§€
                alert(
                  "âœ… ê³µì‚¬ì½”ë“œê°€ ë°˜ì˜ëœ ìƒˆë¡œìš´ IFC íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!"
                );
              })
              .catch((error) => {
                console.error("âŒ IFC íŒŒì¼ ìƒì„± ì‹¤íŒ¨:", error);
                alert(`âŒ IFC íŒŒì¼ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
              })
              .finally(() => {
                // ë²„íŠ¼ ë³µì›
                btn.disabled = false;
                btn.innerHTML = originalText;
              });
          }
        });

      // ì „ì²´ ì„ íƒ í† ê¸€
      function toggleSelectAll() {
        const selectAll = document.getElementById("selectAllCheckbox").checked;
        const checkboxes = document.querySelectorAll("input.object-checkbox");

        checkboxes.forEach((checkbox) => {
          checkbox.checked = selectAll;
        });

        handleObjectSelection();
      }

      // ì„ íƒëœ ê°ì²´ë“¤ì˜ ìƒì„¸ ì •ë³´ ë¡œë“œ (API ê²½ë¡œ ìˆ˜ì • ë° ê°œì„ )
      function loadObjectDetails() {
        if (selectedObjectIds.length === 0) {
          clearObjectDetails();
          return;
        }

        const formData = new FormData();
        selectedObjectIds.forEach((id) => formData.append("object_ids[]", id));

        fetch("/dd_by_ifc/api/object_details/", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            updateDetailTable(data.details);
            document.getElementById("totalLabel").textContent =
              "ì´ ê¸ˆì•¡: " + data.total_amount.toLocaleString("ko-KR") + " ì›";
            console.log(
              `âœ… ê°ì²´ ìƒì„¸ ì •ë³´ ë¡œë“œ ì™„ë£Œ: ${data.details.length}ê°œ ì½”ë“œ`
            );
          })
          .catch((error) => {
            console.error("âŒ ê°ì²´ ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:", error);
            alert("ê°ì²´ ìƒì„¸ ì •ë³´ë¥¼ ë¡œë“œí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
            clearObjectDetails();
          });
      }

      // ìƒì„¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸
      function updateDetailTable(details) {
        const tbody = document.querySelector("#codeDetailTable tbody");
        tbody.innerHTML = "";

        details.forEach((detail) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${detail.code}</td>
            <td>${detail.name}</td>
            <td>${detail.specification}</td>
            <td>${detail.unit}</td>
            <td>${detail.formula}</td>
            <td>${detail.quantity.toLocaleString("ko-KR", {
              maximumFractionDigits: 2,
            })}</td>
            <td>${detail.unit_price.toLocaleString("ko-KR")}</td>
            <td>${detail.amount.toLocaleString("ko-KR")}</td>
          `;
          tbody.appendChild(row);
        });
      }

      // ìƒì„¸ ì •ë³´ í´ë¦¬ì–´
      function clearObjectDetails() {
        document.querySelector("#codeDetailTable tbody").innerHTML = "";
        document.getElementById("totalLabel").textContent = "ì´ ê¸ˆì•¡: 0 ì›";
      }

      // ê³µì‚¬ì½”ë“œ ì¶”ê°€ ë©”ì‹œì§€ ê°œì„ 
      function addCostCodeToObjects() {
        if (!selectedCode || selectedObjectIds.length === 0) {
          alert("ê³µì‚¬ì½”ë“œì™€ ê°ì²´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        const addBtn = document.getElementById("addCodeBtn");
        const originalText = addBtn.textContent;
        addBtn.disabled = true;
        addBtn.textContent = "ì¶”ê°€ ì¤‘...";

        const formData = new FormData();
        selectedObjectIds.forEach((id) => formData.append("object_ids[]", id));
        formData.append("cost_code", selectedCode);

        fetch("/dd_by_ifc/api/add_cost_code/", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              // ì„±ê³µ ë©”ì‹œì§€ì— IFC íŒŒì¼ ê´€ë ¨ ì•ˆë‚´ ì¶”ê°€
              alert(
                `âœ… ${data.message}\n\nğŸ’¡ ë³€ê²½ì‚¬í•­ì´ IFC íŒŒì¼ì— ë°˜ì˜ë˜ë ¤ë©´ "ìˆ˜ì •ëœ IFC íŒŒì¼ ë‹¤ìš´ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.`
              );
              console.log(
                `âœ… ê³µì‚¬ì½”ë“œ ì¶”ê°€ ì„±ê³µ: ${data.updated_objects}ê°œ ê°ì²´`
              );

              // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
              loadIFCObjects();
              loadSummaryTable();

              if (selectedObjectIds.length > 0) {
                setTimeout(() => loadObjectDetails(), 500);
              }
            } else {
              throw new Error(data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
            }
          })
          .catch((error) => {
            console.error("âŒ ê³µì‚¬ì½”ë“œ ì¶”ê°€ ì‹¤íŒ¨:", error);
            alert("âŒ ê³µì‚¬ì½”ë“œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
          })
          .finally(() => {
            addBtn.disabled = false;
            addBtn.textContent = originalText;
          });
      }

      // ê³µì‚¬ì½”ë“œ ì œê±° ë©”ì‹œì§€ ê°œì„ 
      function removeCostCodeFromObjects() {
        if (selectedObjectIds.length === 0) {
          alert("ê°ì²´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        const selectedDetailRow = document.querySelector(
          "#codeDetailTable tbody tr.selected"
        );
        if (!selectedDetailRow) {
          alert("ì œê±°í•  ê³µì‚¬ì½”ë“œë¥¼ ìƒì„¸ í…Œì´ë¸”ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        const codeToRemove = selectedDetailRow.children[0].textContent;

        if (!confirm(`ê³µì‚¬ì½”ë“œ "${codeToRemove}"ë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          return;
        }

        const removeBtn = document.getElementById("removeCodeBtn");
        const originalText = removeBtn.textContent;
        removeBtn.disabled = true;
        removeBtn.textContent = "ì œê±° ì¤‘...";

        const formData = new FormData();
        selectedObjectIds.forEach((id) => formData.append("object_ids[]", id));
        formData.append("cost_code", codeToRemove);

        fetch("/dd_by_ifc/api/remove_cost_code/", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              // ì„±ê³µ ë©”ì‹œì§€ì— IFC íŒŒì¼ ê´€ë ¨ ì•ˆë‚´ ì¶”ê°€
              alert(
                `âœ… ${data.message}\n\nğŸ’¡ ë³€ê²½ì‚¬í•­ì´ IFC íŒŒì¼ì— ë°˜ì˜ë˜ë ¤ë©´ "ìˆ˜ì •ëœ IFC íŒŒì¼ ë‹¤ìš´ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.`
              );
              console.log(
                `âœ… ê³µì‚¬ì½”ë“œ ì œê±° ì„±ê³µ: ${data.updated_objects}ê°œ ê°ì²´`
              );

              // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
              loadIFCObjects();
              loadSummaryTable();

              if (selectedObjectIds.length > 0) {
                setTimeout(() => loadObjectDetails(), 500);
              }
            } else {
              throw new Error(data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
            }
          })
          .catch((error) => {
            console.error("âŒ ê³µì‚¬ì½”ë“œ ì œê±° ì‹¤íŒ¨:", error);
            alert("âŒ ê³µì‚¬ì½”ë“œ ì œê±° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
          })
          .finally(() => {
            removeBtn.disabled = false;
            removeBtn.textContent = originalText;
          });
      }

      // ìƒì„¸ í…Œì´ë¸” í–‰ ì„ íƒ (delegation)
      document.addEventListener("click", function (e) {
        if (e.target.closest("#codeDetailTable tbody tr")) {
          document
            .querySelectorAll("#codeDetailTable tbody tr")
            .forEach((row) => row.classList.remove("selected"));
          e.target.closest("tr").classList.add("selected");
        }
      });

      // ì½”ë“œ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ (API ê²½ë¡œ ìˆ˜ì •)
      function handleCostCodeFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("csv_file", file);

        fetch("/dd_by_ifc/api/load_cost_codes/", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              alert(data.message);
              console.log(
                `âœ… ì½”ë“œ íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ: ${data.total_codes}ê°œ ì½”ë“œ`
              );
            } else {
              throw new Error(data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
            }
          })
          .catch((error) => {
            console.error("âŒ ì½”ë“œ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:", error);
            alert("íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
          });
      }

      // ìš”ì•½ í…Œì´ë¸” í‘œì‹œ ì—…ë°ì´íŠ¸
      function updateSummaryTableDisplay(summaryData) {
        const tbody = document.querySelector("#summaryTable tbody");
        tbody.innerHTML = "";

        summaryData.forEach((item) => {
          const row = document.createElement("tr");

          if (item.type === "group") {
            row.className = "group-header";
            row.style.backgroundColor = "#f0f0f0";
            row.style.fontWeight = "bold";

            const cell = document.createElement("td");
            cell.colSpan = 9;
            cell.textContent = `â–¼ ê³µì¢…: ${
              item.group
            } (ì´ê¸ˆì•¡: ${item.total.toLocaleString("ko-KR")} ì›)`;
            row.appendChild(cell);
          } else {
            // ê°œë³„ í•­ëª©
            row.innerHTML = `
              <td>${item.code}</td>
              <td>${item.category}</td>
              <td>${item.name}</td>
              <td>${item.specification}</td>
              <td>${item.unit}</td>
              <td>${item.quantity.toLocaleString("ko-KR", {
                maximumFractionDigits: 2,
              })}</td>
              <td>${item.material_amount.toLocaleString("ko-KR")}</td>
              <td>${item.labor_amount.toLocaleString("ko-KR")}</td>
              <td>${item.total_amount.toLocaleString("ko-KR")}</td>
            `;
          }

          tbody.appendChild(row);
        });
      }

      // IFC ì €ì¥ (ë‹¤ìš´ë¡œë“œ) (ìˆ˜ì •ëœ API ê²½ë¡œ)
      document
        .getElementById("saveIFCBtn")
        .addEventListener("click", function () {
          if (confirm("ìˆ˜ì •ëœ IFC íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            window.location.href = `/dd_by_ifc/api/download_ifc/${PROJECT_ID}/`;
          }
        });
    </script>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  WASM ê¸°ë°˜ IFC Viewer  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";

      const viewDiv = document.getElementById("viewer");
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(
        60,
        viewDiv.clientWidth / viewDiv.clientHeight,
        0.1,
        10000
      );
      const renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true,
      });
      renderer.setSize(viewDiv.clientWidth, viewDiv.clientHeight);
      viewDiv.appendChild(renderer.domElement);

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      scene.add(new THREE.AmbientLight(0xffffff, 0.8));
      const dir = new THREE.DirectionalLight(0xffffff, 0.8);
      dir.position.set(10, 10, 10);
      scene.add(dir);

      camera.position.set(10, 10, 10);
      THREE.Object3D.DefaultUp = new THREE.Vector3(0, 0, 1); // IFCëŠ” Zâ€‘Up

      // Pyodide / IfcOpenShell ë¡œ IFC ë¡œë“œ
      const IFC_URL = "{{ ifc_abs_url }}";
      const WHEEL_URL =
        "{% static 'wasm/IfcOpenShell-0.7.0-py3-none-any.whl' %}";

      (async () => {
        const pyodide = await loadPyodide();
        await pyodide.loadPackage("micropip");
        const micropip = pyodide.pyimport("micropip");
        await micropip.install(WHEEL_URL);

        // IFC í…ìŠ¤íŠ¸ ë¡œë“œ
        const ifcText = await (await fetch(IFC_URL)).text();

        // Python: IFC ì—´ê¸° + geometry iterator
        const ifcopenshell = pyodide.pyimport("ifcopenshell");
        const ifc = ifcopenshell.file.from_string(ifcText);
        const ifcopenshell_geom = pyodide.pyimport("ifcopenshell.geom");
        const s = ifcopenshell_geom.settings();
        s.set(s.WELD_VERTICES, false);

        const it = ifcopenshell_geom.iterator(s, ifc);
        let lastMeshId = null;
        let geometries = [];

        if (it.initialize()) {
          while (true) {
            const obj = it.get();
            const ty = ifc.by_id(obj.id).is_a();
            if (ty !== "IfcOpeningElement" && ty !== "IfcSpace") {
              if (lastMeshId !== obj.geometry.id) {
                geometries = [];

                const materials = obj.geometry.materials.toJs().map(
                  (e) =>
                    new THREE.MeshLambertMaterial({
                      color: new THREE.Color(...e.diffuse.toJs()),
                      opacity: 1.0 - e.transparency,
                      transparent: e.transparency > 1e-5,
                      side: THREE.DoubleSide,
                    })
                );

                const mapping = {};
                obj.geometry.material_ids.toJs().forEach((mid, idx) => {
                  mapping[mid] = mapping[mid] || [];
                  mapping[mid].push(idx);
                });

                const vs = new Float32Array(obj.geometry.verts.toJs());
                const ns = new Float32Array(obj.geometry.normals.toJs());
                const fs = obj.geometry.faces.toJs();

                let offset = 0;
                if (mapping[-1]) {
                  materials.unshift(
                    new THREE.MeshLambertMaterial({
                      color: new THREE.Color(0.6, 0.6, 0.6),
                      side: THREE.DoubleSide,
                    })
                  );
                  offset = 1;
                }

                materials.forEach((mat, mi) => {
                  const idxList = mapping[mi - offset];
                  if (!idxList) return; // ë°©ì–´
                  const g = new THREE.BufferGeometry();
                  const flatIdx = [];
                  idxList.forEach((i) => {
                    flatIdx.push(fs[3 * i], fs[3 * i + 1], fs[3 * i + 2]);
                  });
                  g.setIndex(flatIdx);
                  g.setAttribute("position", new THREE.BufferAttribute(vs, 3));
                  g.setAttribute("normal", new THREE.BufferAttribute(ns, 3));
                  geometries.push([g, mat]);
                });

                lastMeshId = obj.geometry.id;
              }

              // Mesh ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
              geometries.forEach(([g, mat]) => {
                const mesh = new THREE.Mesh(g, mat);
                const m = obj.transformation.matrix.data.toJs();
                // obj.transformation ëŠ” ì—´(Col-major) â†’ Three(í–‰) ë§ì¶”ê¸° transpose
                const mat4 = new THREE.Matrix4()
                  .set(
                    m[0],
                    m[1],
                    m[2],
                    0,
                    m[3],
                    m[4],
                    m[5],
                    0,
                    m[6],
                    m[7],
                    m[8],
                    0,
                    m[9],
                    m[10],
                    m[11],
                    1
                  )
                  .transpose();
                mesh.matrixAutoUpdate = false;
                mesh.matrix = mat4;
                scene.add(mesh);
              });
            }
            if (!it.next()) break;
          }
        }

        zoomToFit();
        animate();
      })();

      function zoomToFit() {
        const box = new THREE.Box3().setFromObject(scene);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3()).length();
        const dist = size * 1.5;
        camera.position.copy(
          center.clone().add(new THREE.Vector3(dist, dist, dist))
        );
        camera.lookAt(center);
        controls.target.copy(center);
        controls.update();
      }

      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }

      window.addEventListener("resize", () => {
        const w = viewDiv.clientWidth;
        const h = viewDiv.clientHeight;
        renderer.setSize(w, h);
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
      });

      // ë””ë²„ê¹… í•¨ìˆ˜ (ê°œë°œ ì‹œì—ë§Œ ì‚¬ìš©)
      async function debugNewIFCGeneration() {
        try {
          console.log("ğŸ” ìƒˆ IFC íŒŒì¼ ìƒì„± í…ŒìŠ¤íŠ¸ ì‹œì‘...");

          const response = await fetch(
            `/dd_by_ifc/api/download_new_ifc/${PROJECT_ID}/`
          );

          if (response.ok) {
            const blob = await response.blob();
            console.log(`âœ… ìƒˆ IFC íŒŒì¼ ìƒì„± ì„±ê³µ: ${blob.size} bytes`);

            // ì‹¤ì œë¡œ ë‹¤ìš´ë¡œë“œí•˜ì§€ ì•Šê³  í¬ê¸°ë§Œ í™•ì¸
            return {
              success: true,
              size: blob.size,
              message: "íŒŒì¼ ìƒì„± ì„±ê³µ",
            };
          } else {
            const error = await response.json();
            console.log(`âŒ ìƒˆ IFC íŒŒì¼ ìƒì„± ì‹¤íŒ¨: ${error.error}`);
            return {
              success: false,
              error: error.error,
            };
          }
        } catch (error) {
          console.log(`âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
          return {
            success: false,
            error: error.message,
          };
        }
      }

      // ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì‚¬ìš©: debugNewIFCGeneration();
    </script>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ (í…Œì´ë¸” ì¶•ì†Œ ë“±)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <style>
      .ifc-objects-table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
        font-size: 11px;
      }
      .ifc-objects-table th,
      .ifc-objects-table td {
        border: 1px solid #ddd;
        padding: 3px 6px;
        text-align: left;
        height: 24px;
        vertical-align: middle;
        line-height: 1.2;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .ifc-objects-table th {
        background-color: #f2f2f2;
        font-weight: bold;
        height: 28px;
        font-size: 10px;
      }
      .ifc-objects-table tbody tr {
        height: 24px;
      }
      .ifc-objects-table tr:nth-child(even) {
        background-color: #f9f9f9;
      }
      .ifc-objects-table tbody tr:hover {
        background-color: #e8f4fd;
        cursor: pointer;
      }
      .ifc-objects-table tbody tr.selected {
        background-color: #007bff !important;
        color: white;
      }

      .group-header {
        background-color: #e0e0e0 !important;
        font-weight: bold;
        cursor: pointer;
        height: 28px !important;
        font-size: 11px;
      }
      .group-header:hover {
        background-color: #d0d0d0 !important;
      }
      .group-header td {
        height: 28px !important;
        line-height: 28px !important;
      }

      .search-results {
        max-height: 180px;
        overflow-y: auto;
        border: 1px solid #ddd;
        margin: 8px 0;
        padding: 0;
        list-style: none;
        font-size: 11px;
      }
      .search-results li {
        padding: 6px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        font-size: 11px;
      }
      .search-results li:hover {
        background-color: #f0f0f0;
      }
      .search-results li.selected {
        background-color: #007bff;
        color: white;
      }

      .code-detail-table {
        font-size: 11px;
      }
      .code-detail-table th,
      .code-detail-table td {
        padding: 3px 6px;
        font-size: 11px;
      }
      .code-detail-table tbody tr.selected {
        background-color: #007bff;
        color: white;
      }

      .summary-table {
        font-size: 11px;
      }
      .summary-table th,
      .summary-table td {
        padding: 3px 6px;
        font-size: 11px;
      }

      .column-selector {
        margin-top: 15px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
      }
      .column-selector h4 {
        font-size: 12px;
        margin: 0 0 8px 0;
        color: #333;
      }
      .column-checkboxes {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 8px;
      }
      .column-checkbox {
        display: flex;
        align-items: center;
        margin-bottom: 3px;
        font-size: 10px;
      }
      .column-checkbox input[type="checkbox"] {
        margin-right: 6px;
        transform: scale(0.8);
      }
      .column-checkbox label {
        cursor: pointer;
        flex: 1;
        font-size: 10px;
      }
      .column-buttons {
        display: flex;
        gap: 5px;
      }
      .btn-small {
        padding: 3px 8px;
        font-size: 10px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      .btn-small:hover {
        background-color: #5a6268;
      }

      input[type="text"],
      select {
        font-size: 11px;
        padding: 4px 6px;
      }
      .group-bar {
        margin-bottom: 10px;
        font-size: 11px;
      }
      .group-bar label {
        margin-right: 10px;
        font-size: 11px;
      }
      .group-bar select {
        margin-right: 15px;
        font-size: 10px;
        padding: 2px 4px;
      }

      .hidden {
        display: none;
      }
      .left-panel {
        width: 30%;
        padding-right: 15px;
      }
      .right-panel {
        width: 70%;
      }
      .container_detail {
        display: flex;
        margin: 15px 0;
      }
      .btn {
        margin: 4px;
        padding: 6px 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
      }
      .btn:hover {
        background-color: #0056b3;
      }
      .btn-block {
        width: 100%;
        padding: 10px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }
      .btn-block:hover {
        background-color: #218838;
      }
    </style>
  </body>
</html>
