<!--templates/dd_by_ifc/project_detail.html-->

{% load static %}
<!DOCTYPE html>
<!--  AIBIM Costâ€‘Estimator â€“ ìƒì„¸ê²¬ì (DD) ì‘ì—… í˜ì´ì§€  -->
<html>
  <head>
    <title>{{ project.name }} - ìƒì„¸ê²¬ì  ì‘ì—…</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />

    <!-- three.js / OrbitControls ES module importmap -->
    <script type="importmap">
      {
        "imports": {
          "three": "{% static 'js/three.module.js' %}",
          "three/examples/jsm/controls/OrbitControls.js": "{% static 'js/OrbitControls.js' %}"
        }
      }
    </script>
    <script
      async
      src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"
    ></script>

    <!-- Pyodide + IfcOpenShell WASM -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.22.0a1/full/pyodide.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/style_dd_by_ifc.css' %}" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />
  </head>

  <body class="is-preload" data-project-id="{{ project.id }}">
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ & ë©”ë‰´  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="page-wrapper">
      <!-- Header -->
      <div id="header">
        <!-- Logo -->
        <h1>
          <a href="/" id="logo">AIBIM <em>Cost Estimator</em></a>
        </h1>

        <!-- Nav -->
        <nav id="nav">
          <ul>
            <li><a href="/">í™ˆ</a></li>
            <li>
              <a href="#">ê³„íšì„¤ê³„ë‹¨ê³„ ê²¬ì </a>
              <ul>
                <li>
                  <a href="/ai_prediction/">AI ê°œì‚°ê²¬ì </a>
                </li>
              </ul>
            </li>
            <li>
              <a href="#">ì¤‘ê°„ì„¤ê³„ë‹¨ê³„ ê²¬ì </a>
              <ul>
                <li>
                  <a href="/ifc_ai_prediction/">AI+BIM ê°œì‚°ê²¬ì (IFCê¸°ë°˜)</a>
                </li>
              </ul>
            </li>
            <li class="current">
              <a href="#">ì‹¤ì‹œì„¤ê³„ë‹¨ê³„ ê²¬ì </a>
              <ul>
                <li>
                  <a href="/dd_by_ifc/">AI+BIM ìƒì„¸ê²¬ì (IFCê¸°ë°˜)</a>
                </li>
              </ul>
            </li>
            <li>
              <a href="/ai_learning">AIëª¨ë¸ í•™ìŠµ</a>
            </li>
          </ul>
        </nav>
      </div>

      <div id="nav_sub">
        <h6 class="text-center">
          <b>AI+BIM ìƒì„¸ê²¬ì </b> <span>(IFCê¸°ë°˜)</span>
        </h6>
      </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  3D Viewer  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="view-container"><div id="viewer"></div></div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  ì „ì²´ ì½”ë“œ ìš”ì•½ í…Œì´ë¸”  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="container_detail_first" id="first_container">
      <!-- ê·¸ë£¹ ì„¤ì • ë° í…Œì´ë¸” ì˜ì—­ (ì ‘ê¸°/í´ê¸° ê°€ëŠ¥) -->
      <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleSection('summaryTable')">
          <span class="toggle-icon" id="summaryTable-icon">â–¼</span>
          <span>ë‚´ì—­ì„œ</span>
        </div>
        <div class="collapsible-content" id="summaryTable-content">
          <div
            class="summary-group-bar"
            id="summaryGroupBar"
            style="margin: 6px 0 10px 0; font-size: 11px"
          >
            <div>
              1ë‹¨ê³„ ê·¸ë£¹:
              <select
                id="summaryGroup1"
                style="font-size: 11px; padding: 2px 4px"
              >
                <option value="">ì—†ìŒ</option>
              </select>

              2ë‹¨ê³„ ê·¸ë£¹:
              <select
                id="summaryGroup2"
                style="font-size: 11px; padding: 2px 4px"
              >
                <option value="">ì—†ìŒ</option>
              </select>

              3ë‹¨ê³„ ê·¸ë£¹:
              <select
                id="summaryGroup3"
                style="font-size: 11px; padding: 2px 4px"
              >
                <option value="">ì—†ìŒ</option>
              </select>
            </div>
          </div>

          <div class="container_detail">
            <div class="table-wrapper" style="overflow-x: auto">
              <table id="summaryTable" class="table table-bordered aibim-table">
                <thead>
                  <tr>
                    <th style="width: 30px">í† ê¸€</th>
                    <th>
                      <input type="checkbox" id="summarySelectAllCheckbox" />
                    </th>
                    <th>ê³µì‚¬ì½”ë“œ</th>
                    <th>ê³µì¢…</th>
                    <th>ëª…ì¹­</th>
                    <th>ê·œê²©</th>
                    <th>ë‹¨ìœ„</th>
                    <th>ìˆ˜ëŸ‰</th>
                    <th>ì¬ë£Œë¹„ë‹¨ê°€</th>
                    <th>ì¬ë£Œë¹„</th>
                    <th>ë…¸ë¬´ë¹„ë‹¨ê°€</th>
                    <th>ë…¸ë¬´ë¹„</th>
                    <th>ê²½ë¹„ë‹¨ê°€</th>
                    <th>ê²½ë¹„</th>
                    <th>í•©ê³„ë‹¨ê°€</th>
                    <th>ì´ê¸ˆì•¡</th>
                  </tr>
                </thead>
                <tbody id="summaryTableBody"></tbody>
              </table>
            </div>
          </div>
          <div class="container_detail">
            <!-- â–¼ ìš”ì•½ ì´ ê¸ˆì•¡ & ì¬ê³„ì‚° ë²„íŠ¼ (PATCH) -->
            <div class="container_detail">
              <div class="summary-total-label" id="summaryTotalLabel">
                ìš”ì•½ ì´ ê¸ˆì•¡: 0 ì›
              </div>
              <button
                class="btn-small"
                id="recalculateAmountsBtn"
                style="margin-left: 8px"
              >
                ì´ì•¡ ì¬ê³„ì‚°
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- í•„ë“œ ì„ íƒ ì˜ì—­ (ì ‘ê¸°/í´ê¸° ê°€ëŠ¥) -->
    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleSection('fieldSelector')">
        <span class="toggle-icon" id="fieldSelector-icon">â–¼</span>
        <span>ë‚´ì—­ì„œ í•„ë“œ ì„ íƒ</span>
      </div>
      <div class="collapsible-content" id="fieldSelector-content">
        <!-- í•„ë“œ ì„ íƒ UIê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
      </div>
    </div>
    <!-- í¼ì¹˜ê¸°/ì ‘ê¸° ë²„íŠ¼ -->
    <div>
      <button class="cnv_divide" id="folding_line" onclick="foldingAction()">
        í¼ì¹˜ê¸°
      </button>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  ìƒì„¸ íŒ¨ë„ (ì½”ë“œ ê²€ìƒ‰, ê·¸ë£¹í•‘, ìƒì„¸ í…Œì´ë¸”)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="container_detail_first" style="display: none">
      <div class="container_detail_first">
        <div class="container_detail">
          <!-- ì¢Œì¸¡ íŒ¨ë„ -->
          <div class="left-panel">
            <ul class="search-results" id="searchResults"></ul>
            <input type="text" id="searchBox" placeholder="ê³µì‚¬ì½”ë“œ ê²€ìƒ‰" />
            <button class="btn" id="addCodeBtn">ê³µì‚¬ì½”ë“œ ì¶”ê°€</button>
            <button class="btn" id="removeCodeBtn">ê³µì‚¬ì½”ë“œ ì‚­ì œ</button>
            <button class="btn" id="loadCodeBtn">ì½”ë“œë¦¬ìŠ¤íŠ¸ ì—´ê¸°</button>
            <!-- ì»¬ëŸ¼ ì„ íƒ ì˜ì—­ -->
            <div class="column-selector">
              <h4>í‘œì‹œí•  í•„ë“œ ì„ íƒ</h4>
              <div class="column-checkboxes" id="columnCheckboxes"></div>
              <div class="column-buttons">
                <button class="btn-small" id="selectAllColumnsBtn">
                  ëª¨ë‘ ì„ íƒ
                </button>
                <button class="btn-small" id="deselectAllColumnsBtn">
                  ëª¨ë‘ í•´ì œ
                </button>
              </div>
            </div>
          </div>
          <!-- ìš°ì¸¡ íŒ¨ë„ -->
          <div class="right-panel">
            <div class="group-bar">
              <label
                >1ë‹¨ê³„ ê·¸ë£¹:
                <select id="groupBy1">
                  <option>ì—†ìŒ</option>
                </select>
              </label>
              <label
                >2ë‹¨ê³„ ê·¸ë£¹:
                <select id="groupBy2">
                  <option>ì—†ìŒ</option>
                </select>
              </label>
              <label
                >3ë‹¨ê³„ ê·¸ë£¹:
                <select id="groupBy3">
                  <option>ì—†ìŒ</option>
                </select>
              </label>
            </div>
            <div
              class="ifc-table"
              id="ifcTablecontainer_"
              style="max-height: 400px; overflow-y: auto"
            ></div>
          </div>
        </div>
      </div>
      <!-- ìƒì„¸ ì½”ë“œë³„ ìˆ˜ëŸ‰/ê¸ˆì•¡ -->
      <div class="container_detail">
        <div class="total-label" id="totalLabel">ì„ íƒê°ì²´ë³„ ì´ê¸ˆì•¡: 0 ì›</div>
      </div>
      <div class="container_detail">
        <div class="table-wrapper" style="overflow-x: auto">
          <table class="table table-bordered aibim-table" id="codeDetailTable">
            <thead>
              <tr>
                <!-- í•„ìˆ˜ 6ê°œ -->
                <th>ê³µì‚¬ì½”ë“œ</th>
                <th>ëª…ì¹­</th>
                <th>ê·œê²©</th>
                <th>ë‹¨ìœ„</th>
                <th>ì‚°ì‹</th>
                <th>ìˆ˜ëŸ‰</th>

                <!-- ì„ íƒ: ë‹¨ê°€Â·ê¸ˆì•¡ ì»¬ëŸ¼ (ì›í•˜ë©´ ìœ ì§€/ì¶”ê°€) -->
                <th>ì¬ë£Œë¹„ë‹¨ê°€</th>
                <th>ì¬ë£Œë¹„</th>
                <th>ë…¸ë¬´ë¹„ë‹¨ê°€</th>
                <th>ë…¸ë¬´ë¹„</th>
                <th>ê²½ë¹„ë‹¨ê°€</th>
                <th>ê²½ë¹„</th>
                <th>í•©ê³„ë‹¨ê°€</th>
                <th>ê¸ˆì•¡</th>
              </tr>
            </thead>

            <tbody></tbody>
          </table>
        </div>
        <div style="height: 12px"></div>
      </div>

      <!-- ìˆ˜ì •ëœ IFC ë‹¤ìš´ë¡œë“œ -->
      <div>
        <button class="btn-block" id="saveIFCBtn">
          ìˆ˜ì •ëœ IFC íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        </button>
      </div>
    </div>

    <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ -->
    <div>
      <div class="container">
        <div class="top-bar"></div>
        <div class="container_"></div>
        <input type="file" id="codeFileInput" accept=".csv" class="hidden" />
        <input type="file" id="ifcFileInput" accept=".ifc" class="hidden" />
      </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  ê³µí†µ JS (jQuery ë“±)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <script src="{% static 'js/jquery.min.js'%}"></script>
    <script src="{% static 'js/jquery.dropotron.min.js'%}"></script>
    <script src="{% static 'js/browser.min.js'%}"></script>
    <script src="{% static 'js/breakpoints.min.js'%}"></script>
    <script src="{% static 'js/util.js'%}"></script>
    <script src="{% static 'js/main.js'%}"></script>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  í¼ì¹˜ê¸°/ì ‘ê¸° í•¨ìˆ˜  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <script>
      function foldingAction() {
        const el = document.getElementById("container_detail_first");
        if (el.style.display === "block" || el.style.display === "") {
          el.style.display = "none";
          document.getElementById("folding_line").innerText = "í¼ì¹˜ê¸°";
        } else {
          el.style.display = "block";
          document.getElementById("folding_line").innerText = "ì ‘ê¸°";
        }
      }
    </script>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  ê²¬ì /ì½”ë“œ UI ìŠ¤í¬ë¦½íŠ¸ (ìˆ˜ì •ëœ API ê²½ë¡œ)  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <script>
      // ì „ì—­ ë³€ìˆ˜
      const PROJECT_ID = parseInt(document.body.dataset.projectId) || 0;
      let codeData = {};
      let objectData = [];
      let groupedObjects = [];
      let collapsedGroups = new Set();
      let selectedCode = null;
      let selectedObjectIds = [];
      let headers = [];
      let visibleHeaders = []; // í‘œì‹œí•  í—¤ë”ë“¤
      // ====== â–¼ ì „ì—­ë³€ìˆ˜ ì¶”ê°€ (ê¸°ì¡´ ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ë¶€ ê·¼ì²˜) ======
      // ê¸°ì¡´ ì „ì—­ë¶€ ê·¼ì²˜
      let activeFormulaField = "ì‚°ì‹"; // ì „ì²´ìš© ê¸°ë³¸ê°’(ìœ ì§€)
      let formulaFields = []; // 'ì‚°ì‹*' ëª©ë¡(ê¸°ì¡´)
      const rowFormulaMap = new Map(); // âœ¨ key: item._uniqueKey , val: 'ì‚°ì‹1' ê°™ì€ ì„ íƒê°’

      // ì ‘ì—ˆë‹¤/í¼ì³¤ë‹¤ ë° ê³µì‚¬ì½”ë“œ ê·¸ë£¹í•‘ ì „ì—­ ë³€ìˆ˜ ì¶”ê°€
      let expandedCostCodes = new Set(); // í¼ì³ì§„ ê³µì‚¬ì½”ë“œë“¤

      function buildRowFormulaSelect(item) {
        const selVal = getItemFormulaField(item);
        const opts = formulaFields
          .map(
            (f) =>
              `<option value="${f}" ${
                f === selVal ? "selected" : ""
              }>${f}</option>`
          )
          .join("");
        return `<select class="row-formula"
                  data-uk="${item._uniqueKey}"
                  style="font-size:10px;padding:1px 2px;">${opts}</select>`;
      }

      function recalcOneItem(item) {
        const fName = getItemFormulaField(item); // í–‰ë§ˆë‹¤ ì‚°ì‹ëª…
        const formulaText = getFormulaText(item, fName); // ì‚°ì‹ ë¬¸ìì—´
        const qty = formulaText
          ? evalQuantityFromFormula(formulaText, item)
          : parseFloat(item["ìˆ˜ëŸ‰"] || 0) || 0;
        item["ìˆ˜ëŸ‰"] = qty;

        const mU = parseFloat(item["ì¬ë£Œë¹„ë‹¨ê°€"] || 0);
        const lU = parseFloat(item["ë…¸ë¬´ë¹„ë‹¨ê°€"] || 0);
        const eU = parseFloat(item["ê²½ë¹„ë‹¨ê°€"] || 0);
        const tU =
          parseFloat(item["í•©ê³„ë‹¨ê°€"] || 0) ||
          (isNaN(mU + lU + eU) ? 0 : mU + lU + eU);

        item["ì¬ë£Œë¹„"] = qty * mU;
        item["ë…¸ë¬´ë¹„"] = qty * lU;
        item["ê²½ë¹„"] = qty * eU;
        item["ì´ê¸ˆì•¡"] = qty * tU;
      }

      // ëª¨ë“  í•­ëª© ì¬ê³„ì‚°(í–‰ ê°œë³„ ì„ íƒê°’ ì ìš©)
      function recalcAllItems() {
        combinedItems.forEach(recalcOneItem);

        // ì´ì•¡ ë¼ë²¨ ê°±ì‹ 
        const total = combinedItems.reduce(
          (s, it) => s + (parseFloat(it["ì´ê¸ˆì•¡"]) || 0),
          0
        );
        document.getElementById("summaryTotalLabel").textContent =
          "ìš”ì•½ ì´ ê¸ˆì•¡: " + total.toLocaleString("ko-KR") + " ì›";

        refreshSummaryTable(); // ë‹¤ì‹œ ë Œë” (ì„ íƒê°’ì€ rowFormulaMap ë•Œë¬¸ì— ìœ ì§€ë¨)
      }

      function getItemFormulaField(item) {
        // í–‰ì— ì €ì¥ëœ ê°’ì´ ìˆìœ¼ë©´ ê·¸ê±¸, ì—†ìœ¼ë©´ ì „ì²´ ê¸°ë³¸ê°’
        return (
          rowFormulaMap.get(item._uniqueKey) || activeFormulaField || "ì‚°ì‹"
        );
      }

      // ì‚°ì‹ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° í—¬í¼
      function getFormulaText(item, fieldName) {
        if (!fieldName) return "";
        const code = item._costCode;
        let txt = "";
        if (code && codeData[code] && codeData[code][fieldName]) {
          txt = codeData[code][fieldName];
        }
        if (!txt && item[fieldName]) txt = item[fieldName];
        return txt || "";
      }

      // ====== â–¼ ìœ í‹¸: 'ì‚°ì‹'ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” í•„ë“œ ìˆ˜ì§‘ ======
      function collectFormulaFields() {
        // summaryAllFields ëŠ” ì´ë¯¸ Set â†’ Array ë¡œ ìˆìŒ
        return Array.from(summaryAllFields).filter((f) => f.startsWith("ì‚°ì‹"));
      }

      // ====== â–¼ ì„ íƒëœ ì‚°ì‹ìœ¼ë¡œ ëª¨ë“  í•­ëª©ì˜ ìˆ˜ëŸ‰/ê¸ˆì•¡ ì¬ê³„ì‚° ======
      function recalcQuantitiesByFormula(_unused) {
        recalcAllItems();
      }

      // ====== â–¼ í—¤ë”(ë§¨ ì• ì—´)ì— ì½¤ë³´ë°•ìŠ¤ ì‹¬ê¸° ======
      function ensureFormulaSelectTh() {
        const theadRow = document.querySelector("#summaryTable thead tr");
        if (!theadRow) return;

        let th = document.getElementById("formulaSelectTh");
        if (!th) {
          th = document.createElement("th");
          th.id = "formulaSelectTh";
          th.style.minWidth = "90px";
          theadRow.insertBefore(th, theadRow.children[2] || null);
        }

        th.innerHTML = `
    <select id="quantityFormulaSelect" style="font-size:11px;padding:2px 4px;width:100%;">
    </select>
  `;

        const sel = document.getElementById("quantityFormulaSelect");
        formulaFields = collectFormulaFields();

        const hasSan = Array.isArray(summaryAllFields)
          ? summaryAllFields.includes("ì‚°ì‹")
          : summaryAllFields.has("ì‚°ì‹");
        if (!formulaFields.includes("ì‚°ì‹") && hasSan)
          formulaFields.unshift("ì‚°ì‹");

        sel.innerHTML = formulaFields
          .map((f) => `<option value="${f}">${f}</option>`)
          .join("");

        sel.value = activeFormulaField;

        // ğŸ”½ğŸ”½ ì—¬ê¸°! ê¸°ì¡´ onchange ì§€ìš°ê³  ì•„ë˜ ì½”ë“œë¡œ êµì²´ ğŸ”½ğŸ”½
        sel.onchange = (e) => {
          activeFormulaField = e.target.value;
          rowFormulaMap.clear(); // ê°œë³„ ì„ íƒê°’ ì´ˆê¸°í™” ì•ˆ í•˜ë ¤ë©´ ì£¼ì„ ì²˜ë¦¬
          recalcAllItems(); // í–‰ë³„ ì‚°ì‹ ë°˜ì˜í•´ì„œ ì „ì²´ ì¬ê³„ì‚°
        };
      }

      // ================================================================================================
      // í•„ë“œ ì„ íƒ UI ìƒì„±/ì—…ë°ì´íŠ¸ (ìœ„ì¹˜ ë³€ê²½)
      // ================================================================================================
      // ====================== í•„ë“œ ì„ íƒ UI (ì ‘ì´ì‹ ì˜ì—­ìš©) ======================
      function renderSummaryFieldSelector() {
        const selectorContainer = document.getElementById(
          "fieldSelector-content"
        );
        if (!selectorContainer) return;

        selectorContainer.innerHTML = `
    <div class="field-selector-header">
      <div class="field-selector-buttons">
        <button class="btn-small" id="selectAllSummaryFields">ëª¨ë‘ ì„ íƒ</button>
        <button class="btn-small" id="deselectAllSummaryFields">ëª¨ë‘ í•´ì œ</button>
        <button class="btn-small" id="resetDefaultSummaryFields">ê¸°ë³¸ê°’</button>
      </div>
    </div>
    <div class="field-checkboxes-container">
      <div class="field-checkboxes" id="summaryFieldCheckboxes"></div>
    </div>
  `;

        // ì²´í¬ë°•ìŠ¤ ê·¸ë¦¬ê¸°
        const checkboxContainer = document.getElementById(
          "summaryFieldCheckboxes"
        );
        if (!checkboxContainer) return;

        checkboxContainer.innerHTML = "";
        summaryAllFields.forEach((field) => {
          const div = document.createElement("div");
          div.className = "field-checkbox";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `summaryField_${field}`;
          checkbox.value = field;
          checkbox.checked = summaryVisibleFields.includes(field);
          checkbox.addEventListener("change", handleSummaryFieldToggle);

          const label = document.createElement("label");
          label.htmlFor = `summaryField_${field}`;
          label.textContent = field;

          div.appendChild(checkbox);
          div.appendChild(label);
          checkboxContainer.appendChild(div);
        });

        // ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
        document.getElementById("selectAllSummaryFields").onclick = () =>
          selectAllSummaryFields(true);
        document.getElementById("deselectAllSummaryFields").onclick = () =>
          selectAllSummaryFields(false);
        document.getElementById("resetDefaultSummaryFields").onclick =
          resetDefaultSummaryFields;
      }
      // ================================================================================================
      // ìƒˆë¡œìš´ í…Œì´ë¸” ë Œë”ë§ - ê³µì‚¬ì½”ë“œë³„ ê·¸ë£¹í•‘
      // ================================================================================================
      function renderBasicSummaryNew() {
        const tbody = document.getElementById("summaryTableBody");
        if (!tbody) return;

        tbody.innerHTML = "";

        // í—¤ë” ì—…ë°ì´íŠ¸ (í† ê¸€ ì»¬ëŸ¼ í¬í•¨)
        updateSummaryTableHeader();

        // ê³µì‚¬ì½”ë“œë³„ë¡œ ê·¸ë£¹í•‘
        const groupedByCode = groupItemsByCostCode(combinedItems);

        // ê° ê³µì‚¬ì½”ë“œ ê·¸ë£¹ì„ ë Œë”ë§
        Object.entries(groupedByCode).forEach(([costCode, items]) => {
          renderCostCodeGroup(tbody, costCode, items);
        });

        console.log(
          `âœ… ê³µì‚¬ì½”ë“œë³„ ìš”ì•½í‘œ ë Œë”ë§ ì™„ë£Œ: ${
            Object.keys(groupedByCode).length
          }ê°œ ì½”ë“œ ê·¸ë£¹`
        );
      }

      // ê³µì‚¬ì½”ë“œë³„ ê·¸ë£¹í•‘ í•¨ìˆ˜
      function groupItemsByCostCode(items) {
        const grouped = {};

        items.forEach((item) => {
          const code = item.CostCode || "ì½”ë“œì—†ìŒ";
          if (!grouped[code]) {
            grouped[code] = [];
          }
          grouped[code].push(item);
        });

        return grouped;
      }

      // ê³µì‚¬ì½”ë“œ ê·¸ë£¹ ë Œë”ë§ í•¨ìˆ˜
      function renderCostCodeGroup(tbody, costCode, items) {
        const isExpanded = expandedCostCodes.has(costCode);
        const toggleSymbol = isExpanded ? "âˆ’" : "+";

        // ê³µì‚¬ì½”ë“œ ì •ë³´ (ì²« ë²ˆì§¸ ì•„ì´í…œì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        const firstItem = items[0];
        const codeInfo = codeData[costCode] || {};

        // ì§‘ê³„ ê³„ì‚°
        const totalQuantity = items.reduce(
          (sum, item) => sum + (parseFloat(item["ìˆ˜ëŸ‰"]) || 0),
          0
        );
        const totalAmount = items.reduce(
          (sum, item) => sum + (parseFloat(item["ì´ê¸ˆì•¡"]) || 0),
          0
        );
        const materialAmount = items.reduce(
          (sum, item) => sum + (parseFloat(item["ì¬ë£Œë¹„"]) || 0),
          0
        );
        const laborAmount = items.reduce(
          (sum, item) => sum + (parseFloat(item["ë…¸ë¬´ë¹„"]) || 0),
          0
        );
        const expenseAmount = items.reduce(
          (sum, item) => sum + (parseFloat(item["ê²½ë¹„"]) || 0),
          0
        );

        // ê³µì‚¬ì½”ë“œ ê·¸ë£¹ í—¤ë” í–‰
        const groupRow = document.createElement("tr");
        groupRow.className = "cost-code-group-header";
        groupRow.dataset.costCode = costCode;

        // í† ê¸€ ë²„íŠ¼
        const toggleTd = document.createElement("td");
        toggleTd.className = "toggle-cell";
        const toggleBtn = document.createElement("button");
        toggleBtn.className = "cost-code-toggle-btn";
        toggleBtn.textContent = toggleSymbol;
        toggleBtn.onclick = (e) => {
          e.stopPropagation();
          toggleCostCodeGroup(costCode);
        };
        toggleTd.appendChild(toggleBtn);
        groupRow.appendChild(toggleTd);

        // ê·¸ë£¹ ì„ íƒ ì²´í¬ë°•ìŠ¤ (í•´ë‹¹ ì½”ë“œì˜ ëª¨ë“  ê°ì²´ ì„ íƒìš©)
        const groupCheckTd = document.createElement("td");
        // NEW: formula placeholder cell
        const formulaTd = document.createElement("td");
        formulaTd.className = "formula-col";
        formulaTd.textContent = activeFormulaField; // ë³´ì—¬ì£¼ê³  ì‹¶ìœ¼ë©´, ì•„ë‹ˆë©´ ""
        groupRow.appendChild(formulaTd);

        const groupCheckbox = document.createElement("input");
        groupCheckbox.type = "checkbox";
        groupCheckbox.className = "cost-code-group-checkbox";
        groupCheckbox.dataset.costCode = costCode;
        groupCheckbox.addEventListener("change", (e) => {
          handleCostCodeGroupSelection(costCode, e.target.checked);
        });
        groupCheckTd.appendChild(groupCheckbox);
        groupRow.appendChild(groupCheckTd);

        // ë°ì´í„° ì…€ë“¤ (ì„ íƒí•œ í•„ë“œë“¤ë§Œ)
        const displayData = {
          CostCode: costCode,
          ê³µì¢…: codeInfo["ê³µì¢…"] || "",
          ëª…ì¹­: codeInfo["ëª…ì¹­"] || "",
          ê·œê²©: codeInfo["ê·œê²©"] || "",
          ë‹¨ìœ„: codeInfo["ë‹¨ìœ„"] || "",
          ìˆ˜ëŸ‰: totalQuantity,
          ì¬ë£Œë¹„ë‹¨ê°€: codeInfo["ì¬ë£Œë¹„ë‹¨ê°€"] || 0,
          ì¬ë£Œë¹„: materialAmount,
          ë…¸ë¬´ë¹„ë‹¨ê°€: codeInfo["ë…¸ë¬´ë¹„ë‹¨ê°€"] || 0,
          ë…¸ë¬´ë¹„: laborAmount,
          ê²½ë¹„ë‹¨ê°€: codeInfo["ê²½ë¹„ë‹¨ê°€"] || 0,
          ê²½ë¹„: expenseAmount,
          í•©ê³„ë‹¨ê°€: codeInfo["í•©ê³„ë‹¨ê°€"] || 0,
          ì´ê¸ˆì•¡: totalAmount,
        };

        summaryVisibleFields.slice(1).forEach((field) => {
          // ì²« ë²ˆì§¸ëŠ” í† ê¸€ì´ë¯€ë¡œ ì œì™¸
          const td = document.createElement("td");
          td.className = "group-data-cell";
          let value = displayData[field] || firstItem[field];

          if (typeof value === "number") {
            value = formatNumber(value);
          }

          td.textContent = value || "";
          td.title = `${field}: ${value || ""}`;
          groupRow.appendChild(td);
        });

        // ê·¸ë£¹ í–‰ í´ë¦­ ì´ë²¤íŠ¸
        groupRow.addEventListener("click", (e) => {
          if (
            e.target.type === "checkbox" ||
            e.target.classList.contains("cost-code-toggle-btn")
          )
            return;
          handleCostCodeGroupClick(costCode, items, e);
        });

        tbody.appendChild(groupRow);

        // í¼ì³ì§„ ìƒíƒœë©´ ê°œë³„ ì•„ì´í…œë“¤ í‘œì‹œ
        if (isExpanded) {
          items.forEach((item) => {
            const detailRow = createDetailRow(item, costCode);
            tbody.appendChild(detailRow);
          });
        }
      }

      // ê°œë³„ ì•„ì´í…œ í–‰ ìƒì„±
      function createDetailRow(item, parentCostCode) {
        const tr = document.createElement("tr");
        tr.className = "cost-code-detail-row";
        tr.dataset.parentCode = parentCostCode;
        tr.dataset.uniqueKey = item._uniqueKey;
        tr.dataset.guid = item._sourceGuid;

        // ë¹ˆ í† ê¸€ ì…€
        const emptyToggleTd = document.createElement("td");
        emptyToggleTd.className = "detail-indent";
        tr.appendChild(emptyToggleTd);

        // ì²´í¬ë°•ìŠ¤
        const checkTd = document.createElement("td");
        const formulaTd = document.createElement("td");
        formulaTd.className = "formula-col";
        formulaTd.innerHTML = buildRowFormulaSelect(item);
        tr.appendChild(formulaTd);

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = item._sourceGuid;
        checkbox.className = "summary-item-checkbox";
        checkTd.appendChild(checkbox);
        tr.appendChild(checkTd);

        // ì„ íƒí•œ í•„ë“œë“¤ë§Œ í‘œì‹œ
        summaryVisibleFields.slice(1).forEach((field) => {
          // ì²« ë²ˆì§¸ëŠ” í† ê¸€ì´ë¯€ë¡œ ì œì™¸
          const td = document.createElement("td");
          td.className = "detail-data-cell";
          let value = item[field];

          if (typeof value === "number") {
            value = formatNumber(value);
          }

          td.textContent = value || "";
          td.title = `${field}: ${value || ""}`;
          tr.appendChild(td);
        });

        // í–‰ í´ë¦­ ì´ë²¤íŠ¸
        tr.addEventListener("click", (e) => {
          if (e.target.type === "checkbox") return;
          handleSummaryItemClick(item, tr, e);
        });

        return tr;
      }

      // ê³µì‚¬ì½”ë“œ ê·¸ë£¹ í† ê¸€
      function toggleCostCodeGroup(costCode) {
        if (expandedCostCodes.has(costCode)) {
          expandedCostCodes.delete(costCode);
        } else {
          expandedCostCodes.add(costCode);
        }
        renderBasicSummaryNew();
      }

      // ê³µì‚¬ì½”ë“œ ê·¸ë£¹ ì„ íƒ í•¸ë“¤ëŸ¬
      function handleCostCodeGroupSelection(costCode, isChecked) {
        const groupItems = combinedItems.filter(
          (item) => (item.CostCode || "ì½”ë“œì—†ìŒ") === costCode
        );
        const guids = groupItems
          .map((item) => item._sourceGuid)
          .filter(Boolean);

        // í•´ë‹¹ ê·¸ë£¹ì˜ ê°œë³„ ì²´í¬ë°•ìŠ¤ë“¤ë„ ì—…ë°ì´íŠ¸
        document
          .querySelectorAll(
            `tr[data-parent-code="${costCode}"] .summary-item-checkbox`
          )
          .forEach((cb) => {
            cb.checked = isChecked;
            const guid = cb.value;
            if (isChecked) {
              window.selectedGuids.add(guid);
            } else {
              window.selectedGuids.delete(guid);
            }
          });

        // 3D ë·°ì–´ ë™ê¸°í™”
        window.selectRowsByGuids(Array.from(window.selectedGuids));
        if (window.ifcViewer) {
          window.ifcViewer.setSelection(Array.from(window.selectedGuids));
        }
      }

      // ê³µì‚¬ì½”ë“œ ê·¸ë£¹ í´ë¦­ í•¸ë“¤ëŸ¬
      function handleCostCodeGroupClick(costCode, items, event) {
        const additive = event.ctrlKey || event.metaKey || event.shiftKey;

        const guids = items.map((item) => item._sourceGuid).filter(Boolean);

        if (additive) {
          guids.forEach((guid) => window.selectedGuids.add(guid));
        } else {
          window.selectedGuids.clear();
          guids.forEach((guid) => window.selectedGuids.add(guid));
        }

        window.selectRowsByGuids(Array.from(window.selectedGuids));
        if (window.ifcViewer) {
          window.ifcViewer.setSelection(Array.from(window.selectedGuids));
        }

        // ê·¸ë£¹ í–‰ í•˜ì´ë¼ì´íŠ¸
        if (!additive) {
          document
            .querySelectorAll(".cost-code-group-header")
            .forEach((r) => r.classList.remove("selected-main"));
        }
        event.currentTarget.classList.add("selected-main");
      }

      // ================================================================================================
      // í…Œì´ë¸” í—¤ë” ì—…ë°ì´íŠ¸ (í† ê¸€ ì»¬ëŸ¼ í¬í•¨)
      // ================================================================================================
      function updateSummaryTableHeader() {
        const thead = document.querySelector("#summaryTable thead tr");
        if (!thead) return;

        // ê¸°ì¡´ì—” 2ê°œ(í† ê¸€/ì²´í¬ë°•ìŠ¤)ë§Œ ê³ ì • â†’ ì´ì œ 3ê°œ(í† ê¸€/ì²´í¬ë°•ìŠ¤/ì‚°ì‹ì…€) ê³ ì •
        const FIXED_HEAD_CELLS = 3;

        while (thead.children.length > FIXED_HEAD_CELLS) {
          thead.removeChild(thead.lastChild);
        }

        // ì„ íƒí•œ í•„ë“œë“¤ë¡œ í—¤ë” ì¬êµ¬ì„± (ê¸°ì¡´ê³¼ ë™ì¼)
        summaryVisibleFields.slice(1).forEach((field) => {
          const th = document.createElement("th");
          th.textContent = field;
          thead.appendChild(th);
        });

        // ì½¤ë³´ë°•ìŠ¤ ë³´ì¥ (ë§¨ ì• ì—´)
        ensureFormulaSelectTh();
      }

      // ================================================================================================
      // ìƒˆë¡œìš´ ê³µì¢…ë³„ ë‚´ì—­ì„œ ì „ìš© ì „ì—­ ë³€ìˆ˜ë“¤
      // ================================================================================================
      let combinedItems = []; // ê°ì²´-ê³µì‚¬ì½”ë“œ ì¡°í•© ë°°ì—´
      let summaryVisibleFields = []; // ìš”ì•½í‘œì—ì„œ ë³´ì—¬ì¤„ í•„ë“œë“¤
      let summaryAllFields = []; // ìš”ì•½í‘œì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  í•„ë“œë“¤

      // ê¸°ë³¸ í‘œì‹œí•  í•„ë“œë“¤ ì •ì˜ (í† ê¸€ ì»¬ëŸ¼ì€ ë³„ë„ ì²˜ë¦¬)
      const DEFAULT_SUMMARY_FIELDS = [
        "CostCode", // ê³µì‚¬ì½”ë“œ
        "ê³µì¢…", // ê³µì‚¬ì½”ë“œ ì†ì„±
        "ëª…ì¹­", // ê³µì‚¬ì½”ë“œ ì†ì„±
        "ê·œê²©", // ê³µì‚¬ì½”ë“œ ì†ì„±
        "ë‹¨ìœ„", // ê³µì‚¬ì½”ë“œ ì†ì„±
        "ìˆ˜ëŸ‰",
        "ì¬ë£Œë¹„ë‹¨ê°€",
        "ë…¸ë¬´ë¹„ë‹¨ê°€",
        "ê²½ë¹„ë‹¨ê°€",
        "í•©ê³„ë‹¨ê°€",
        "ì´ê¸ˆì•¡",
        "GlobalId",
        "Name",
        "IfcClass",
        "SpatialContainer",
      ];

      // ==== Viewer <-> Table Sync State ====
      const guidToRow = new Map(); // guid -> <tr>
      let isSyncingFromViewer = false;
      let isSyncingFromTable = false;
      const selectedGuids = new Set(); // í˜„ì¬ ì„ íƒëœ GUIDë“¤
      let lastClickedRowIdx = -1; // shift ë²”ìœ„ ì„ íƒìš©

      // ==== Summary expandable globals ====
      let codeToObjects = new Map(); // code -> [objectData...]
      let expandedCodes = new Set(); // í¼ì³ì§„ ê³µì‚¬ì½”ë“œë“¤
      let latestSummaryData = []; // ë§ˆì§€ë§‰ìœ¼ë¡œ ë°›ì€ summary_data ì›ë³¸ ì €ì¥

      let summaryGroupBy = ""; // í•˜ìœ„ ê·¸ë£¹í•‘ ê¸°ì¤€ í•„ë“œëª…
      let summaryGroupKeys = ["", "", ""]; // 1,2,3 ë‹¨ê³„ ì„ íƒí•œ ì†ì„±
      let advExpanded = new Set(); // ê³ ê¸‰ ìš”ì•½(ì†ì„±+ì½”ë“œ) íŠ¸ë¦¬ì—ì„œ í¼ì¹œ ë…¸ë“œ í‚¤
      let advCodeExpanded = new Set(); // ì½”ë“œí–‰ í¼ì¹¨(ê°ì²´ í…Œì´ë¸”) í‚¤

      // ê³µí†µ util (ì „ì—­ ë…¸ì¶œ)
      function applyTableSelectionStyles() {
        document
          .querySelectorAll("#ifcTablecontainer_ tr.object-row")
          .forEach((tr) => {
            if (selectedGuids.has(tr.dataset.guid))
              tr.classList.add("selected-row");
            else tr.classList.remove("selected-row");
          });
      }
      function selectRowsByGuids(guidsArray) {
        selectedGuids.clear();
        guidsArray.forEach((g) => selectedGuids.add(g));
        applyTableSelectionStyles();

        // ì²´í¬ë°•ìŠ¤ ìƒíƒœë„ ë§ì¶¤
        document
          .querySelectorAll("#ifcTablecontainer_ input.object-checkbox")
          .forEach((cb) => {
            cb.checked = selectedGuids.has(cb.value);
          });

        handleObjectSelection(); // ê¸°ì¡´ ë¡œì§(ìƒì„¸í…Œì´ë¸” ê°±ì‹  ë“±) ì¬í™œìš©
      }
      function handleTableRowClick(e, guid, row) {
        const idx = parseInt(row.dataset.idx, 10);
        const additive = e.ctrlKey || e.metaKey; // ê°œë³„ í† ê¸€
        const range = e.shiftKey && lastClickedRowIdx >= 0; // ë²”ìœ„ ì„ íƒ

        if (range) {
          const rows = Array.from(
            document.querySelectorAll("#ifcTablecontainer_ tr.object-row")
          );
          const [start, end] =
            idx > lastClickedRowIdx
              ? [lastClickedRowIdx, idx]
              : [idx, lastClickedRowIdx];
          for (let i = start; i <= end; i++)
            selectedGuids.add(rows[i].dataset.guid);
        } else {
          if (!additive) selectedGuids.clear();
          if (additive && selectedGuids.has(guid)) selectedGuids.delete(guid);
          else selectedGuids.add(guid);
        }
        lastClickedRowIdx = idx;
        applyTableSelectionStyles();

        // ì²´í¬ë°•ìŠ¤ ì‹±í¬
        const cb = row.querySelector("input.object-checkbox");
        if (cb) cb.checked = selectedGuids.has(guid);

        // ë·°ì–´ë¡œ ë°˜ì˜
        if (window.ifcViewer && !isSyncingFromViewer) {
          isSyncingFromTable = true;
          window.ifcViewer.setSelection(Array.from(selectedGuids));
          isSyncingFromTable = false;
        }

        handleObjectSelection(); // ê¸°ì¡´ ìƒì„¸ í…Œì´ë¸” ë¡œì§ í˜¸ì¶œ
      }

      // ì „ì—­ì— ë…¸ì¶œ (ëª¨ë“ˆ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ í˜¸ì¶œ)
      window.selectRowsByGuids = selectRowsByGuids;
      window.applyTableSelectionStyles = applyTableSelectionStyles;
      window.isSyncingFromTable = isSyncingFromTable;
      window.isSyncingFromViewer = isSyncingFromViewer;
      window.selectedGuids = selectedGuids;
      window.guidToRow = guidToRow;
      window.handleTableRowClick = handleTableRowClick;

      // ================================================================================================
      // ì ‘ì—ˆë‹¤/í¼ì³¤ë‹¤ ê¸°ëŠ¥
      // ================================================================================================
      function toggleSection(sectionId) {
        const content = document.getElementById(sectionId + "-content");
        const icon = document.getElementById(sectionId + "-icon");

        if (content.style.display === "none") {
          content.style.display = "block";
          icon.textContent = "â–¼";
        } else {
          content.style.display = "none";
          icon.textContent = "â–¶";
        }
      }

      // ì „ì—­ì— ë…¸ì¶œ
      window.toggleSection = toggleSection;

      // ================================================================================================
      // ìƒˆë¡œìš´ ê³µì¢…ë³„ ë‚´ì—­ì„œ - ê°ì²´-ê³µì‚¬ì½”ë“œ ì¡°í•© ìƒì„± í•¨ìˆ˜
      // ================================================================================================
      function generateCombinedItems() {
        combinedItems = [];
        summaryAllFields = new Set();

        if (!Array.isArray(objectData) || Object.keys(codeData).length === 0) {
          console.log("âš ï¸ ê°ì²´ ë°ì´í„° ë˜ëŠ” ê³µì‚¬ì½”ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        objectData.forEach((obj) => {
          // CostItems ì†ì„±ì—ì„œ ê³µì‚¬ì½”ë“œë“¤ ì¶”ì¶œ
          let costItemsStr =
            obj.CostItems || (obj.Properties && obj.Properties.CostItems) || "";

          if (!costItemsStr) {
            // ê³µì‚¬ì½”ë“œê°€ ì—†ëŠ” ê²½ìš°ë„ í•˜ë‚˜ì˜ í•­ëª©ìœ¼ë¡œ ìƒì„± (ê³µì‚¬ì½”ë“œëŠ” ë¹ˆê°’)
            const combinedItem = createCombinedItem(obj, null);
            combinedItems.push(combinedItem);
            return;
          }

          // '+' êµ¬ë¶„ìë¡œ ì—¬ëŸ¬ ê³µì‚¬ì½”ë“œ ë¶„í• 
          const codes = costItemsStr
            .split("+")
            .map((code) => code.trim())
            .filter((code) => code.length > 0);

          if (codes.length === 0) {
            const combinedItem = createCombinedItem(obj, null);
            combinedItems.push(combinedItem);
          } else {
            // ê° ê³µì‚¬ì½”ë“œë³„ë¡œ ë³„ë„ í•­ëª© ìƒì„±
            codes.forEach((code) => {
              const combinedItem = createCombinedItem(obj, code);
              combinedItems.push(combinedItem);
            });
          }
        });

        // ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  í•„ë“œ ì •ë¦¬
        summaryAllFields = Array.from(summaryAllFields).sort();

        // ê¸°ë³¸ í‘œì‹œ í•„ë“œ ì„¤ì • (ì²˜ìŒ ìƒì„±ì‹œì—ë§Œ)
        if (summaryVisibleFields.length === 0) {
          summaryVisibleFields = DEFAULT_SUMMARY_FIELDS.filter((field) =>
            summaryAllFields.includes(field)
          );
        }

        console.log(`âœ… ì¡°í•© í•­ëª© ìƒì„± ì™„ë£Œ: ${combinedItems.length}ê°œ`);
        console.log(`ğŸ“Š ì‚¬ìš© ê°€ëŠ¥í•œ í•„ë“œ: ${summaryAllFields.length}ê°œ`);
      }

      // ================================================================================================
      // ê°œë³„ ì¡°í•© í•­ëª© ìƒì„± í•¨ìˆ˜
      // ================================================================================================
      function createCombinedItem(obj, costCode) {
        const combinedItem = {};

        // ê³ ìœ  í‚¤ ìƒì„± (GlobalId + ê³µì‚¬ì½”ë“œ)
        const globalId =
          obj.GlobalId || obj.globalId || obj.GUID || obj.Guid || "";
        combinedItem._uniqueKey = globalId + "|" + (costCode || "NO_CODE");
        combinedItem._sourceGuid = globalId;
        combinedItem._costCode = costCode || "";

        // 1) IFC ê°ì²´ì˜ ì§ì ‘ ì†ì„±ë“¤ ë³µì‚¬
        Object.keys(obj).forEach((key) => {
          if (key !== "Properties" && key !== "Quantities") {
            combinedItem[key] = obj[key];
            summaryAllFields.add(key);
          }
        });

        // 2) Properties ì†ì„±ë“¤ ë³µì‚¬
        if (obj.Properties && typeof obj.Properties === "object") {
          Object.keys(obj.Properties).forEach((key) => {
            const propKey = `Props_${key}`;
            combinedItem[propKey] = obj.Properties[key];
            combinedItem[key] = obj.Properties[key]; // ë‹¨ìˆœ ì´ë¦„ìœ¼ë¡œë„ ì ‘ê·¼ ê°€ëŠ¥
            summaryAllFields.add(key);
            summaryAllFields.add(propKey);
          });
        }

        // 3) Quantities ì†ì„±ë“¤ ë³µì‚¬
        if (obj.Quantities && typeof obj.Quantities === "object") {
          Object.keys(obj.Quantities).forEach((key) => {
            const qtyKey = `Qty_${key}`;
            combinedItem[qtyKey] = obj.Quantities[key];
            combinedItem[key] = obj.Quantities[key]; // ë‹¨ìˆœ ì´ë¦„ìœ¼ë¡œë„ ì ‘ê·¼ ê°€ëŠ¥
            summaryAllFields.add(key);
            summaryAllFields.add(qtyKey);
          });
        }

        // 4) ê³µì‚¬ì½”ë“œ ì •ë³´ ì¶”ê°€
        combinedItem.CostCode = costCode || "";
        summaryAllFields.add("CostCode");

        if (costCode && codeData[costCode]) {
          const codeInfo = codeData[costCode];
          Object.keys(codeInfo).forEach((key) => {
            combinedItem[key] = codeInfo[key];
            summaryAllFields.add(key);
          });
          // ì‚°ì‹ í•„ë“œê°€ ìˆìœ¼ë©´ combinedItemì—ë„ ì €ì¥
          combinedItem["ì‚°ì‹"] = codeInfo["ì‚°ì‹"] || "";
          summaryAllFields.add("ì‚°ì‹");
        }

        // 5) ê³„ì‚°ëœ í•„ë“œë“¤ (ìˆ˜ëŸ‰ * ë‹¨ê°€ ë“±)
        calculateAmountFields(combinedItem, obj, costCode);

        return combinedItem;
      }

      // ================================================================================================
      // ê¸ˆì•¡ ê³„ì‚° í•¨ìˆ˜
      // ================================================================================================
      function calculateAmountFields(combinedItem, obj, costCode) {
        // 1) ê¸°ë³¸ ìˆ˜ëŸ‰
        let quantity = parseFloat(
          combinedItem["ìˆ˜ëŸ‰"] || combinedItem.Quantity || 1
        );
        if (isNaN(quantity)) quantity = 1;

        // 2) ì‚°ì‹ì´ ìˆìœ¼ë©´ ì‚°ì‹ìœ¼ë¡œ ìˆ˜ëŸ‰ ì¬ê³„ì‚°
        let formula = "";
        if (costCode && codeData[costCode]) {
          formula = (codeData[costCode]["ì‚°ì‹"] || "").trim();
        }
        // ì´ë¯¸ createCombinedItemì—ì„œ combinedItem["ì‚°ì‹"]ë¥¼ ë„£ì—ˆìœ¼ë¯€ë¡œ ê·¸ ê°’ ì‚¬ìš©í•´ë„ ë¨
        if (!formula && combinedItem["ì‚°ì‹"]) {
          formula = String(combinedItem["ì‚°ì‹"]).trim();
        }

        if (formula) {
          quantity = evalQuantityFromFormula(formula, combinedItem);
        }

        // ìµœì¢… ìˆ˜ëŸ‰ ì €ì¥
        combinedItem["ìˆ˜ëŸ‰"] = quantity;
        summaryAllFields.add("ìˆ˜ëŸ‰");

        // 3) ë‹¨ê°€ ì •ë³´
        let materialUnitPrice = 0,
          laborUnitPrice = 0,
          expenseUnitPrice = 0,
          totalUnitPrice = 0;

        if (costCode && codeData[costCode]) {
          const codeInfo = codeData[costCode];
          materialUnitPrice = parseFloat(codeInfo["ì¬ë£Œë¹„ë‹¨ê°€"] || 0);
          laborUnitPrice = parseFloat(codeInfo["ë…¸ë¬´ë¹„ë‹¨ê°€"] || 0);
          expenseUnitPrice = parseFloat(codeInfo["ê²½ë¹„ë‹¨ê°€"] || 0);
          totalUnitPrice =
            parseFloat(codeInfo["í•©ê³„ë‹¨ê°€"] || 0) ||
            materialUnitPrice + laborUnitPrice + expenseUnitPrice;
        }

        combinedItem["ì¬ë£Œë¹„ë‹¨ê°€"] = materialUnitPrice;
        combinedItem["ë…¸ë¬´ë¹„ë‹¨ê°€"] = laborUnitPrice;
        combinedItem["ê²½ë¹„ë‹¨ê°€"] = expenseUnitPrice;
        combinedItem["í•©ê³„ë‹¨ê°€"] = totalUnitPrice;

        combinedItem["ì¬ë£Œë¹„"] = quantity * materialUnitPrice;
        combinedItem["ë…¸ë¬´ë¹„"] = quantity * laborUnitPrice;
        combinedItem["ê²½ë¹„"] = quantity * expenseUnitPrice;
        combinedItem["ì´ê¸ˆì•¡"] = quantity * totalUnitPrice;

        [
          "ì¬ë£Œë¹„ë‹¨ê°€",
          "ë…¸ë¬´ë¹„ë‹¨ê°€",
          "ê²½ë¹„ë‹¨ê°€",
          "í•©ê³„ë‹¨ê°€",
          "ì¬ë£Œë¹„",
          "ë…¸ë¬´ë¹„",
          "ê²½ë¹„",
          "ì´ê¸ˆì•¡",
        ].forEach((f) => summaryAllFields.add(f));
      }

      // ================================================================================================
      // ìƒˆë¡œìš´ ìš”ì•½ í…Œì´ë¸” ë¡œë“œ í•¨ìˆ˜ (ê¸°ì¡´ loadSummaryTable ëŒ€ì²´)
      // ================================================================================================
      function loadSummaryTable() {
        console.log("ğŸ”„ ìƒˆë¡œìš´ ë°©ì‹ìœ¼ë¡œ ê³µì¢…ë³„ ë‚´ì—­ì„œ ìƒì„± ì¤‘...");

        // ì¡°í•© í•­ëª©ë“¤ ìƒì„±
        generateCombinedItems();
        formulaFields = collectFormulaFields();
        ensureFormulaSelectTh(); // ì½¤ë³´ë°•ìŠ¤ ìƒì„±/ê°±ì‹ 
        renderSummaryFieldSelector(); // âœ… ë¦¬ìŠ¤íŠ¸ ì±„ìš°ê¸°
        recalcQuantitiesByFormula(activeFormulaField);
        console.log(
          `âœ… ê³µì¢…ë³„ ë‚´ì—­ì„œ ë¡œë“œ ì™„ë£Œ: ${combinedItems.length}ê°œ í•­ëª©`
        );
      }

      // ================================================================================================
      // í•„ë“œ ì„ íƒ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤
      // ================================================================================================
      function handleSummaryFieldToggle() {
        const checkedBoxes = document.querySelectorAll(
          "#summaryFieldCheckboxes input:checked"
        );
        summaryVisibleFields = Array.from(checkedBoxes).map((cb) => cb.value);
        refreshSummaryTable();
      }

      function selectAllSummaryFields(select) {
        const checkboxes = document.querySelectorAll(
          "#summaryFieldCheckboxes input"
        );
        checkboxes.forEach((cb) => (cb.checked = select));
        handleSummaryFieldToggle();
      }

      function resetDefaultSummaryFields() {
        summaryVisibleFields = DEFAULT_SUMMARY_FIELDS.filter((field) =>
          summaryAllFields.includes(field)
        );

        // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
        const checkboxes = document.querySelectorAll(
          "#summaryFieldCheckboxes input"
        );
        checkboxes.forEach((cb) => {
          cb.checked = summaryVisibleFields.includes(cb.value);
        });

        refreshSummaryTable();
      }

      // ================================================================================================
      // ìƒˆë¡œìš´ í…Œì´ë¸” ë Œë”ë§ (ê¸°ì¡´ refreshSummaryTable ìˆ˜ì •)
      // ================================================================================================
      function refreshSummaryTable() {
        // ê·¸ë£¹í•‘ì´ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ê³ ê¸‰ ìš”ì•½ ë°©ì‹ ì‚¬ìš©
        if (summaryGroupKeys && summaryGroupKeys.some((k) => k)) {
          renderAdvancedSummaryNew();
          return;
        }

        // ê¸°ë³¸ ë°©ì‹: ë‹¨ìˆœ ë¦¬ìŠ¤íŠ¸
        renderBasicSummaryNew();
      }

      // ================================================================================================
      // ìš”ì•½í‘œ í•­ëª© í´ë¦­ í•¸ë“¤ëŸ¬
      // ================================================================================================
      function handleSummaryItemClick(item, row, event) {
        const additive = event.ctrlKey || event.metaKey || event.shiftKey;

        // í•´ë‹¹ ê°ì²´ ì„ íƒ
        if (item._sourceGuid) {
          const guids = additive
            ? Array.from(window.selectedGuids).concat([item._sourceGuid])
            : [item._sourceGuid];

          window.selectRowsByGuids([...new Set(guids)]);

          if (window.ifcViewer) {
            window.ifcViewer.setSelection([...new Set(guids)]);
          }
        }

        // í…Œì´ë¸” í–‰ í•˜ì´ë¼ì´íŠ¸
        if (!additive) {
          document
            .querySelectorAll(".summary-item-row")
            .forEach((r) => r.classList.remove("selected-main"));
        }
        row.classList.add("selected-main");
      }

      // ================================================================================================
      // ê³ ê¸‰ ìš”ì•½ ë Œë”ë§ (ê·¸ë£¹í•‘ ì ìš©) - í† ê¸€ ì»¬ëŸ¼ ì§€ì›
      // ================================================================================================
      function renderAdvancedSummaryNew() {
        const tbody = document.getElementById("summaryTableBody");
        if (!tbody) return;

        tbody.innerHTML = "";
        updateSummaryTableHeader();

        // ê·¸ë£¹í•‘ëœ íŠ¸ë¦¬ êµ¬ì¶•
        const tree = buildGroupedTree(
          combinedItems,
          summaryGroupKeys.filter((k) => k)
        );

        // ë Œë”ë§
        renderGroupedTreeNew(tbody, tree, 0, "");

        console.log(`âœ… ê³ ê¸‰ ìš”ì•½í‘œ ë Œë”ë§ ì™„ë£Œ`);
      }

      function buildGroupedTree(items, groupKeys) {
        if (groupKeys.length === 0) return { items };

        const grouped = {};
        const key = groupKeys[0];

        items.forEach((item) => {
          let value = item[key] || "N/A";
          if (!grouped[value]) {
            grouped[value] = [];
          }
          grouped[value].push(item);
        });

        Object.keys(grouped).forEach((value) => {
          if (groupKeys.length > 1) {
            grouped[value] = buildGroupedTree(
              grouped[value],
              groupKeys.slice(1)
            );
          } else {
            grouped[value] = { items: grouped[value] };
          }
        });

        return grouped;
      }

      function renderGroupedTreeNew(tbody, tree, depth, pathKey) {
        Object.entries(tree).forEach(([key, value]) => {
          if (key === "items") {
            // ë¦¬í”„ ë…¸ë“œ - ì‹¤ì œ ì•„ì´í…œë“¤ ë Œë”ë§
            value.forEach((item) => {
              const tr = document.createElement("tr");
              tr.className = "summary-item-row";
              tr.dataset.uniqueKey = item._uniqueKey;
              tr.dataset.guid = item._sourceGuid;

              // ë¹ˆ í† ê¸€ ì…€
              const emptyToggleTd = document.createElement("td");
              tr.appendChild(emptyToggleTd);

              // ì²´í¬ë°•ìŠ¤
              const checkTd = document.createElement("td");
              const checkbox = document.createElement("input");
              checkbox.type = "checkbox";
              checkbox.value = item._sourceGuid;
              checkbox.className = "summary-item-checkbox";
              checkTd.appendChild(checkbox);
              tr.appendChild(checkTd);
              const formulaTd = document.createElement("td");
              formulaTd.className = "formula-col";
              tr.appendChild(formulaTd);

              // ë°ì´í„° ì…€ë“¤
              summaryVisibleFields.forEach((field) => {
                const td = document.createElement("td");
                let val = item[field];
                if (typeof val === "number") val = formatNumber(val);
                td.textContent = val || "";
                tr.appendChild(td);
              });

              tr.addEventListener("click", (e) => {
                if (e.target.type === "checkbox") return;
                handleSummaryItemClick(item, tr, e);
              });

              tbody.appendChild(tr);
            });
          } else {
            // ê·¸ë£¹ í—¤ë”
            const currentPath = pathKey + "|" + key;
            const isExpanded = !advExpanded.has(currentPath);
            const symbol = isExpanded ? "â–¼" : "â–¶";

            const tr = document.createElement("tr");
            tr.className = "adv-group-header";

            // ë¹ˆ í† ê¸€ ì…€
            const emptyToggleTd = document.createElement("td");
            tr.appendChild(emptyToggleTd);

            const td = document.createElement("td");
            td.colSpan = summaryVisibleFields.length + 1; // +1 for checkbox column
            td.textContent = `${" ".repeat(depth * 2)}${symbol} ${key}`;
            tr.appendChild(td);

            tr.addEventListener("click", () => {
              if (isExpanded) advExpanded.add(currentPath);
              else advExpanded.delete(currentPath);
              renderAdvancedSummaryNew();
            });

            tbody.appendChild(tr);

            if (isExpanded) {
              renderGroupedTreeNew(tbody, value, depth + 1, currentPath);
            }
          }
        });
      }

      // ================================================================================================
      // ìš”ì•½í‘œ ì „ìš© ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë“¤ (ê³µì‚¬ì½”ë“œ ê·¸ë£¹í•‘ ì§€ì›)
      // ================================================================================================
      function setupSummaryEventHandlers() {
        // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ (ìš”ì•½í‘œìš©)
        document.addEventListener("change", function (e) {
          if (e.target.id === "summarySelectAllCheckbox") {
            const isChecked = e.target.checked;

            // ê°œë³„ ì•„ì´í…œ ì²´í¬ë°•ìŠ¤ë“¤
            const itemCheckboxes = document.querySelectorAll(
              ".summary-item-checkbox"
            );
            itemCheckboxes.forEach((cb) => (cb.checked = isChecked));

            // ê³µì‚¬ì½”ë“œ ê·¸ë£¹ ì²´í¬ë°•ìŠ¤ë“¤
            const groupCheckboxes = document.querySelectorAll(
              ".cost-code-group-checkbox"
            );
            groupCheckboxes.forEach((cb) => (cb.checked = isChecked));

            // ì„ íƒëœ GUIDë“¤ ìˆ˜ì§‘
            const guids = Array.from(itemCheckboxes)
              .filter((cb) => cb.checked)
              .map((cb) => cb.value)
              .filter(Boolean);

            window.selectRowsByGuids(guids);
            if (window.ifcViewer) {
              window.ifcViewer.setSelection(guids);
            }
          }
        });

        // ê°œë³„ ì•„ì´í…œ ì²´í¬ë°•ìŠ¤
        document.addEventListener("change", function (e) {
          if (e.target.classList.contains("summary-item-checkbox")) {
            updateCheckboxStates();

            // ë·°ì–´ì™€ í…Œì´ë¸” ë™ê¸°í™”
            const checkedBoxes = document.querySelectorAll(
              ".summary-item-checkbox:checked"
            );
            const guids = Array.from(checkedBoxes)
              .map((cb) => cb.value)
              .filter(Boolean);
            window.selectRowsByGuids(guids);
            if (window.ifcViewer) {
              window.ifcViewer.setSelection(guids);
            }
          }
        });

        // ê³µì‚¬ì½”ë“œ ê·¸ë£¹ ì²´í¬ë°•ìŠ¤ëŠ” ì´ë¯¸ renderCostCodeGroupì—ì„œ ì²˜ë¦¬ë¨
      }

      document.addEventListener("change", function (e) {
        if (!e.target.classList.contains("row-formula")) return;
        const key = e.target.dataset.uk;
        const field = e.target.value;
        rowFormulaMap.set(key, field); // ì„ íƒ ì €ì¥
        const item = combinedItems.find((it) => it._uniqueKey === key);
        if (item) {
          recalcOneItem(item);
          refreshSummaryTable(); // ê°„ë‹¨íˆ ì „ì²´ ë‹¤ì‹œ ê·¸ë¦¼ (í† ê¸€/í¼ì¹¨ ìƒíƒœëŠ” set ë“¤ë¡œ ìœ ì§€)
        }
      });

      // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì „ì²´ì„ íƒ, ê·¸ë£¹ì„ íƒ ìƒíƒœ ë™ê¸°í™”)
      function updateCheckboxStates() {
        const itemCheckboxes = document.querySelectorAll(
          ".summary-item-checkbox"
        );
        const checkedItems = document.querySelectorAll(
          ".summary-item-checkbox:checked"
        );
        const groupCheckboxes = document.querySelectorAll(
          ".cost-code-group-checkbox"
        );

        // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ
        const selectAllBox = document.getElementById(
          "summarySelectAllCheckbox"
        );
        if (selectAllBox) {
          selectAllBox.checked =
            itemCheckboxes.length > 0 &&
            checkedItems.length === itemCheckboxes.length;
          selectAllBox.indeterminate =
            checkedItems.length > 0 &&
            checkedItems.length < itemCheckboxes.length;
        }

        // ê° ê·¸ë£¹ì˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
        groupCheckboxes.forEach((groupCb) => {
          const costCode = groupCb.dataset.costCode;
          const groupItems = document.querySelectorAll(
            `tr[data-parent-code="${costCode}"] .summary-item-checkbox`
          );
          const checkedGroupItems = document.querySelectorAll(
            `tr[data-parent-code="${costCode}"] .summary-item-checkbox:checked`
          );

          if (groupItems.length > 0) {
            groupCb.checked = checkedGroupItems.length === groupItems.length;
            groupCb.indeterminate =
              checkedGroupItems.length > 0 &&
              checkedGroupItems.length < groupItems.length;
          }
        });
      }

      // í˜ì´ì§€ ë¡œë”© ì‹œ ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€
      document.addEventListener("DOMContentLoaded", async function () {
        await loadDefaultCostCodes(); // âœ… ë°˜ë“œì‹œ ê¸°ë‹¤ë¦¼
        await loadIFCObjects(); // ê°ì²´ ë¡œë”©
        loadSummaryTable(); // ìš”ì•½í‘œ ìƒì„±
        renderSummaryFieldSelector(); // í•„ë“œ ì„ íƒ UI
        initSummaryGroupingUI();
        setupEventHandlers();
        setupSummaryEventHandlers();
      });

      // ê¸°ë³¸ ì½”ë“œë¦¬ìŠ¤íŠ¸ ë¡œë“œ
      // ê¸°ë³¸ ì½”ë“œë¦¬ìŠ¤íŠ¸ ë¡œë“œ (ìºì‹œ ë¬´ì‹œ + ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼)
      async function loadDefaultCostCodes() {
        try {
          const url = `{% static 'references/CodeList.csv' %}?v=${Date.now()}`;
          const res = await fetch(url, { cache: "no-store" });
          if (!res.ok) {
            console.log("ê¸°ë³¸ CodeList.csv íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }
          const text = await res.text();
          if (text) {
            parseCostCodesFromCSV(text); // codeData ê°±ì‹ 
            uploadParsedCodesToServer(); // ì„œë²„ì—ë„ ì—…ë¡œë“œ(ê¸°ì¡´ í•¨ìˆ˜ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
            console.log(
              "ê¸°ë³¸ ì½”ë“œë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì™„ë£Œ:",
              Object.keys(codeData).length + "ê±´"
            );
          }
        } catch (err) {
          console.error("ê¸°ë³¸ ì½”ë“œë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:", err);
        }
      }

      function initSummaryGroupingUI() {
        const sels = [
          document.getElementById("summaryGroup1"),
          document.getElementById("summaryGroup2"),
          document.getElementById("summaryGroup3"),
        ];
        if (!sels.every(Boolean)) return;

        // ìµœì´ˆ í•œ ë²ˆë§Œ ì˜µì…˜ ë„£ê³ , ì´í›„ì—” loadIFCObjects í›„ ë‹¤ì‹œ í˜¸ì¶œ ê°€ëŠ¥
        populateSummaryGroupCombos();

        sels.forEach((sel, idx) => {
          sel.addEventListener("change", () => {
            summaryGroupKeys[idx] = sel.value || "";
            refreshSummaryTable(); // ì„ íƒ ë°”ë€Œë©´ ìš”ì•½ ê°±ì‹ 
          });
        });
      }
      function populateSummaryGroupCombos() {
        // ê¸°ì¡´ IFC ê°ì²´ í—¤ë”ë“¤ê³¼ ìƒˆë¡œìš´ ì¡°í•© í•„ë“œë“¤ í•©ì¹˜ê¸°
        const allHeaders = new Set([...headers, ...summaryAllFields]);
        const choices = [...allHeaders].sort((a, b) => a.localeCompare(b));

        ["summaryGroup1", "summaryGroup2", "summaryGroup3"].forEach((id) => {
          const sel = document.getElementById(id);
          if (!sel) return;
          const current = sel.value;
          sel.innerHTML = '<option value="">ì—†ìŒ</option>';
          choices.forEach((h) => {
            const op = document.createElement("option");
            op.value = h;
            op.textContent = h;
            sel.appendChild(op);
          });
          if (current && choices.includes(current)) sel.value = current;
        });

        summaryGroupKeys = [
          document.getElementById("summaryGroup1")?.value || "",
          document.getElementById("summaryGroup2")?.value || "",
          document.getElementById("summaryGroup3")?.value || "",
        ];
      }

      // íŒŒì‹±ëœ ì½”ë“œë¥¼ ì„œë²„ì— ì—…ë¡œë“œ (API ê²½ë¡œ ìˆ˜ì •)
      function uploadParsedCodesToServer() {
        if (Object.keys(codeData).length === 0) return;

        console.log(
          "ğŸ“¤ ì„œë²„ì— ê³µì‚¬ì½”ë“œ ì—…ë¡œë“œ ì‹œë„ ì¤‘...",
          Object.keys(codeData).length + "ê±´"
        );

        // CSV í˜•íƒœë¡œ ë³€í™˜
        const csvLines = [
          "ì½”ë“œ,ê³µì¢…,ëª…ì¹­,ê·œê²©,ë‹¨ìœ„,ì‚°ì‹,ì¬ë£Œë¹„ë‹¨ê°€,ë…¸ë¬´ë¹„ë‹¨ê°€,ê²½ë¹„ë‹¨ê°€,í•©ê³„ë‹¨ê°€",
        ];
        Object.entries(codeData).forEach(([code, data]) => {
          const line = [
            code,
            data["ê³µì¢…"] || "",
            data["ëª…ì¹­"] || "",
            data["ê·œê²©"] || "",
            data["ë‹¨ìœ„"] || "",
            data["ì‚°ì‹"] || "",
            data["ì¬ë£Œë¹„ë‹¨ê°€"] || "0",
            data["ë…¸ë¬´ë¹„ë‹¨ê°€"] || "0",
            data["ê²½ë¹„ë‹¨ê°€"] || "0",
            data["í•©ê³„ë‹¨ê°€"] || "0",
          ].join(",");
          csvLines.push(line);
        });

        const csvContent = csvLines.join("\n");
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });

        const formData = new FormData();
        formData.append("csv_file", blob, "CodeList.csv");

        fetch("/dd_by_ifc/api/load_cost_codes/", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log("âœ… ì„œë²„ì— ê³µì‚¬ì½”ë“œ ì—…ë¡œë“œ ì™„ë£Œ:", data.message);
              console.log("ğŸ“Š ì „ì²´ ê³µì‚¬ì½”ë“œ ìˆ˜:", data.total_codes + "ê°œ");
            } else {
              console.warn("âš ï¸ ê³µì‚¬ì½”ë“œ ì—…ë¡œë“œ ì¤‘ ë¬¸ì œ:", data.error);
            }
          })
          .catch((error) => {
            console.error("âŒ ì„œë²„ ì—…ë¡œë“œ ì‹¤íŒ¨:", error);
          });
      }

      // CSV í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±í•˜ì—¬ codeData ê°ì²´ ìƒì„±
      function parseCostCodesFromCSV(csvText) {
        const lines = csvText.split(/\r?\n/).filter((x) => x.trim());
        if (lines.length < 2) return;

        const cols = lines[0].split(",").map((x) => x.trim());
        codeData = {};

        for (let i = 1; i < lines.length; i++) {
          const row = lines[i].split(",").map((x) => x.trim());
          const code = row[cols.indexOf("ì½”ë“œ")];
          if (!code) continue;

          codeData[code] = {};
          cols.forEach((col, j) => {
            codeData[code][col] = row[j] || "";
          });
        }
      }

      // IFC ê°ì²´ ë°ì´í„° ë¡œë“œ (API ê²½ë¡œ ìˆ˜ì •)
      function loadIFCObjects() {
        const url = `/dd_by_ifc/api/ifc_objects/${PROJECT_ID}/`;

        return fetch(url, {
          method: "GET",
          headers: { Accept: "application/json" },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            // ê¸°ë³¸ ì‘ë‹µ ê²€ì¦
            if (!data || !Array.isArray(data.objects)) {
              throw new Error("ì„œë²„ ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }

            // ì´ì „ ì„ íƒ ìƒíƒœ ë³´ì¡´
            const prevSelected = new Set(window.selectedGuids || []);

            // ì „ì—­ ë°ì´í„° ì„¸íŒ…
            objectData = data.objects;
            headers = data.headers || [];

            // ì½”ë“œ â†” ê°ì²´ ë§¤í•‘ ê°±ì‹  (ìš”ì•½í‘œ í•˜ìœ„ í¼ì¹˜ê¸°ìš©)
            if (typeof buildCodeToObjectsMap === "function") {
              buildCodeToObjectsMap();
            }

            // ==== UI ê°±ì‹  ====
            updateGroupComboBoxes();
            updateColumnSelector();
            updateGroupedTable();

            // â˜…â˜…â˜… ì—¬ê¸° ì¶”ê°€ â˜…â˜…â˜…
            if (typeof populateSummaryGroupCombos === "function") {
              populateSummaryGroupCombos();
            }
            if (typeof loadSummaryTable === "function") loadSummaryTable(); // ìƒˆë¡œìš´ ë°©ì‹ìœ¼ë¡œ ìš”ì•½í‘œ ë‹¤ì‹œ ë¡œë“œ

            // ì„ íƒ ìœ ì§€ & ìŠ¤íƒ€ì¼ ë°˜ì˜
            if (prevSelected.size) {
              window.selectRowsByGuids
                ? window.selectRowsByGuids(Array.from(prevSelected))
                : (window.selectedGuids = prevSelected);
              if (typeof applyTableSelectionStyles === "function") {
                applyTableSelectionStyles();
              }
            }

            console.log(
              `âœ… IFC ê°ì²´ ë¡œë“œ ì™„ë£Œ: ${
                data.total_count ?? objectData.length
              }ê°œ`
            );

            // ì´ë¯¸ ìƒì„¸ ì„ íƒ ì¤‘ì´ë©´ ë‹¤ì‹œ ë¡œë“œ
            if (
              Array.isArray(selectedObjectIds) &&
              selectedObjectIds.length > 0
            ) {
              setTimeout(() => {
                if (typeof loadObjectDetails === "function")
                  loadObjectDetails();
              }, 0);
            }

            return data; // Promise ì²´ì´ë‹ìš©
          })
          .catch((error) => {
            console.error("âŒ IFC ê°ì²´ ë¡œë“œ ì‹¤íŒ¨:", error);
            if (typeof showNotification === "function") {
              showNotification(`IFC ê°ì²´ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, "error");
            }
            alert("IFC ê°ì²´ë¥¼ ë¡œë“œí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
            throw error;
          });
      }

      // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
      function setupEventHandlers() {
        // ê²€ìƒ‰ ê¸°ëŠ¥
        document
          .getElementById("searchBox")
          .addEventListener("input", searchCostCodes);

        // ë²„íŠ¼ ì´ë²¤íŠ¸
        document
          .getElementById("addCodeBtn")
          .addEventListener("click", addCostCodeToObjects);
        document
          .getElementById("removeCodeBtn")
          .addEventListener("click", removeCostCodeFromObjects);
        document.getElementById("loadCodeBtn").addEventListener("click", () => {
          document.getElementById("codeFileInput").click();
        });

        // íŒŒì¼ ì—…ë¡œë“œ
        document
          .getElementById("codeFileInput")
          .addEventListener("change", handleCostCodeFileUpload);

        // ê·¸ë£¹ ì½¤ë³´ë°•ìŠ¤
        for (let i = 1; i <= 3; i++) {
          document
            .getElementById("groupBy" + i)
            .addEventListener("change", updateGroupedTable);
        }

        // ì»¬ëŸ¼ ì„ íƒ ë²„íŠ¼ë“¤
        document
          .getElementById("selectAllColumnsBtn")
          .addEventListener("click", () => selectAllColumns(true));
        document
          .getElementById("deselectAllColumnsBtn")
          .addEventListener("click", () => selectAllColumns(false));

        // â˜…â˜…â˜… ì´ê¸ˆì•¡ ì¬ê³„ì‚° ë²„íŠ¼ ì´ë²¤íŠ¸ â˜…â˜…â˜…
        const recalculateBtn = document.getElementById("recalculateAmountsBtn");
        if (recalculateBtn) {
          recalculateBtn.addEventListener("click", recalculateAllAmounts);
        }
      }

      // ì´ê¸ˆì•¡ ì¬ê³„ì‚° í•¨ìˆ˜
      async function recalculateAllAmounts() {
        const btn = document.getElementById("recalculateAmountsBtn");
        if (!btn) return;

        if (
          !confirm(
            "ëª¨ë“  ê°ì²´ì˜ ì´ê¸ˆì•¡ì„ ë‹¤ì‹œ ê³„ì‚°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê°ì²´ ìˆ˜ê°€ ë§ìœ¼ë©´ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)"
          )
        ) {
          return;
        }

        const originalText = btn.textContent;
        btn.disabled = true;
        btn.innerHTML = `
    <div class="spinner-border spinner-border-sm" role="status" style="width: 14px; height: 14px;"></div>
    ê³„ì‚° ì¤‘...
  `;

        try {
          console.log("ğŸ”„ ì´ê¸ˆì•¡ ì¬ê³„ì‚° ì‹œì‘...");

          const response = await fetch(
            `/dd_by_ifc/api/recalculate_amounts/${PROJECT_ID}/`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          const data = await response.json();

          if (data.success) {
            console.log(`âœ… ${data.message}`);
            showNotification(data.message, "success");

            // í…Œì´ë¸”ë“¤ ìƒˆë¡œê³ ì¹¨
            console.log("ğŸ“Š í…Œì´ë¸” ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì¤‘...");
            await Promise.all([
              loadIFCObjects(),
              loadSummaryTable(),
              selectedObjectIds.length > 0
                ? loadObjectDetails()
                : Promise.resolve(),
            ]);

            console.log("âœ… ëª¨ë“  ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ");
          } else {
            throw new Error(data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
          }
        } catch (error) {
          console.error("âŒ ì´ê¸ˆì•¡ ì¬ê³„ì‚° ì‹¤íŒ¨:", error);
          showNotification(`âŒ ì´ê¸ˆì•¡ ì¬ê³„ì‚° ì‹¤íŒ¨: ${error.message}`, "error");
          alert(`ì´ê¸ˆì•¡ ì¬ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}`);
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }
      // ê°œì„ ëœ ì•Œë¦¼ í•¨ìˆ˜ (ì—ëŸ¬ íƒ€ì… ì¶”ê°€)
      function showNotification(message, type = "info") {
        // ê¸°ì¡´ ì•Œë¦¼ì´ ìˆìœ¼ë©´ ì œê±°
        const existingNotification =
          document.getElementById("notification-toast");
        if (existingNotification) {
          existingNotification.remove();
        }

        // íƒ€ì…ë³„ ìƒ‰ìƒ ì„¤ì •
        const colors = {
          success: "#28a745",
          warning: "#ffc107",
          error: "#dc3545",
          info: "#17a2b8",
        };

        // ìƒˆ ì•Œë¦¼ ìƒì„±
        const notification = document.createElement("div");
        notification.id = "notification-toast";
        notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    background-color: ${colors[type] || colors.info};
    color: white;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    z-index: 10000;
    font-size: 14px;
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
    cursor: pointer;
  `;
        notification.textContent = message;

        // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
        if (!document.getElementById("notification-styles")) {
          const styles = document.createElement("style");
          styles.id = "notification-styles";
          styles.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
      .spinner-border-sm {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 0.125em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border 0.75s linear infinite;
      }
      @keyframes spinner-border {
        to { transform: rotate(360deg); }
      }
    `;
          document.head.appendChild(styles);
        }

        document.body.appendChild(notification);

        // ìë™ ì œê±° ì‹œê°„ (ì—ëŸ¬ëŠ” ë” ì˜¤ë˜ í‘œì‹œ)
        const autoRemoveTime = type === "error" ? 5000 : 3000;

        setTimeout(() => {
          if (notification.parentNode) {
            notification.style.animation = "slideOut 0.3s ease-in";
            setTimeout(() => {
              if (notification.parentNode) {
                notification.remove();
              }
            }, 300);
          }
        }, autoRemoveTime);

        // í´ë¦­ì‹œ ì¦‰ì‹œ ì œê±°
        notification.addEventListener("click", () => {
          notification.style.animation = "slideOut 0.3s ease-in";
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 300);
        });
      }
      // ê³µì‚¬ì½”ë“œ ê²€ìƒ‰
      function searchCostCodes() {
        const query = document
          .getElementById("searchBox")
          .value.trim()
          .toLowerCase();
        const resultsContainer = document.getElementById("searchResults");
        resultsContainer.innerHTML = "";

        if (!query || Object.keys(codeData).length === 0) return;

        Object.entries(codeData).forEach(([code, data]) => {
          if (
            code.toLowerCase().includes(query) ||
            (data["ëª…ì¹­"] || "").toLowerCase().includes(query)
          ) {
            const li = document.createElement("li");
            li.textContent = `${code} - ${data["ëª…ì¹­"]} (${data["ê·œê²©"]}, ${data["ë‹¨ìœ„"]})`;
            li.onclick = () => selectCostCode(code, li);
            resultsContainer.appendChild(li);
          }
        });
      }

      // ê³µì‚¬ì½”ë“œ ì„ íƒ
      function selectCostCode(code, element) {
        document
          .querySelectorAll("#searchResults li")
          .forEach((li) => li.classList.remove("selected"));
        element.classList.add("selected");
        selectedCode = code;
      }

      // ê·¸ë£¹ ì½¤ë³´ë°•ìŠ¤ ì—…ë°ì´íŠ¸
      function updateGroupComboBoxes() {
        for (let i = 1; i <= 3; i++) {
          const combo = document.getElementById("groupBy" + i);
          const currentValue = combo.value;
          combo.innerHTML = "<option>ì—†ìŒ</option>";

          // í—¤ë”ë“¤ì„ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
          const sortedHeaders = [...headers].sort((a, b) => a.localeCompare(b));

          sortedHeaders.forEach((header) => {
            const option = document.createElement("option");
            option.value = header;
            option.textContent = header;
            combo.appendChild(option);
          });

          if (currentValue && headers.includes(currentValue)) {
            combo.value = currentValue;
          }
        }
      }

      // ì»¬ëŸ¼ ì„ íƒ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
      function updateColumnSelector() {
        const container = document.getElementById("columnCheckboxes");
        container.innerHTML = "";

        // ê¸°ë³¸ì ìœ¼ë¡œ ì²˜ìŒ 6ê°œ ì»¬ëŸ¼ë§Œ ì„ íƒ
        const defaultVisibleColumns = [
          "GlobalId",
          "Name",
          "IfcClass",
          "CostItems",
          "ì´ê¸ˆì•¡",
          "SpatialContainer",
        ];

        if (visibleHeaders.length === 0) {
          visibleHeaders = headers.filter((h) =>
            defaultVisibleColumns.includes(h)
          );
        }

        headers.forEach((header) => {
          const div = document.createElement("div");
          div.className = "column-checkbox";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `col_${header}`;
          checkbox.value = header;
          checkbox.checked = visibleHeaders.includes(header);
          checkbox.addEventListener("change", handleColumnToggle);

          const label = document.createElement("label");
          label.htmlFor = `col_${header}`;
          label.textContent = header;

          div.appendChild(checkbox);
          div.appendChild(label);
          container.appendChild(div);
        });
      }

      // ì»¬ëŸ¼ í† ê¸€ ì²˜ë¦¬
      function handleColumnToggle() {
        const checkedBoxes = document.querySelectorAll(
          '#columnCheckboxes input[type="checkbox"]:checked'
        );
        visibleHeaders = Array.from(checkedBoxes).map((cb) => cb.value);
        updateGroupedTable();
      }

      // ëª¨ë“  ì»¬ëŸ¼ ì„ íƒ/í•´ì œ
      function selectAllColumns(select) {
        const checkboxes = document.querySelectorAll(
          '#columnCheckboxes input[type="checkbox"]'
        );
        checkboxes.forEach((cb) => (cb.checked = select));
        handleColumnToggle();
      }

      // ê·¸ë£¹í™”ëœ í…Œì´ë¸” ì—…ë°ì´íŠ¸
      function updateGroupedTable() {
        const container = document.getElementById("ifcTablecontainer_");
        if (!container) return;

        // ì´ˆê¸°í™”
        container.innerHTML = "";
        guidToRow.clear();

        // ê·¸ë£¹ í‚¤ ìˆ˜ì§‘
        const groupKeys = [];
        for (let i = 1; i <= 3; i++) {
          const v = document.getElementById("groupBy" + i)?.value;
          if (v && v !== "ì—†ìŒ") groupKeys.push(v);
        }

        // visibleHeaders ê¸°ë³¸ê°’ ë³´ì •
        if (!Array.isArray(visibleHeaders) || visibleHeaders.length === 0) {
          visibleHeaders = (headers || []).slice(0, 6); // í˜¹ì‹œ ë¹„ì–´ìˆìœ¼ë©´ ì• 6ê°œ ì„ì‹œ
        }

        // í…Œì´ë¸” ê³¨ê²©
        const table = document.createElement("table");
        table.className = "table table-bordered aibim-table";

        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");

        // ì „ì²´ì„ íƒ ì²´í¬ë°•ìŠ¤
        const cbTh = document.createElement("th");
        cbTh.innerHTML = '<input type="checkbox" id="selectAllCheckbox">';
        headerRow.appendChild(cbTh);

        // ë°ì´í„° í—¤ë”
        visibleHeaders.forEach((h) => {
          const th = document.createElement("th");
          th.textContent = h.split(".").pop();
          headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        table.appendChild(tbody);
        container.appendChild(table);

        // row index (shift ì„ íƒìš©)
        let rowCounter = 0;

        // ===== ë‚´ë¶€ í—¬í¼ë“¤ =====
        function renderGroup(tbody, groupedData, depth) {
          Object.entries(groupedData).forEach(([groupValue, content]) => {
            const groupKey = `${groupKeys[depth]}:${groupValue}`;
            const isCollapsed = collapsedGroups.has(groupKey);
            const symbol = isCollapsed ? "â–¶" : "â–¼";

            // ê·¸ë£¹ í—¤ë” í–‰
            const gRow = document.createElement("tr");
            gRow.className = "group-header";
            gRow.style.backgroundColor = "#f0f0f0";
            gRow.style.fontWeight = "bold";
            gRow.style.cursor = "pointer";

            const gCell = document.createElement("td");
            gCell.colSpan = visibleHeaders.length + 1; // +1 ì€ ì²´í¬ë°•ìŠ¤ ì—´
            gCell.textContent = `${" ".repeat(depth * 2)}${symbol} ${
              groupKeys[depth]
            }: ${groupValue}`;
            gRow.appendChild(gCell);

            gRow.addEventListener("click", () => toggleGroup(groupKey));
            tbody.appendChild(gRow);

            if (!isCollapsed) {
              if (Array.isArray(content)) {
                content.forEach((obj) => {
                  const row = createObjectRow(obj, rowCounter++);
                  tbody.appendChild(row);
                });
              } else {
                renderGroup(tbody, content, depth + 1);
              }
            }
          });
        }

        function groupObjectsByKeysLocal(objects, keys, depth = 0) {
          if (depth >= keys.length) return objects;
          const grouped = {};
          const key = keys[depth];

          objects.forEach((obj) => {
            let v = obj[key];
            if (v === undefined && obj.Quantities) v = obj.Quantities[key];
            if (v === undefined && obj.Properties) v = obj.Properties[key];
            if (v === undefined) v = "N/A";
            if (!grouped[v]) grouped[v] = [];
            grouped[v].push(obj);
          });

          Object.keys(grouped).forEach((k) => {
            grouped[k] = groupObjectsByKeysLocal(grouped[k], keys, depth + 1);
          });
          return grouped;
        }

        // ===== ì‹¤ì œ ë Œë”ë§ =====
        if (groupKeys.length === 0) {
          objectData.forEach((obj) => {
            const row = createObjectRow(obj, rowCounter++);
            tbody.appendChild(row);
          });
        } else {
          const grouped = groupObjectsByKeysLocal(objectData, groupKeys);
          renderGroup(tbody, grouped, 0);
        }

        // ì „ì²´ì„ íƒ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
        const selectAllBox = document.getElementById("selectAllCheckbox");
        if (selectAllBox) {
          selectAllBox.addEventListener("change", function () {
            const check = this.checked;
            document
              .querySelectorAll("#ifcTablecontainer_ input.object-checkbox")
              .forEach((cb) => {
                cb.checked = check;
                const guid = cb.value;
                if (check) selectedGuids.add(guid);
                else selectedGuids.delete(guid);
              });

            applyTableSelectionStyles();

            // ë·°ì–´ì— ë°˜ì˜
            if (window.ifcViewer && !isSyncingFromViewer) {
              isSyncingFromTable = true;
              window.ifcViewer.setSelection(Array.from(selectedGuids));
              isSyncingFromTable = false;
            }

            handleObjectSelection(); // ê¸°ì¡´ ìƒì„¸í…Œì´ë¸” ê°±ì‹ 
          });
        }

        // ê¸°ì¡´ ì„ íƒ ìƒíƒœ ë°˜ì˜
        applyTableSelectionStyles();

        // í—¤ë” ì²´í¬ë°•ìŠ¤ indeterminate ì²˜ë¦¬
        const allCbs = document.querySelectorAll(
          "#ifcTablecontainer_ input.object-checkbox"
        );
        const selCbs = document.querySelectorAll(
          "#ifcTablecontainer_ input.object-checkbox:checked"
        );
        if (selectAllBox) {
          selectAllBox.checked =
            allCbs.length > 0 && selCbs.length === allCbs.length;
          selectAllBox.indeterminate =
            selCbs.length > 0 && selCbs.length < allCbs.length;
        }
      }

      // ê°ì²´ í–‰ ìƒì„±
      function createObjectRow(obj, index) {
        const row = document.createElement("tr");
        row.className = "object-row";
        row.dataset.idx = index;

        const guid = obj.GlobalId || obj.globalId || obj.GUID || obj.Guid || "";
        row.dataset.guid = guid;
        if (guid) guidToRow.set(guid, row);

        // ì²´í¬ë°•ìŠ¤
        const checkboxCell = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = guid;
        checkbox.className = "object-checkbox";
        checkbox.addEventListener("change", () => {
          // ì²´í¬ë°•ìŠ¤ë§Œ í´ë¦­í•œ ê²½ìš°ì—ë„ selection sync
          const additive = true; // ì²´í¬ëŠ” í•­ìƒ add/remove
          if (checkbox.checked) selectedGuids.add(guid);
          else selectedGuids.delete(guid);

          applyTableSelectionStyles();

          if (window.ifcViewer && !isSyncingFromViewer) {
            isSyncingFromTable = true;
            window.ifcViewer.setSelection(Array.from(selectedGuids));
            isSyncingFromTable = false;
          }
          handleObjectSelection();
        });
        checkboxCell.appendChild(checkbox);
        row.appendChild(checkboxCell);

        // í–‰ í´ë¦­ ì‹œ(ì²´í¬ë°•ìŠ¤ ì™¸) ì„ íƒ ì²˜ë¦¬
        row.addEventListener("click", (e) => {
          if (e.target === checkbox) return;
          if (!guid) return;
          handleTableRowClick(e, guid, row);
        });

        // ë³´ì´ëŠ” í—¤ë”ë“¤ë§Œ ë°ì´í„° ì…€ ìƒì„±
        visibleHeaders.forEach((header) => {
          const cell = document.createElement("td");
          let value = obj[header];

          if (value === undefined && obj.Quantities && obj.Quantities[header]) {
            value = obj.Quantities[header];
          }
          if (value === undefined && obj.Properties && obj.Properties[header]) {
            value = obj.Properties[header];
          }

          if (typeof value === "number") {
            value =
              value % 1 === 0
                ? value.toLocaleString("ko-KR")
                : value.toLocaleString("ko-KR", { maximumFractionDigits: 3 });
          }
          cell.textContent = value ?? "";
          cell.title = value ?? "";
          row.appendChild(cell);
        });

        return row;
      }

      // ê°ì²´ë“¤ì„ í‚¤ë¡œ ê·¸ë£¹í™”
      function groupObjectsByKeys(objects, keys, depth = 0) {
        if (depth >= keys.length) return objects;

        const grouped = {};
        const key = keys[depth];

        objects.forEach((obj) => {
          let value = obj[key];
          if (value === undefined && obj.Quantities)
            value = obj.Quantities[key];
          if (value === undefined && obj.Properties)
            value = obj.Properties[key];
          if (value === undefined) value = "N/A";

          if (!grouped[value]) grouped[value] = [];
          grouped[value].push(obj);
        });

        Object.keys(grouped).forEach((key) => {
          grouped[key] = groupObjectsByKeys(grouped[key], keys, depth + 1);
        });

        return grouped;
      }

      // ê·¸ë£¹í™”ëœ ë°ì´í„° ë Œë”ë§
      function renderGroupedData(
        tbody,
        groupedData,
        depth,
        groupKeys,
        rowCounter
      ) {
        Object.entries(groupedData).forEach(([groupValue, content]) => {
          const groupKey = `${groupKeys[depth]}:${groupValue}`;
          const isCollapsed = collapsedGroups.has(groupKey);
          const symbol = isCollapsed ? "â–¶" : "â–¼";

          const groupRow = document.createElement("tr");
          groupRow.className = "group-header";
          groupRow.style.backgroundColor = "#f0f0f0";
          groupRow.style.fontWeight = "bold";
          groupRow.style.cursor = "pointer";

          const groupCell = document.createElement("td");
          groupCell.colSpan = visibleHeaders.length + 1;
          groupCell.textContent = `${" ".repeat(depth * 2)}${symbol} ${
            groupKeys[depth]
          }: ${groupValue}`;
          groupRow.appendChild(groupCell);

          groupRow.addEventListener("click", () => toggleGroup(groupKey));
          tbody.appendChild(groupRow);

          if (!isCollapsed) {
            if (Array.isArray(content)) {
              content.forEach((obj) => {
                const row = createObjectRow(obj, rowCounter++);
                tbody.appendChild(row);
              });
            } else {
              rowCounter = renderGroupedData(
                tbody,
                content,
                depth + 1,
                groupKeys,
                rowCounter
              );
            }
          }
        });
        return rowCounter;
      }
      // ê·¸ë£¹ í† ê¸€
      function toggleGroup(groupKey) {
        if (collapsedGroups.has(groupKey)) {
          collapsedGroups.delete(groupKey);
        } else {
          collapsedGroups.add(groupKey);
        }
        updateGroupedTable();
      }

      // ê°ì²´ ì„ íƒ ì²˜ë¦¬ ê°œì„ 
      function handleObjectSelection() {
        const selectedCheckboxes = document.querySelectorAll(
          "input.object-checkbox:checked"
        );
        selectedObjectIds = Array.from(selectedCheckboxes).map(
          (cb) => cb.value
        );

        console.log(`ğŸ” ì„ íƒëœ ê°ì²´: ${selectedObjectIds.length}ê°œ`);

        // ì„ íƒëœ í–‰ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        document.querySelectorAll(".object-row").forEach((row) => {
          const checkbox = row.querySelector("input.object-checkbox");
          if (checkbox && checkbox.checked) {
            row.classList.add("selected");
          } else {
            row.classList.remove("selected");
          }
        });

        // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
        const allCheckboxes = document.querySelectorAll(
          "input.object-checkbox"
        );
        const allSelected =
          allCheckboxes.length > 0 &&
          selectedCheckboxes.length === allCheckboxes.length;
        const someSelected = selectedCheckboxes.length > 0;

        const selectAllCheckbox = document.getElementById("selectAllCheckbox");
        if (selectAllCheckbox) {
          selectAllCheckbox.checked = allSelected;
          selectAllCheckbox.indeterminate = someSelected && !allSelected;
        }

        // ìƒì„¸ ì •ë³´ ë¡œë“œ (í•­ìƒ í˜¸ì¶œí•˜ì—¬ ì„ íƒ í•´ì œë„ ì²˜ë¦¬)
        loadObjectDetails();
      }
      // IFC ì €ì¥ (ë‹¤ìš´ë¡œë“œ) ê°œì„  - ìƒˆ íŒŒì¼ ìƒì„± ë°©ì‹
      document
        .getElementById("saveIFCBtn")
        .addEventListener("click", function () {
          if (
            confirm(
              "ê³µì‚¬ì½”ë“œê°€ ë°˜ì˜ëœ ìƒˆë¡œìš´ IFC íŒŒì¼ì„ ìƒì„±í•˜ì—¬ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(íŒŒì¼ ìƒì„±ì— ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)"
            )
          ) {
            const btn = this;
            const originalText = btn.textContent;

            btn.disabled = true;
            btn.innerHTML = `
      <div class="spinner-border spinner-border-sm" role="status"></div>
      ìƒˆ IFC íŒŒì¼ ìƒì„± ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”
    `;

            // ìƒˆë¡œìš´ API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
            const downloadUrl = `/dd_by_ifc/api/download_new_ifc/${PROJECT_ID}/`;

            // fetchë¡œ ë‹¤ìš´ë¡œë“œ ìƒíƒœ í™•ì¸
            fetch(downloadUrl)
              .then((response) => {
                if (!response.ok) {
                  return response.json().then((data) => {
                    throw new Error(data.error || "íŒŒì¼ ìƒì„± ì‹¤íŒ¨");
                  });
                }

                // ì„±ê³µì ìœ¼ë¡œ ë°›ìœ¼ë©´ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                return response.blob();
              })
              .then((blob) => {
                // Blobì„ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `${PROJECT_ID}_with_costcodes.ifc`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                // ì„±ê³µ ë©”ì‹œì§€
                alert(
                  "âœ… ê³µì‚¬ì½”ë“œê°€ ë°˜ì˜ëœ ìƒˆë¡œìš´ IFC íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!"
                );
              })
              .catch((error) => {
                console.error("âŒ IFC íŒŒì¼ ìƒì„± ì‹¤íŒ¨:", error);
                alert(`âŒ IFC íŒŒì¼ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
              })
              .finally(() => {
                // ë²„íŠ¼ ë³µì›
                btn.disabled = false;
                btn.innerHTML = originalText;
              });
          }
        });

      // ì „ì²´ ì„ íƒ í† ê¸€
      function toggleSelectAll() {
        const selectAll = document.getElementById("selectAllCheckbox").checked;
        const checkboxes = document.querySelectorAll("input.object-checkbox");

        checkboxes.forEach((checkbox) => {
          checkbox.checked = selectAll;
        });

        handleObjectSelection();
        applyTableSelectionStyles();
      }

      // loadObjectDetails í•¨ìˆ˜ë§Œ ì•„ë˜ì²˜ëŸ¼ ìˆ˜ì •!
      function loadObjectDetails() {
        if (selectedObjectIds.length === 0) {
          clearObjectDetails();
          return;
        }

        const formData = new FormData();
        formData.append("project_id", PROJECT_ID); // <== ë°˜ë“œì‹œ ì¶”ê°€!
        selectedObjectIds.forEach((id) => formData.append("object_ids[]", id));

        fetch("/dd_by_ifc/api/object_details/", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            updateDetailTable(data.details);
            document.getElementById("totalLabel").textContent =
              "ì´ ê¸ˆì•¡: " + data.total_amount.toLocaleString("ko-KR") + " ì›";
            console.log(
              `âœ… ê°ì²´ ìƒì„¸ ì •ë³´ ë¡œë“œ ì™„ë£Œ: ${data.details.length}ê°œ ì½”ë“œ`
            );
          })
          .catch((error) => {
            console.error("âŒ ê°ì²´ ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:", error);
            alert("ê°ì²´ ìƒì„¸ ì •ë³´ë¥¼ ë¡œë“œí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
            clearObjectDetails();
          });
      }

      // ìƒì„¸ í…Œì´ë¸” ì—…ë°ì´íŠ¸
      function updateDetailTable(details) {
        const tbody = document.querySelector("#codeDetailTable tbody");
        tbody.innerHTML = "";

        details.forEach((d) => {
          const row = document.createElement("tr");
          row.innerHTML = `
      <td>${d.code}</td>
      <td>${d.name}</td>
      <td>${d.specification}</td>
      <td>${d.unit}</td>
      <td>${d.formula}</td>
      <td>${formatNumber(d.quantity)}</td>

      <!-- ë‹¨ê°€Â·ê¸ˆì•¡ì€ í•„ìš” ì‹œ í¬í•¨ -->
      <td>${formatNumber(d.material_unit_price)}</td>
      <td>${formatNumber(d.material_amount)}</td>
      <td>${formatNumber(d.labor_unit_price)}</td>
      <td>${formatNumber(d.labor_amount)}</td>
      <td>${formatNumber(d.expense_unit_price)}</td>
      <td>${formatNumber(d.expense_amount)}</td>
      <td>${formatNumber(d.total_unit_price)}</td>
      <td>${formatNumber(d.total_amount)}</td>
    `;
          tbody.appendChild(row);
        });
      }

      // ìƒì„¸ ì •ë³´ í´ë¦¬ì–´
      function clearObjectDetails() {
        document.querySelector("#codeDetailTable tbody").innerHTML = "";
        document.getElementById("totalLabel").textContent = "ì´ ê¸ˆì•¡: 0 ì›";
      }

      function addCostCodeToObjects() {
        if (!selectedCode || selectedObjectIds.length === 0) {
          alert("ê³µì‚¬ì½”ë“œì™€ ê°ì²´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        const addBtn = document.getElementById("addCodeBtn");
        const originalText = addBtn.textContent;
        addBtn.disabled = true;
        addBtn.textContent = "ì¶”ê°€ ì¤‘...";

        const formData = new FormData();
        selectedObjectIds.forEach((id) => formData.append("object_ids[]", id));
        formData.append("cost_code", selectedCode);
        formData.append("project_id", PROJECT_ID); // â† â˜…â˜…â˜… ë°˜ë“œì‹œ ì¶”ê°€!

        fetch("/dd_by_ifc/api/add_cost_code/", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              alert(
                `âœ… ${data.message}\n\nğŸ’¡ ë³€ê²½ì‚¬í•­ì´ IFC íŒŒì¼ì— ë°˜ì˜ë˜ë ¤ë©´ "ìˆ˜ì •ëœ IFC íŒŒì¼ ë‹¤ìš´ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.`
              );
              loadIFCObjects();
              loadSummaryTable();
              if (selectedObjectIds.length > 0) {
                setTimeout(() => loadObjectDetails(), 500);
              }
            } else {
              throw new Error(data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
            }
          })
          .catch((error) => {
            console.error("âŒ ê³µì‚¬ì½”ë“œ ì¶”ê°€ ì‹¤íŒ¨:", error);
            alert("âŒ ê³µì‚¬ì½”ë“œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
          })
          .finally(() => {
            addBtn.disabled = false;
            addBtn.textContent = originalText;
          });
      }

      function removeCostCodeFromObjects() {
        if (selectedObjectIds.length === 0) {
          alert("ê°ì²´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        const selectedDetailRow = document.querySelector(
          "#codeDetailTable tbody tr.selected"
        );
        if (!selectedDetailRow) {
          alert("ì œê±°í•  ê³µì‚¬ì½”ë“œë¥¼ ìƒì„¸ í…Œì´ë¸”ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }

        const codeToRemove = selectedDetailRow.children[0].textContent;

        if (!confirm(`ê³µì‚¬ì½”ë“œ "${codeToRemove}"ë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          return;
        }

        const removeBtn = document.getElementById("removeCodeBtn");
        const originalText = removeBtn.textContent;
        removeBtn.disabled = true;
        removeBtn.textContent = "ì œê±° ì¤‘...";

        const formData = new FormData();
        formData.append("project_id", PROJECT_ID); // â† ë°˜ë“œì‹œ ì¶”ê°€!
        selectedObjectIds.forEach((id) => formData.append("object_ids[]", id));
        formData.append("cost_code", codeToRemove); // â† selectedCode â†’ codeToRemoveë¡œ ë³€ê²½

        // ì´ ë¶€ë¶„ì´ ì¤‘ìš”! 'add_cost_code' â†’ 'remove_cost_code'ë¡œ ë³€ê²½
        fetch("/dd_by_ifc/api/remove_cost_code/", {
          method: "POST",
          body: formData,
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              alert(
                `âœ… ${data.message}\n\nğŸ’¡ ë³€ê²½ì‚¬í•­ì´ IFC íŒŒì¼ì— ë°˜ì˜ë˜ë ¤ë©´ "ìˆ˜ì •ëœ IFC íŒŒì¼ ë‹¤ìš´ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.`
              );
              console.log(
                `âœ… ê³µì‚¬ì½”ë“œ ì œê±° ì„±ê³µ: ${data.updated_objects}ê°œ ê°ì²´`
              );

              // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
              loadIFCObjects();
              loadSummaryTable();

              if (selectedObjectIds.length > 0) {
                setTimeout(() => loadObjectDetails(), 500);
              }
            } else {
              throw new Error(data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
            }
          })
          .catch((error) => {
            console.error("âŒ ê³µì‚¬ì½”ë“œ ì œê±° ì‹¤íŒ¨:", error);
            alert("âŒ ê³µì‚¬ì½”ë“œ ì œê±° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
          })
          .finally(() => {
            removeBtn.disabled = false;
            removeBtn.textContent = originalText;
          });
      }

      // ìƒì„¸ í…Œì´ë¸” í–‰ ì„ íƒ (delegation)
      document.addEventListener("click", function (e) {
        if (e.target.closest("#codeDetailTable tbody tr")) {
          document
            .querySelectorAll("#codeDetailTable tbody tr")
            .forEach((row) => row.classList.remove("selected"));
          e.target.closest("tr").classList.add("selected");
        }
      });

      // ì½”ë“œ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ (API ê²½ë¡œ ìˆ˜ì •)
      // ì½”ë“œ CSV ì—…ë¡œë“œ (í´ë¼ì´ì–¸íŠ¸ ë¨¼ì € ë°˜ì˜ â†’ ì„œë²„ ì—…ë¡œë“œ)
      function handleCostCodeFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // 1) ë¸Œë¼ìš°ì € ë©”ëª¨ë¦¬(codeData)ì— ë¨¼ì € ë°˜ì˜
        const reader = new FileReader();
        reader.onload = (e) => {
          parseCostCodesFromCSV(e.target.result); // codeData ê°±ì‹ 
          loadSummaryTable();
          renderSummaryFieldSelector();
          showNotification("CSVê°€ ë¡œì»¬ì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        };
        reader.readAsText(file, "utf-8");

        // 2) ì„œë²„ì—ë„ ì—…ë¡œë“œ (ê¸°ì¡´ API)
        const formData = new FormData();
        formData.append("csv_file", file);

        fetch("/dd_by_ifc/api/load_cost_codes/", {
          method: "POST",
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log(`âœ… ì„œë²„ ì—…ë¡œë“œ ì„±ê³µ: ${data.total_codes}ê°œ ì½”ë“œ`);
              showNotification("ì„œë²„ì—ë„ CSVê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.", "info");
            } else {
              throw new Error(data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
            }
          })
          .catch((error) => {
            console.error("âŒ ì½”ë“œ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:", error);
            showNotification(`íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, "error");
          });
      }

      // ìˆ«ì ì½¤ë§ˆ/ì†Œìˆ˜ì  í¬ë§· ìœ í‹¸
      function formatNumber(val) {
        if (val === undefined || val === null || val === "") return "";
        const num = Number(val);
        if (isNaN(num)) return val;
        if (Math.abs(num) < 1 && num !== 0) {
          return num.toLocaleString("ko-KR", { maximumFractionDigits: 4 });
        }
        return num.toLocaleString("ko-KR", { maximumFractionDigits: 2 });
      }
      // === NEW: ì‚°ì‹ â†’ ìˆ˜ëŸ‰ ê³„ì‚° ìœ í‹¸ ===
      function evalQuantityFromFormula(formula, itemObj) {
        // formulaê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ê°’(ë˜ëŠ” 1) ë°˜í™˜
        if (!formula || !formula.trim()) {
          const base = parseFloat(itemObj["ìˆ˜ëŸ‰"] || itemObj.Quantity || 1);
          return isNaN(base) ? 1 : base;
        }

        // itemObjì˜ ëª¨ë“  ìˆ«ìí˜• ê°’ì„ ì†Œë¬¸ì keyë¡œ ë§¤í•‘
        const valueMap = {};
        const toNum = (v) => {
          const n = parseFloat(v);
          return isNaN(n) ? 0 : n;
        };
        Object.keys(itemObj).forEach((k) => {
          valueMap[k.toLowerCase()] = toNum(itemObj[k]);
        });

        // í† í°(ë³€ìˆ˜ëª…)ë§Œ ì•ˆì „í•˜ê²Œ ìˆ«ìë¡œ ì¹˜í™˜
        const expr = formula.replace(/\b[a-zA-Z_][\w]*\b/g, (name) => {
          const v = valueMap[name.toLowerCase()];
          return v === undefined ? "0" : String(v);
        });

        try {
          const result = Function('"use strict";return (' + expr + ");")();
          return Number.isFinite(result) ? result : 0;
        } catch (e) {
          console.warn("ìˆ˜ëŸ‰ ê³„ì‚° ì˜¤ë¥˜:", formula, e);
          return 0;
        }
      }

      // IFC ì €ì¥ (ë‹¤ìš´ë¡œë“œ) (ìˆ˜ì •ëœ API ê²½ë¡œ)
      document
        .getElementById("saveIFCBtn")
        .addEventListener("click", function () {
          if (confirm("ìˆ˜ì •ëœ IFC íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            window.location.href = `/dd_by_ifc/api/download_ifc/${PROJECT_ID}/`;
          }
        });
    </script>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  WASM ê¸°ë°˜ IFC Viewer  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";

      /* ===================== ìœ í‹¸: í˜¹ì‹œ ë‚¨ì€ êµ¬í˜• ìŠ¤í”¼ë„ˆ ì œê±° ===================== */
      function hideLegacySpinners() {
        document
          .querySelectorAll("#viewer-loading")
          .forEach((el) => el.remove());
      }

      /* ===================== IFCViewer3D í´ë˜ìŠ¤ (ê¸°ì¤€ì½”ë“œ ì™„ì „ ì´ì‹) ===================== */
      class IFCViewer3D {
        constructor(containerId) {
          this.container = document.getElementById(containerId);
          this.loadingElement = null;
          this.scene = null;
          this.camera = null;
          this.renderer = null;
          this.controls = null;
          this.modelGroup = null;
          this.guidToObject = new Map();
          this.selectionMap = new Map();
          this.selectedGuids = new Set();
          this.onSelectionChange = null;

          this.raycaster = new THREE.Raycaster();
          this.mouse = new THREE.Vector2();
          this.isDragging = false;

          this.highlightMaterial = new THREE.MeshLambertMaterial({
            color: 0xff6b35,
            transparent: true,
            opacity: 0.9,
            side: THREE.DoubleSide,
          });

          this.init();
        }

        init() {
          this.scene = new THREE.Scene();
          this.scene.background = new THREE.Color(0xf5f5f5);

          const aspect =
            this.container.clientWidth / this.container.clientHeight;
          this.camera = new THREE.PerspectiveCamera(50, aspect, 0.1, 5000);
          this.camera.position.set(30, 25, 30);

          this.renderer = new THREE.WebGLRenderer({
            antialias: true,
            alpha: false,
            powerPreference: "high-performance",
          });
          this.renderer.setSize(
            this.container.clientWidth,
            this.container.clientHeight
          );
          this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
          this.renderer.shadowMap.enabled = true;
          this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
          this.renderer.outputColorSpace = THREE.SRGBColorSpace;
          this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
          this.renderer.toneMappingExposure = 1.0;
          this.container.appendChild(this.renderer.domElement);

          this.modelGroup = new THREE.Group();
          // ğŸ”§ IFC(Z-up) â†’ three.js(Y-up) ë³´ì •
          this.modelGroup.rotation.set(-Math.PI / 2, 0, 0);
          this.modelGroup.updateMatrixWorld(true);
          this.scene.add(this.modelGroup);

          this.setupLighting();
          this.setupControls();
          this.setupEventListeners();

          this.animate();
        }

        setupLighting() {
          const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
          this.scene.add(ambientLight);

          const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
          directionalLight.position.set(50, 50, 25);
          directionalLight.castShadow = true;
          directionalLight.shadow.mapSize.width = 2048;
          directionalLight.shadow.mapSize.height = 2048;
          directionalLight.shadow.camera.near = 0.5;
          directionalLight.shadow.camera.far = 200;
          directionalLight.shadow.camera.left = -50;
          directionalLight.shadow.camera.right = 50;
          directionalLight.shadow.camera.top = 50;
          directionalLight.shadow.camera.bottom = -50;
          this.scene.add(directionalLight);

          const fillLight = new THREE.DirectionalLight(0xffffff, 0.4);
          fillLight.position.set(-25, 20, -25);
          this.scene.add(fillLight);

          const rimLight = new THREE.DirectionalLight(0xffffff, 0.3);
          rimLight.position.set(0, 10, -50);
          this.scene.add(rimLight);
        }

        setupControls() {
          this.controls = new OrbitControls(
            this.camera,
            this.renderer.domElement
          );
          this.controls.enableDamping = true;
          this.controls.dampingFactor = 0.08;
          this.controls.screenSpacePanning = false;

          // Disable default zoom, we implement custom wheel zoom
          this.controls.enableZoom = false;
          this.controls.minDistance = 5;
          this.controls.maxDistance = 500;

          this.controls.enableRotate = true;
          this.controls.rotateSpeed = 0.6;
          this.controls.minPolarAngle = 0.1;
          this.controls.maxPolarAngle = Math.PI - 0.1;

          this.controls.enablePan = true;
          this.controls.panSpeed = 0.8;
          this.controls.keyPanSpeed = 15.0;

          this.controls.mouseButtons = {
            LEFT: THREE.MOUSE.ROTATE,
            MIDDLE: THREE.MOUSE.DOLLY,
            RIGHT: THREE.MOUSE.PAN,
          };
          this.controls.touches = {
            ONE: THREE.TOUCH.ROTATE,
            TWO: THREE.TOUCH.DOLLY_PAN,
          };
          this.controls.autoRotate = false;
          this.controls.autoRotateSpeed = 1.0;
        }

        setupEventListeners() {
          window.addEventListener("resize", () => this.handleResize());
          this.container.addEventListener("contextmenu", (e) =>
            e.preventDefault()
          );
          this.renderer.domElement.addEventListener("click", () => {
            this.renderer.domElement.focus();
          });
          this.renderer.domElement.tabIndex = 0;

          this.renderer.domElement.addEventListener("mousedown", (e) =>
            this.onMouseDown(e)
          );
          this.renderer.domElement.addEventListener("mousemove", (e) =>
            this.onMouseMove(e)
          );
          this.renderer.domElement.addEventListener("mouseup", (e) =>
            this.onMouseUp(e)
          );
          this.renderer.domElement.addEventListener("click", (e) =>
            this.onMouseClick(e)
          );
          this.renderer.domElement.addEventListener("wheel", (e) =>
            this.onMouseWheel(e)
          );

          window.addEventListener("keydown", (event) => {
            if (event.code === "Escape") this.clearSelection();
          });
        }

        handleResize() {
          const width = this.container.clientWidth;
          const height = this.container.clientHeight;
          this.camera.aspect = width / height;
          this.camera.updateProjectionMatrix();
          this.renderer.setSize(width, height);
          this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        }

        animate() {
          requestAnimationFrame(() => this.animate());
          if (this.controls) this.controls.update();
          if (this.renderer && this.scene && this.camera) {
            this.renderer.render(this.scene, this.camera);
          }
        }

        updateMousePosition(event) {
          const rect = this.renderer.domElement.getBoundingClientRect();
          this.mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
          this.mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        }

        onMouseWheel(event) {
          event.preventDefault();
          const zoomScale = event.deltaY > 0 ? 1.1 : 0.9;
          this.updateMousePosition(event);
          this.raycaster.setFromCamera(this.mouse, this.camera);
          const intersects = this.raycaster.intersectObjects(
            this.modelGroup.children,
            true
          );
          const pivot =
            intersects.length > 0
              ? intersects[0].point.clone()
              : this.controls.target.clone();

          const camToPivot = new THREE.Vector3().subVectors(
            this.camera.position,
            pivot
          );
          camToPivot.multiplyScalar(zoomScale);
          const newCamPos = new THREE.Vector3().addVectors(pivot, camToPivot);

          const distToTarget = newCamPos.distanceTo(this.controls.target);
          const clampedDist = THREE.MathUtils.clamp(
            distToTarget,
            this.controls.minDistance,
            this.controls.maxDistance
          );
          if (distToTarget !== clampedDist) {
            const dir = new THREE.Vector3()
              .subVectors(newCamPos, this.controls.target)
              .normalize();
            newCamPos
              .copy(this.controls.target)
              .add(dir.multiplyScalar(clampedDist));
          }

          this.camera.position.copy(newCamPos);
          this.controls.update();
        }

        onMouseDown(event) {
          this.isDragging = false;
          this.updateMousePosition(event);
        }
        onMouseMove(event) {
          if (event.buttons > 0) this.isDragging = true;
          this.updateMousePosition(event);
        }
        onMouseUp() {
          if (this.isDragging) {
            this.isDragging = false;
            return;
          }
        }

        onMouseClick(event) {
          if (this.isDragging || event.button !== 0) return;

          this.updateMousePosition(event);
          this.raycaster.setFromCamera(this.mouse, this.camera);

          const hits = this.raycaster.intersectObjects(
            this.modelGroup.children,
            true
          );
          const hit = hits.find((h) => h.object.type !== "LineSegments");
          const additive = event.ctrlKey || event.metaKey || event.shiftKey;

          if (!hit) {
            if (!additive) this.clearSelection();
            return;
          }

          let targetGroup = hit.object;
          while (targetGroup.parent && targetGroup.parent !== this.modelGroup) {
            targetGroup = targetGroup.parent;
          }

          const guid =
            targetGroup?.userData?.ifcGuid ||
            targetGroup?.userData?.GlobalId ||
            targetGroup?.userData?.globalId;

          if (!guid) return;
          this._updateSelectionFromClick(guid, additive);
        }

        _updateSelectionFromClick(guid, additive) {
          let newSet = new Set(this.selectedGuids);
          if (additive) {
            if (newSet.has(guid)) newSet.delete(guid);
            else newSet.add(guid);
          } else {
            newSet = new Set([guid]);
          }
          this.setSelection(Array.from(newSet));
        }

        setSelection(guidsArray) {
          const newSet = new Set(guidsArray);

          // unhighlight removed
          this.selectedGuids.forEach((g) => {
            if (!newSet.has(g)) this._unhighlightByGuid(g);
          });

          // highlight added
          newSet.forEach((g) => {
            if (!this.selectedGuids.has(g)) this._highlightByGuid(g);
          });

          this.selectedGuids = newSet;

          if (typeof this.onSelectionChange === "function") {
            this.onSelectionChange(Array.from(this.selectedGuids));
          }
        }

        _highlightByGuid(guid) {
          const obj = this.guidToObject.get(guid);
          if (!obj) return;

          let mesh = obj;
          if (obj.type === "Group" && obj.children.length > 0)
            mesh = obj.children[0];

          const originalMaterial = mesh.material;
          mesh.material = this.highlightMaterial;

          this.selectionMap.set(guid, {
            object: obj,
            material: originalMaterial,
          });
        }

        _unhighlightByGuid(guid) {
          const entry = this.selectionMap.get(guid);
          if (!entry) return;
          let mesh = entry.object;
          if (mesh.type === "Group" && mesh.children.length > 0)
            mesh = mesh.children[0];
          mesh.material = entry.material;
          this.selectionMap.delete(guid);
        }

        clearSelection() {
          this.setSelection([]);
        }

        showLoading(show, message = "ëª¨ë¸ ë¡œë”©ì¤‘...") {
          if (show) {
            if (!this.loadingElement) {
              this.loadingElement = document.createElement("div");
              this.loadingElement.id = "ifc-viewer-loading";
              this.loadingElement.style.cssText = `
            position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
            z-index:1000;text-align:center;background:rgba(255,255,255,0.9);
            padding:20px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,0.1);`;
              this.loadingElement.innerHTML = `
            <div style="width:40px;height:40px;border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px;"></div>
            <div style="color:#495057;font-weight:600;" id="loading-text">${message}</div>
            <style>@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}</style>`;
              this.container.appendChild(this.loadingElement);
            } else {
              this.loadingElement.querySelector("#loading-text").textContent =
                message;
              this.loadingElement.style.display = "block";
            }
          } else if (this.loadingElement) {
            this.loadingElement.style.display = "none";
            hideLegacySpinners();
          }
        }

        addModelWithEdges(geometry, originalMaterial, userData) {
          const gray = new THREE.Color(0.502, 0.502, 0.502);
          let finalMat;
          if (
            originalMaterial &&
            originalMaterial.color &&
            !originalMaterial.color.equals(new THREE.Color(1, 1, 1)) &&
            !originalMaterial.color.equals(new THREE.Color(0, 0, 0))
          ) {
            finalMat = originalMaterial.clone();
          } else {
            finalMat = new THREE.MeshLambertMaterial({
              color: gray,
              side: THREE.DoubleSide,
              transparent: originalMaterial
                ? originalMaterial.transparent
                : false,
              opacity: originalMaterial ? originalMaterial.opacity : 1.0,
            });
          }

          const mesh = new THREE.Mesh(geometry, finalMat);
          mesh.userData = userData;
          mesh.castShadow = true;
          mesh.receiveShadow = true;

          const edges = new THREE.EdgesGeometry(geometry);
          const edgeMat = new THREE.LineBasicMaterial({
            color: 0x000000,
            transparent: true,
            opacity: 0.4,
            linewidth: 1,
          });
          const wire = new THREE.LineSegments(edges, edgeMat);
          wire.userData = userData;

          const group = new THREE.Group();
          group.add(mesh);
          group.add(wire);
          group.userData = userData;
          return group;
        }

        addModel(object) {
          this.modelGroup.add(object);
          const guid =
            object?.userData?.ifcGuid ||
            object?.userData?.GlobalId ||
            object?.userData?.globalId ||
            null;
          if (guid) this.guidToObject.set(guid, object);
        }

        clearModels() {
          this.clearSelection();
          if (this.modelGroup) {
            while (this.modelGroup.children.length > 0) {
              const child = this.modelGroup.children[0];
              if (child.geometry) child.geometry.dispose();
              if (child.material) {
                if (Array.isArray(child.material))
                  child.material.forEach((m) => m.dispose());
                else child.material.dispose();
              }
              this.modelGroup.remove(child);
            }
          }
        }

        fitCameraToModel() {
          if (!this.modelGroup || this.modelGroup.children.length === 0) {
            this.camera.position.set(30, 25, 30);
            this.camera.lookAt(0, 0, 0);
            this.controls.target.set(0, 0, 0);
            this.controls.update();
            return;
          }

          const box = new THREE.Box3().setFromObject(this.modelGroup);
          const center = box.getCenter(new THREE.Vector3());
          const size = box.getSize(new THREE.Vector3());
          const maxDim = Math.max(size.x, size.y, size.z);
          const fov = this.camera.fov * (Math.PI / 180);
          const distance = Math.abs(maxDim / (2 * Math.tan(fov / 2)));
          const finalDistance = distance * 1.5;

          const phi = Math.PI / 6;
          const theta = Math.PI / 4;
          const x = center.x + finalDistance * Math.sin(phi) * Math.cos(theta);
          const y = center.y + finalDistance * Math.cos(phi);
          const z = center.z + finalDistance * Math.sin(phi) * Math.sin(theta);

          this.camera.position.set(x, y, z);
          this.camera.lookAt(center);

          this.controls.target.copy(center);
          this.controls.minDistance = finalDistance * 0.1;
          this.controls.maxDistance = finalDistance * 5;
          this.controls.update();
        }

        resetView() {
          this.fitCameraToModel();
        }
        toggleAutoRotate() {
          this.controls.autoRotate = !this.controls.autoRotate;
          return this.controls.autoRotate;
        }
        toggleWireframe() {
          this.modelGroup.traverse((child) => {
            if (
              child.type === "Mesh" &&
              child.material &&
              child.material.wireframe !== undefined
            ) {
              child.material.wireframe = !child.material.wireframe;
            }
          });
        }
      }

      /* ===================== ë·°ì–´ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ===================== */
      const viewer = new IFCViewer3D("viewer");
      window.ifcViewer = viewer;

      // ë·°ì–´ -> í…Œì´ë¸” ë™ê¸°í™”
      viewer.onSelectionChange = (guids) => {
        if (window.isSyncingFromTable) return;
        window.isSyncingFromViewer = true;
        window.selectRowsByGuids(guids);
        window.isSyncingFromViewer = false;
      };

      // IFC ë¡œë”© (Pyodide + IfcOpenShell)
      const IFC_URL = "{{ ifc_abs_url }}";
      const WHEEL_URL =
        "{% static 'wasm/IfcOpenShell-0.7.0-py3-none-any.whl' %}";

      function showLoadingStatus(msg) {
        viewer.showLoading(true, msg);
      }

      (async () => {
        hideLegacySpinners();
        try {
          showLoadingStatus("Pyodide ì´ˆê¸°í™” ì¤‘...");
          const pyodide = await loadPyodide();
          await pyodide.loadPackage("micropip");
          const micropip = pyodide.pyimport("micropip");

          showLoadingStatus("IfcOpenShell ì„¤ì¹˜ ì¤‘...");
          await micropip.install(WHEEL_URL);

          showLoadingStatus("IFC íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì¤‘...");
          const ifcText = await (await fetch(IFC_URL)).text();

          showLoadingStatus("IFC íŒŒì‹± ì¤‘...");
          const ifcopenshell = pyodide.pyimport("ifcopenshell");
          const ifc = ifcopenshell.file.from_string(ifcText);
          const ifcopenshell_geom = pyodide.pyimport("ifcopenshell.geom");

          const settings = ifcopenshell_geom.settings();
          settings.set(settings.WELD_VERTICES, false);

          const iterator = ifcopenshell_geom.iterator(settings, ifc);

          if (iterator.initialize()) {
            showLoadingStatus("3D ì§€ì˜¤ë©”íŠ¸ë¦¬ ìƒì„± ì¤‘...");
            let geometries = [];
            let lastMeshId = null;
            let processed = 0;

            while (true) {
              const obj = iterator.get();
              const elementType = ifc.by_id(obj.id).is_a();

              if (
                elementType !== "IfcOpeningElement" &&
                elementType !== "IfcSpace"
              ) {
                if (lastMeshId !== obj.geometry.id) {
                  geometries = [];

                  const mats = obj.geometry.materials.toJs().map((mat) => {
                    const diffuse = mat.diffuse.toJs();
                    let hasValidColor = false;
                    if (diffuse.length === 3) {
                      const [r, g, b] = diffuse;
                      hasValidColor = !(
                        (r === 1 && g === 1 && b === 1) ||
                        (r === 0 && g === 0 && b === 0)
                      );
                    }
                    return new THREE.MeshLambertMaterial({
                      color: hasValidColor
                        ? new THREE.Color(...diffuse)
                        : new THREE.Color(0.502, 0.502, 0.502),
                      opacity: 1.0 - mat.transparency,
                      transparent: mat.transparency > 1e-5,
                      side: THREE.DoubleSide,
                    });
                  });

                  const mapping = {};
                  obj.geometry.material_ids.toJs().forEach((mid, idx) => {
                    mapping[mid] = mapping[mid] || [];
                    mapping[mid].push(idx);
                  });

                  const vertices = new Float32Array(obj.geometry.verts.toJs());
                  const normals = new Float32Array(obj.geometry.normals.toJs());
                  const faces = obj.geometry.faces.toJs();

                  let offset = 0;
                  if (mapping[-1]) {
                    mats.unshift(
                      new THREE.MeshLambertMaterial({
                        color: new THREE.Color(0.502, 0.502, 0.502),
                        side: THREE.DoubleSide,
                      })
                    );
                    offset = 1;
                  }

                  mats.forEach((material, mi) => {
                    const idxList = mapping[mi - offset];
                    if (!idxList || idxList.length === 0) return;

                    const geometry = new THREE.BufferGeometry();
                    const indices = [];
                    idxList.forEach((i) => {
                      indices.push(
                        faces[3 * i],
                        faces[3 * i + 1],
                        faces[3 * i + 2]
                      );
                    });
                    geometry.setIndex(indices);
                    geometry.setAttribute(
                      "position",
                      new THREE.BufferAttribute(vertices, 3)
                    );
                    geometry.setAttribute(
                      "normal",
                      new THREE.BufferAttribute(normals, 3)
                    );
                    geometry.computeBoundingSphere();

                    geometries.push([geometry, material]);
                  });

                  lastMeshId = obj.geometry.id;
                }

                geometries.forEach(([geometry, material]) => {
                  const userData = {
                    ifcId: obj.id,
                    ifcType: obj.type,
                    ifcGuid: obj.guid || null,
                    GlobalId: obj.guid || null,
                    elementType,
                  };

                  const meshGroup = viewer.addModelWithEdges(
                    geometry,
                    material,
                    userData
                  );

                  const tm = obj.transformation.matrix.data.toJs();
                  const matrix = new THREE.Matrix4()
                    .set(
                      tm[0],
                      tm[1],
                      tm[2],
                      0,
                      tm[3],
                      tm[4],
                      tm[5],
                      0,
                      tm[6],
                      tm[7],
                      tm[8],
                      0,
                      tm[9],
                      tm[10],
                      tm[11],
                      1
                    )
                    .transpose();

                  meshGroup.matrixAutoUpdate = false;
                  meshGroup.matrix.copy(matrix);

                  viewer.addModel(meshGroup);
                });

                processed++;
                if (processed % 50 === 0)
                  showLoadingStatus(`ì²˜ë¦¬ ì¤‘... ${processed}ê°œ`);
              }

              if (!iterator.next()) break;
            }

            showLoadingStatus(`âœ… ëª¨ë¸ ë¡œë”© ì™„ë£Œ! ì´ ${processed}ê°œ ê°ì²´ ì²˜ë¦¬`);

            setTimeout(() => {
              viewer.fitCameraToModel();
              viewer.showLoading(false);
            }, 100);
          } else {
            throw new Error("IFC iterator ì´ˆê¸°í™” ì‹¤íŒ¨");
          }
        } catch (err) {
          console.error("âŒ IFC ë¡œë”© ì‹¤íŒ¨:", err);
          showLoadingStatus("ë¡œë”© ì‹¤íŒ¨ - ê¸°ë³¸ ë°•ìŠ¤ í‘œì‹œ");

          const geometry = new THREE.BoxGeometry(5, 5, 5);
          const material = new THREE.MeshLambertMaterial({
            color: new THREE.Color(0.502, 0.502, 0.502),
            side: THREE.DoubleSide,
          });
          const userData = {
            ifcId: "test",
            ifcType: "Test",
            elementType: "TestBox",
          };
          const test = viewer.addModelWithEdges(geometry, material, userData);
          viewer.addModel(test);
          viewer.fitCameraToModel();
          viewer.showLoading(false);
        } finally {
          hideLegacySpinners();
        }
      })();

      // ë””ë²„ê¹… í—¬í¼
      window.viewerControls = {
        resetView: () => viewer.resetView(),
        toggleAutoRotate: () => viewer.toggleAutoRotate(),
        toggleWireframe: () => viewer.toggleWireframe(),
        clearSelection: () => viewer.clearSelection(),
        getStats: () => ({
          objects: viewer.modelGroup.children.length,
          triangles: viewer.modelGroup.children.reduce((sum, child) => {
            return (
              sum +
              (child.children?.[0]?.geometry
                ? child.children[0].geometry.index.count / 3
                : 0)
            );
          }, 0),
          selected: Array.from(viewer.selectedGuids),
        }),
      };
      console.log("ğŸ® viewerControls.* ì‚¬ìš© ê°€ëŠ¥");

      /* =========================
   PATCH: ë²„íŠ¼ ë°”ì¸ë”©/ì¤‘ë³µ ì œê±°
   ë¶™ì—¬ë„£ê¸° ìœ„ì¹˜: ê²¬ì /ì½”ë“œ UI ìŠ¤í¬ë¦½íŠ¸ ëë¶€ë¶„
========================= */
      (() => {
        /* 1) ì´ì•¡ ì¬ê³„ì‚° ë²„íŠ¼ ë°”ì¸ë”©(ì´ë¯¸ í•¨ìˆ˜ recalculateAllAmounts ì¡´ì¬) */
        const recalcBtn = document.getElementById("recalculateAmountsBtn");
        if (recalcBtn && !recalcBtn.dataset.bound) {
          recalcBtn.dataset.bound = "1";
          recalcBtn.addEventListener("click", recalculateAllAmounts);
        }

        /* 2) saveIFCBtn í•œ ë²ˆë§Œ! (ìƒˆ IFC ìƒì„± & ë‹¤ìš´ë¡œë“œ) */
        const saveBtn = document.getElementById("saveIFCBtn");
        if (saveBtn && !saveBtn.dataset.bound) {
          saveBtn.dataset.bound = "1";
          saveBtn.onclick = async function () {
            if (
              !confirm(
                "ê³µì‚¬ì½”ë“œê°€ ë°˜ì˜ëœ ìƒˆë¡œìš´ IFC íŒŒì¼ì„ ìƒì„±í•˜ì—¬ ë‹¤ìš´ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(íŒŒì¼ ìƒì„±ì— ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)"
              )
            ) {
              return;
            }

            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.innerHTML = `
        <div class="spinner-border spinner-border-sm" role="status" style="width:14px;height:14px;"></div>
        ìƒˆ IFC íŒŒì¼ ìƒì„± ì¤‘...
      `;

            try {
              const downloadUrl = `/dd_by_ifc/api/download_new_ifc/${PROJECT_ID}/`;
              const resp = await fetch(downloadUrl);
              if (!resp.ok) {
                let err;
                try {
                  const j = await resp.json();
                  err = j.error;
                } catch (_) {}
                throw new Error(err || `HTTP ${resp.status}`);
              }

              const blob = await resp.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = `${PROJECT_ID}_with_costcodes.ifc`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              window.URL.revokeObjectURL(url);
              alert("âœ… ê³µì‚¬ì½”ë“œ ë°˜ì˜ IFC íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!");
            } catch (e) {
              console.error(e);
              alert(`âŒ IFC íŒŒì¼ ìƒì„±/ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${e.message}`);
            } finally {
              saveBtn.disabled = false;
              saveBtn.textContent = originalText;
            }
          };
        }
      })();
    </script>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <style>
      .group-header {
        background-color: #e0e0e0 !important;
        font-weight: bold;
        cursor: pointer;
        height: 28px !important;
        font-size: 11px;
      }
      .group-header:hover {
        background-color: #d0d0d0 !important;
      }
      .group-header td {
        height: 28px !important;
        line-height: 28px !important;
      }

      /* â‘  ê³µì‚¬ì½”ë“œ ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ -------------------------------------------------- */
      .search-results {
        min-height: 180px;
        max-height: 180px;
        overflow-y: auto;
      }
      .search-results li {
        padding: 6px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        font-size: 11px;
      }
      .search-results li:hover {
        background-color: #f0f0f0;
      }
      .search-results li.selected {
        background-color: #007bff;
        color: white;
      }

      .column-selector {
        margin-top: 15px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
      }
      .column-selector h4 {
        font-size: 12px;
        margin: 0 0 8px 0;
        color: #333;
      }
      .column-checkboxes {
        max-height: 100px;
        overflow-y: auto;
      }
      .column-checkbox {
        display: flex;
        align-items: center;
        margin-bottom: 3px;
        font-size: 10px;
      }
      .column-checkbox input[type="checkbox"] {
        margin-right: 6px;
        transform: scale(0.8);
      }
      .column-checkbox label {
        cursor: pointer;
        flex: 1;
        font-size: 10px;
      }
      .column-buttons {
        display: flex;
        gap: 5px;
      }
      .btn-small {
        padding: 3px 8px;
        font-size: 10px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      .btn-small:hover {
        background-color: #5a6268;
      }

      input[type="text"],
      select {
        font-size: 11px;
        padding: 4px 6px;
      }
      .group-bar {
        margin-bottom: 10px;
        font-size: 11px;
      }
      .group-bar label {
        margin-right: 10px;
        font-size: 11px;
      }
      .group-bar select {
        margin-right: 15px;
        font-size: 10px;
        padding: 2px 4px;
      }

      .hidden {
        display: none;
      }
      .left-panel {
        width: 30%;
        padding-right: 15px;
      }
      /* â‘£ ìš°ì¸¡ íŒ¨ë„ì„ ì„¸ë¡œ flex ë ˆì´ì•„ì›ƒìœ¼ë¡œ ------------------------------------ */
      .right-panel {
        display: flex; /* ì„¸ë¡œ ìŒ“ê¸° */
        flex-direction: column;
        height: 100%; /* ë¶€ëª¨ ë†’ì´ë§Œí¼ */
      }

      /* â‘¤ IFC í…Œì´ë¸” ì˜ì—­ â€“ ë‚¨ëŠ” ë†’ì´ ì „ë¶€ ì±„ìš°ê¸° ------------------------------- */
      #ifcTablecontainer_ {
        flex: 1 1 auto; /* ë‚¨ëŠ” ê³µê°„ 100% í™•ë³´ */
        min-height: 0; /* flex ìŠ¤í¬ë¡¤ ì •ìƒ ì‘ë™ìš© */
        overflow-y: auto; /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ì„¸ë¡œ ìŠ¤í¬ë¡¤ */
        max-height: none !important; /* ê¸°ì¡´ inline 400px ì œí•œ í•´ì œ */
      }

      .container_detail {
        display: flex;
        margin: 15px 0;
      }
      .btn {
        margin: 4px;
        padding: 6px 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
      }
      .btn:hover {
        background-color: #0056b3;
      }
      .btn-block {
        width: 100%;
        padding: 10px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }
      .btn-block:hover {
        background-color: #218838;
      }
      /* â”€â”€â”€ ê³µí†µ ë˜í¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      /* â”€â”€â”€ flex ì•ˆì—ì„œë„ 100%ë¡œ í´ì§€ê²Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .table-wrapper {
        flex: 1 1 100%; /* ë‚¨ëŠ” í­ ëª¨ë‘ ì°¨ì§€ */
        width: 100%; /* ë¶€ëª¨ div ê½‰ ì°¨ê¸° */
        overflow-x: auto; /* ë„˜ì¹˜ë©´ ê°€ë¡œ ìŠ¤í¬ë¡¤ */
      }

      /* â”€â”€â”€ AIBIM í†µí•© í…Œì´ë¸” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .aibim-table {
        width: 100%; /* ê¸°ë³¸ì ìœ¼ë¡œ ê½‰ ì°¨ê³                */
        min-width: 1200px; /* ì¹¼ëŸ¼ì´ ë§ì„ ë• ì´ ê¸°ì¤€ìœ¼ë¡œ ë„˜ì¹¨ */
        border-collapse: collapse;
        font-size: 11px;
        background: #fff;
      }
      .aibim-table th,
      .aibim-table td {
        padding: 4px 6px;
        border: 1px solid #ddd;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        height: 24px;
        vertical-align: middle;
        text-align: left;
      }
      .aibim-table th {
        background: #f2f2f2;
        font-weight: bold;
        font-size: 10px;
      }
      .aibim-table tbody tr:nth-child(even) {
        background: #f9f9f9;
      }
      .aibim-table tbody tr:hover {
        background: #e8f4fd;
        cursor: pointer;
      }
      .aibim-table tbody tr.selected {
        background: #007bff !important;
        color: #fff;
      }
      .aibim-table .group-header {
        background: #e0e0e0 !important;
        font-weight: bold;
        cursor: pointer;
      }

      /* â‘¢ ì™¼ìª½ì˜ ì„¸ ê°œì˜ ì•¡ì…˜ ë²„íŠ¼(ì¶”ê°€/ì‚­ì œ/ì—´ê¸°) ------------------------------ */
      /*   â€“ ë¹¨ê°„ìƒ‰ & ë†’ì´ 2â„3 (íŒ¨ë”©ë§Œ ì¤„ì´ë©´ ë¨)                                    */
      #addCodeBtn,
      #removeCodeBtn,
      #loadCodeBtn {
        padding: 4px 10px; /* â† 6 â†’ 4 (ë†’ì´ â‰ˆ 2â„3) */
        background: #dc3545; /* Bootstrap danger red */
        border-color: #dc3545;
      }
      #addCodeBtn:hover,
      #removeCodeBtn:hover,
      #loadCodeBtn:hover {
        background: #c82333; /* ì¡°ê¸ˆ ë” ì§™ì€ ë¹¨ê°„ìƒ‰ */
        border-color: #bd2130;
      }
      /* â‘¥ ìƒì„¸ íŒ¨ë„ ì „ì²´ ë˜í¼ â€“ í˜ì´ì§€ ë‚¨ì€ ë†’ì´ ëª¨ë‘ ì°¨ì§€ */
      html,
      body {
        height: 100%; /* %-height ê³„ì‚°ì„ ìœ„í•´ í•„ìˆ˜ */
      }
      #container_detail_first {
        display: flex;
        flex-direction: column; /* ìœ„ì•„ë˜ë¡œ ìŒ“ê¸° */
        flex: 1 1 auto; /* í—¤ë”Â·ìš”ì•½ ì œì™¸ ì „ë¶€ ì°¨ì§€ */
        min-height: 0; /* flex ìŠ¤í¬ë¡¤ ì •ìƒ ì‘ë™ */
      }

      /* â‘¦ ì¢ŒÂ·ìš° íŒ¨ë„ì´ ë“¤ì–´ìˆëŠ” í–‰ë„ ì„¸ë¡œë¡œ ëŠ˜ì–´ë‚˜ê²Œ */
      #container_detail_first > .container_detail {
        flex: 1 1 auto; /* ë‚¨ì€ ê³µê°„ ì „ë¶€ */
        min-height: 0; /* flex ìŠ¤í¬ë¡¤ ì •ìƒ ì‘ë™ */
      }

      /* â‘§ ì¢ŒÂ·ìš° ê°œë³„ íŒ¨ë„ì—ë„ ë†’ì´ë¥¼ ì „ë‹¬ */
      .left-panel,
      .right-panel {
        height: 100%;
      }
      /* 3D-Table Selection Sync */
      .object-row.selected-row,
      .aibim-table tbody tr.object-row.selected-row {
        background: #ffe8a1 !important;
      }
      /* â”€â”€â”€ Summary expandable rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .summary-expander-btn {
        cursor: pointer;
        border: none;
        background: none;
        font-size: 13px;
        line-height: 1;
        padding: 0;
      }
      .summary-child-row {
        background: #fafafa;
      }
      .summary-child-wrapper {
        padding: 6px 10px 10px 10px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 260px;
        overflow: auto;
      }
      .summary-child-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 10px;
        min-width: 900px;
      }
      .summary-child-table th,
      .summary-child-table td {
        border: 1px solid #ccc;
        padding: 3px 4px;
        white-space: nowrap;
      }
      .summary-child-table tbody tr:hover {
        background: #e8f4fd;
        cursor: pointer;
      }
      .summary-child-table tbody tr.selected-row {
        background: #ffe8a1 !important;
      }
      .expander-col {
        width: 24px;
        text-align: center;
      }

      /* ì ‘ì—ˆë‹¤/í¼ì³¤ë‹¤ ê¸°ëŠ¥ ìŠ¤íƒ€ì¼ */
      .collapsible-section {
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #fff;
      }

      .collapsible-header {
        padding: 10px 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 14px;
        color: #495057;
      }

      .collapsible-header:hover {
        background: #e9ecef;
      }

      .toggle-icon {
        font-family: monospace;
        font-size: 16px;
        font-weight: bold;
        color: #007bff;
      }

      .collapsible-content {
        padding: 15px;
        display: block;
      }

      /* ê³µì‚¬ì½”ë“œ ê·¸ë£¹í•‘ ìŠ¤íƒ€ì¼ */
      .cost-code-group-header {
        background: #f8f9fa !important;
        font-weight: bold;
        border-left: 4px solid #007bff;
      }

      .cost-code-group-header:hover {
        background: #e9ecef !important;
        cursor: pointer;
      }

      .cost-code-group-header.selected-main {
        background: #fff3cd !important;
        border-left-color: #ffc107;
      }

      .cost-code-detail-row {
        background: #fdfdfd;
        border-left: 4px solid #dee2e6;
      }

      .cost-code-detail-row:hover {
        background: #f8f9fa;
      }

      .cost-code-detail-row.selected-main {
        background: #ffe8a1 !important;
        border-left-color: #ffc107;
      }

      .toggle-cell {
        width: 30px !important;
        padding: 2px !important;
        text-align: center;
        vertical-align: middle;
      }

      .cost-code-toggle-btn {
        width: 20px;
        height: 20px;
        border: 1px solid #007bff;
        background: #fff;
        color: #007bff;
        cursor: pointer;
        border-radius: 3px;
        font-size: 12px;
        font-weight: bold;
        line-height: 1;
        padding: 0;
      }

      .cost-code-toggle-btn:hover {
        background: #007bff;
        color: #fff;
      }

      .detail-indent {
        width: 30px !important;
        background: #f8f9fa;
        border-right: 1px solid #dee2e6;
      }

      .group-data-cell {
        font-weight: 500;
      }

      .detail-data-cell {
        font-size: 10px;
        color: #6c757d;
      }

      .cost-code-group-checkbox {
        transform: scale(1.1);
        accent-color: #007bff;
      }

      /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ë“¤... */
      .summary-field-selector {
        margin: 10px 0;
        padding: 10px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
      }

      .field-selector-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .field-selector-header h5 {
        margin: 0;
        font-size: 14px;
        color: #495057;
      }

      .field-selector-buttons {
        display: flex;
        gap: 5px;
      }

      .field-checkboxes-container {
        max-height: 120px;
        overflow-y: auto;
        border: 1px solid #ced4da;
        border-radius: 3px;
        background: white;
        padding: 5px;
      }

      .field-checkboxes {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 2px 10px;
      }

      .field-checkbox {
        display: flex;
        align-items: center;
        padding: 2px;
        font-size: 11px;
      }

      .field-checkbox input {
        margin-right: 6px;
        transform: scale(0.9);
      }

      .field-checkbox label {
        cursor: pointer;
        flex: 1;
      }

      .summary-item-row:hover {
        background: #e8f4fd !important;
        cursor: pointer;
      }

      .summary-item-row.selected-main {
        background: #ffe8a1 !important;
      }

      .summary-item-checkbox {
        margin: 0;
        transform: scale(0.9);
      }

      .adv-group-header {
        background: #ddd !important;
        font-weight: bold;
        cursor: pointer;
      }
    </style>
  </body>
</html>
